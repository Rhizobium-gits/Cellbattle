"use client";
import { storage, cleanupOldEntries } from "@/lib/storage";
import React, { useState, useEffect, useCallback, useRef } from "react";
const T={S:"„Ç∑„Ç∞„Éä„É´",ST:"ÊßãÈÄ†",E:"ÈÖµÁ¥†",R:"ÂèóÂÆπ‰Ωì",TR:"Ëº∏ÈÄÅ",M:"„É¢„Éº„Çø„Éº",CH:"„Ç∑„É£„Éö„É≠„É≥",TF:"Ëª¢ÂÜôÂõ†Â≠ê",IM:"ÂÖçÁñ´",G:"ÊàêÈï∑Âõ†Â≠ê",AP:"„Ç¢„Éù„Éà„Éº„Ç∑„Çπ",V:"Â∞èËÉû",AD:"Êé•ÁùÄ",CY:"Á¥∞ËÉûÂë®Êúü",UB:"„É¶„Éì„Ç≠„ÉÅ„É≥"};
const TC={[T.S]:["#8b9e6b","#f4f5ec","#3d4a2e"],[T.ST]:["#7a9e87","#eef5f0","#2e4a38"],[T.E]:["#1a1a1a","#2a2a2a","#e0d8cc"],[T.R]:["#9e7eab","#f3eef5","#4a2e5a"],[T.TR]:["#6b8e9e","#ecf2f5","#2e3d4a"],[T.M]:["#c49e5e","#f8f2e6","#5a4420"],[T.CH]:["#6b9e8b","#ecf5f0","#2e4a3e"],[T.TF]:["#b87e8e","#f5ecee","#5a2e3e"],[T.IM]:["#7e7eab","#eeeef5","#2e2e5a"],[T.G]:["#b8a65e","#f5f2e6","#5a4e20"],[T.AP]:["#8b7e6b","#f0eeea","#3d3a2e"],[T.V]:["#6b8eab","#ecf0f5","#2e3e5a"],[T.AD]:["#7e8b8b","#eef0f0","#2e3d3d"],[T.CY]:["#8b9e5e","#f0f2e6","#3d4a20"],[T.UB]:["#9e8b7e","#f2f0ee","#4a3d2e"]};
const EN=[{id:"glucose",n:"„Ç∞„É´„Ç≥„Éº„Çπ",c:"#c47e5e"},{id:"atp",n:"ATP",c:"#c49e5e"},{id:"ca2",n:"Ca¬≤‚Å∫",c:"#6b8e9e"},{id:"electrical",n:"ÈõªÊ∞ó‰ø°Âè∑",c:"#8b9e6b"},{id:"gtp",n:"GTP",c:"#9e7eab"}];
const EART={
glucose:(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24"><path d="M12 3 L18 7 L18 15 L12 19 L6 15 L6 7Z" fill="#c47e5e22" stroke="#c47e5e" stroke-width="1.5" stroke-linejoin="round"/><circle cx="12" cy="11" r="3" fill="#c47e5e55"/><circle cx="12" cy="11" r="1.5" fill="#c47e5e"/></svg>`,
atp:(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24"><circle cx="6" cy="12" r="4" fill="#c49e5e33" stroke="#c49e5e" stroke-width="1.2"/><circle cx="12" cy="12" r="4" fill="#c49e5e44" stroke="#c49e5e" stroke-width="1.2"/><circle cx="18" cy="12" r="4" fill="#c49e5e66" stroke="#c49e5e" stroke-width="1.2"/></svg>`,
ca2:(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#6b8e9e15"/><circle cx="12" cy="12" r="6" fill="#6b8e9e30"/><circle cx="12" cy="12" r="3" fill="#6b8e9e"/></svg>`,
electrical:(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24"><path d="M8 4 L14 10 L10 12 L16 20" fill="none" stroke="#8b9e6b" stroke-width="2" stroke-linecap="round"/></svg>`,
gtp:(s=14)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24"><circle cx="7" cy="12" r="3.5" fill="#9e7eab33" stroke="#9e7eab" stroke-width="1.2"/><circle cx="13" cy="12" r="3.5" fill="#9e7eab44" stroke="#9e7eab" stroke-width="1.2"/><circle cx="19" cy="12" r="3.5" fill="#9e7eab66" stroke="#9e7eab" stroke-width="1.2"/></svg>`};
const SHAPE={
gpcr:(c)=>`<rect x="4" y="28" width="56" height="4" fill="${c}15" rx="2"/>${[12,18,24,30,36,42,48].map((x,i)=>`<rect x="${x}" y="${12+((i%2)*8)}" width="3.5" height="${24-((i%2)*8)}" rx="1.8" fill="${c}${40+i*6}" stroke="${c}" stroke-width=".6"/>`).join("")}`,
gprot:(c,sub)=>`<ellipse cx="26" cy="30" rx="14" ry="12" fill="${c}20" stroke="${c}" stroke-width="1.5"/><ellipse cx="42" cy="28" rx="10" ry="9" fill="${c}33" stroke="${c}" stroke-width="1"/><ellipse cx="46" cy="38" rx="5" ry="4" fill="${c}55" stroke="${c}" stroke-width="1"/>${sub?`<text x="26" y="34" text-anchor="middle" font-size="10" font-weight="900" fill="${c}">${sub}</text>`:""}`,
kinase:(c,label)=>`<ellipse cx="24" cy="26" rx="12" ry="11" fill="${c}25" stroke="${c}" stroke-width="1.5"/><ellipse cx="40" cy="34" rx="13" ry="12" fill="${c}30" stroke="${c}" stroke-width="1.5"/><circle cx="33" cy="28" r="2.5" fill="${c}88"/>${label?`<text x="32" y="48" text-anchor="middle" font-size="7" font-weight="700" fill="${c}">${label}</text>`:""}`,
channel:(c)=>`<circle cx="32" cy="32" r="20" fill="${c}15" stroke="${c}" stroke-width="1.5"/>${[0,72,144,216,288].map(a=>{const r=Math.PI*a/180;return`<ellipse cx="${32+14*Math.cos(r)}" cy="${32+14*Math.sin(r)}" rx="6" ry="4" fill="${c}35" stroke="${c}" stroke-width=".8"/>`;}).join("")}<circle cx="32" cy="32" r="5" fill="#faf6f0" stroke="${c}" stroke-width="1.5" stroke-dasharray="2 2"/>`,
filament:(c)=>`<path d="M10 50 Q18 38 22 28 Q26 18 32 14 Q38 10 42 18 Q46 26 50 36 Q54 46 56 50" fill="none" stroke="${c}" stroke-width="3.5" stroke-linecap="round" opacity=".7"/><path d="M8 52 Q16 40 20 30 Q24 20 30 16 Q36 12 40 20 Q44 28 48 38 Q52 48 54 52" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" opacity=".35"/>`,
tubule:(c)=>`<ellipse cx="32" cy="16" rx="18" ry="6" fill="${c}20" stroke="${c}" stroke-width="1.2"/><rect x="14" y="16" width="36" height="28" fill="${c}12" stroke="${c}" stroke-width="1.2"/><ellipse cx="32" cy="44" rx="18" ry="6" fill="${c}25" stroke="${c}" stroke-width="1.2"/>`,
trihelix:(c)=>`${[0,1,2].map(i=>{const ox=i*5-5;return`<path d="M${16+ox} 8 Q${24+ox} 18 ${20+ox} 28 Q${28+ox} 38 ${24+ox} 48 Q${32+ox} 56 ${28+ox} 60" fill="none" stroke="${c}" stroke-width="2.5" stroke-linecap="round" opacity="${.4+i*.2}"/>`;}).join("")}`,
antibody:(c)=>`<path d="M20 14 L20 28 L32 36 L44 28 L44 14" fill="none" stroke="${c}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><line x1="32" y1="36" x2="32" y2="54" stroke="${c}" stroke-width="3.5" stroke-linecap="round"/><circle cx="20" cy="14" r="4" fill="${c}44" stroke="${c}" stroke-width="1.2"/><circle cx="44" cy="14" r="4" fill="${c}44" stroke="${c}" stroke-width="1.2"/>`,
motor:(c)=>`<ellipse cx="22" cy="22" rx="12" ry="10" fill="${c}30" stroke="${c}" stroke-width="1.5"/><path d="M32 26 Q38 34 36 44 L36 54" stroke="${c}" stroke-width="2.5" stroke-linecap="round" fill="none"/><circle cx="22" cy="22" r="4" fill="${c}66"/>`,
walker:(c)=>`<line x1="10" y1="52" x2="54" y2="52" stroke="${c}" stroke-width="3" stroke-linecap="round" opacity=".3"/><circle cx="24" cy="22" r="8" fill="${c}30" stroke="${c}" stroke-width="1.5"/><circle cx="40" cy="22" r="8" fill="${c}30" stroke="${c}" stroke-width="1.5"/><path d="M24 30 L24 44 L18 52" stroke="${c}" stroke-width="2" stroke-linecap="round" fill="none"/><path d="M40 30 L40 44 L46 52" stroke="${c}" stroke-width="2" stroke-linecap="round" fill="none"/>`,
barrel:(c)=>`<path d="M14 44 L14 22 Q14 10 32 10 Q50 10 50 22 L50 44" fill="${c}18" stroke="${c}" stroke-width="1.8"/><ellipse cx="32" cy="44" rx="18" ry="6" fill="${c}25" stroke="${c}" stroke-width="1.5"/>`,
tf:(c,label)=>`<path d="M8 44 Q16 36 24 44 Q32 52 40 44 Q48 36 56 44" fill="none" stroke="${c}55" stroke-width="2" stroke-linecap="round"/><path d="M8 48 Q16 40 24 48 Q32 56 40 48 Q48 40 56 48" fill="none" stroke="${c}33" stroke-width="2" stroke-linecap="round"/><ellipse cx="32" cy="28" rx="12" ry="10" fill="${c}30" stroke="${c}" stroke-width="1.5"/>${label?`<text x="32" y="32" text-anchor="middle" font-size="8" font-weight="900" fill="${c}">${label}</text>`:""}`,
growth:(c)=>`<circle cx="32" cy="32" r="10" fill="${c}30" stroke="${c}" stroke-width="1.5"/><circle cx="32" cy="32" r="5" fill="${c}55"/>`,
apop:(c)=>`<circle cx="32" cy="28" r="14" fill="${c}20" stroke="${c}" stroke-width="1.5"/><line x1="24" y1="22" x2="40" y2="34" stroke="${c}" stroke-width="2.5" stroke-linecap="round"/><line x1="40" y1="22" x2="24" y2="34" stroke="${c}" stroke-width="2.5" stroke-linecap="round"/>`,
vesicle:(c)=>`<circle cx="32" cy="26" r="14" fill="${c}18" stroke="${c}" stroke-width="1.5"/><path d="M20 38 Q26 42 32 38 Q38 34 44 38" fill="none" stroke="${c}" stroke-width="2"/>`,
adhesion:(c)=>`<rect x="8" y="8" width="48" height="4" rx="2" fill="${c}25"/><rect x="8" y="52" width="48" height="4" rx="2" fill="${c}25"/><path d="M20 12 L20 24 Q20 32 32 32 Q44 32 44 24 L44 12" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round"/><circle cx="32" cy="32" r="3" fill="${c}55"/>`,
cycle:(c)=>`<circle cx="32" cy="32" r="18" fill="${c}12" stroke="${c}" stroke-width="1.5"/><path d="M32 14 A18 18 0 0 1 50 32" fill="none" stroke="${c}" stroke-width="3" stroke-linecap="round"/><path d="M50 32 A18 18 0 0 1 32 50" fill="none" stroke="${c}88" stroke-width="3" stroke-linecap="round"/><circle cx="32" cy="32" r="4" fill="${c}"/>`,
ubtag:(c)=>`<path d="M22 18 L42 18 L46 32 L42 46 L22 46 L18 32Z" fill="${c}20" stroke="${c}" stroke-width="1.5"/><text x="32" y="35" text-anchor="middle" font-size="10" font-weight="900" fill="${c}">Ub</text>`,
proteasome:(c)=>`<ellipse cx="32" cy="14" rx="14" ry="5" fill="${c}22" stroke="${c}" stroke-width="1"/><rect x="18" y="14" width="28" height="28" rx="2" fill="${c}15" stroke="${c}" stroke-width="1.5"/><ellipse cx="32" cy="42" rx="14" ry="5" fill="${c}28" stroke="${c}" stroke-width="1"/>`,
glob:(c,label)=>`<circle cx="32" cy="30" r="16" fill="${c}20" stroke="${c}" stroke-width="1.5"/><circle cx="28" cy="26" r="6" fill="${c}15"/><circle cx="38" cy="34" r="5" fill="${c}15"/>${label?`<text x="32" y="50" text-anchor="middle" font-size="7" font-weight="700" fill="${c}">${label}</text>`:""}`};
const CARD_SHAPE={1:"gprot",2:"gprot",3:"gprot",4:"gprot",5:"kinase",6:"kinase",7:"kinase",8:"kinase",9:"kinase",10:"kinase",11:"glob",12:"kinase",13:"kinase",14:"glob",15:"kinase",16:"kinase",17:"glob",18:"kinase",19:"glob",20:"glob",21:"filament",22:"tubule",23:"tubule",24:"filament",25:"filament",26:"filament",27:"filament",28:"filament",29:"trihelix",30:"filament",31:"barrel",32:"glob",33:"glob",34:"glob",35:"glob",36:"apop",37:"apop",38:"glob",39:"glob",40:"glob",41:"gpcr",42:"gpcr",43:"gpcr",44:"gpcr",45:"gpcr",46:"channel",47:"channel",48:"gpcr",49:"gpcr",50:"apop",51:"channel",52:"channel",53:"channel",54:"channel",55:"channel",56:"glob",57:"glob",58:"glob",59:"vesicle",60:"glob",61:"motor",62:"walker",63:"walker",64:"motor",65:"glob",66:"barrel",67:"barrel",68:"barrel",69:"glob",70:"barrel",71:"tf",72:"tf",73:"tf",74:"tf",75:"tf",76:"tf",77:"tf",78:"tf",79:"tf",80:"tf",81:"glob",82:"glob",83:"antibody",84:"antibody",85:"glob",86:"growth",87:"growth",88:"growth",89:"glob",90:"glob",91:"ubtag",92:"glob",93:"glob",94:"proteasome",95:"proteasome",96:"growth",97:"growth",98:"growth",99:"growth",100:"growth",101:"growth",102:"growth",103:"growth",104:"apop",105:"glob",106:"apop",107:"vesicle",108:"vesicle",109:"vesicle",110:"adhesion",111:"adhesion",112:"adhesion",113:"adhesion",114:"adhesion",115:"glob",116:"glob",117:"glob",118:"kinase",119:"cycle",120:"cycle",121:"glob",122:"barrel"};
const CARD_LABEL={1:"Œ±",2:"Œ±i",5:"Ras",6:"Raf",7:"MEK",8:"ERK",9:"PI3K",10:"Akt",11:"mTOR",12:"PKA",14:"CaM",17:"STAT",71:"p53",72:"NF-Œ∫B",73:"HIF",74:"Myc",75:"Oct4",76:"Sox2",77:"CREB",78:"Jun",79:"Fos",80:"YAP"};
function getArt(id,type){const c=TC[type]?.[0]||"#8b7e6b";const shape=CARD_SHAPE[id]||"glob";const label=CARD_LABEL[id];const fn=SHAPE[shape];if(!fn)return SHAPE.glob(c,label);if(["gprot","kinase","tf","glob"].includes(shape))return fn(c,label);return fn(c);}
/* ‚ïê‚ïê‚ïê CARD DATA ‚ïê‚ïê‚ïê
   All attacks cost energy. Cost auto-assigned by type+damage if not specified.
   type===T.E ‚Üí support card (black), can't be active battler
*/
const TYPE_ENERGY={[T.S]:"electrical",[T.ST]:"glucose",[T.E]:"glucose",[T.R]:"electrical",[T.TR]:"glucose",[T.M]:"glucose",[T.CH]:"glucose",[T.TF]:"electrical",[T.IM]:"ca2",[T.G]:"glucose",[T.AP]:"ca2",[T.V]:"electrical",[T.AD]:"ca2",[T.CY]:"electrical",[T.UB]:"ca2"};
function mk(id,nm,en,ty,mw,ds,bw,sk,an,ad,ae){
  const isSupport=ty===T.E;
  /* Auto-assign energy cost if "free" or missing */
  let cost=ae;
  if(!cost||cost==="free"){
    if(isSupport){cost=[];}
    else{
      const eid=TYPE_ENERGY[ty]||"atp";
      const n=ad<=15?1:ad<=30?1:2;
      cost=[{id:eid,n}];
    }
  }
  const hp0=isSupport?0:Math.round(30+Math.min(270,270*((Math.log(mw+1)-Math.log(7))/(Math.log(2501)-Math.log(7)))));
  const score=hp0+ad*3;
  const rarity=isSupport?1:score<100?1:score<160?2:score<220?3:score<280?4:5;
  return{id,name:nm,nameEn:en,type:ty,mw,desc:ds,bw:bw||[],skill:sk,
    an:an||"„Åì„ÅÜ„Åí„Åç",ad:isSupport?0:ad,
    ae:cost,hp:hp0,rarity,isSupport};
}
const CARDS=[
mk(1,"GŒ±s","GNAS",T.S,45,"„Äå„ÇÑ„ÇåÔºÅ„Äç„Å®ÂëΩ‰ª§„Çí‰ºù„Åà„Çã‰ºù‰ª§„ÄÇ‰ª≤Èñì„Å®„ÉÅ„Éº„É†„Åß‰ø°Âè∑„É™„É¨„Éº",[2,3,4],"ÁµêÂêà: „Ç®„Éç+1","cAMP„Ç∑„Ç∞„Éä„É´",25,"free"),
mk(2,"GŒ±i","GNAI",T.S,41,"„Äå„ÇÑ„ÇÅ„ÇçÔºÅ„Äç„Å®Ê≠¢„ÇÅ„Çã„Éñ„É¨„Éº„Ç≠ÂΩπ„ÄÇÁ¥∞ËÉû„ÇíËêΩ„Å°ÁùÄ„Åã„Åõ„Çã",[1,3,4],"ÁµêÂêà: „Çπ„Ç≠„É´Â∞ÅÂç∞","ÊäëÂà∂„Ç∑„Ç∞„Éä„É´",20,"free"),
mk(3,"GŒ≤","GNB1",T.S,37,"Œ±„ÅÆ„Éë„Éº„Éà„Éä„Éº„ÄÇÈõ¢„Çå„ÅüÂæå„ÅØËá™ÂàÜ„Åß„ÇÇ‰ø°Âè∑„ÇíÂá∫„Åõ„Çã",[1,2,4],"ÁµêÂêà: 1Êûö„Éâ„É≠„Éº","Œ≤Œ≥„Ç∑„Ç∞„Éä„É´",15,"free"),
mk(4,"GŒ≥","GNG2",T.S,8,"Œ≤„Å®„Éö„Ç¢„ÅÆÂ∞è„Åï„Å™‰ª≤Èñì„ÄÇËÜú„Å´„Åè„Å£„Å§„ÅÑ„Å¶„ÉÅ„Éº„É†„ÇíÊîØ„Åà„Çã",[1,2,3],"ÁµêÂêà: „Ç≥„Çπ„Éà-1","ËÜú„Ç¢„É≥„Ç´„Éº",10,"free"),
mk(5,"Ras","HRAS",T.S,21,"‰ø°Âè∑„É™„É¨„Éº„ÅÆ„Çπ„Çø„Éº„ÉàÂΩπ„ÄÇRaf„Å´„ÄåËµ∞„ÇåÔºÅ„Äç„Å®„Éê„Éà„É≥„ÇíÊ∏°„Åô",[6,41],"ÁµêÂêà: 2Êûö„Éâ„É≠„Éº","RAS„Çπ„Ç§„ÉÉ„ÉÅ",20,[{id:"gtp",n:1}]),
mk(6,"Raf","RAF1",T.S,73,"Ras„Åã„Çâ„Éê„Éà„É≥„ÇíÂèó„Åë„Å¶MEK„Å´„Å§„Å™„Åê„É™„É¨„Éº„É©„É≥„Éä„Éº",[5,7],"ÁµêÂêà: ÊîªÊíÉ+10","„Ç≠„Éä„Éº„Çº„É™„É¨„Éº",30,[{id:"atp",n:1}]),
mk(7,"MEK1","MAP2K1",T.S,43,"Raf„Åã„ÇâERK„Å∏„Éê„Éà„É≥„Çí„Å§„Å™„Åê‰∏≠Á∂ô„É©„É≥„Éä„Éº",[6,8],"ÁµêÂêà: Áõ∏Êâã5„ÉÄ„É°","„Éá„É•„Ç¢„É´„É™„É≥ÈÖ∏Âåñ",25,[{id:"atp",n:1}]),
mk(8,"ERK2","MAPK1",T.S,42,"„É™„É¨„Éº„ÅÆ„Ç¢„É≥„Ç´„Éº„ÄÇÊ†∏„Å´È£õ„Å≥Ëæº„Çì„Åß„ÄåÂ¢ó„Åà„ÇçÔºÅ„Äç„Å®ÂëΩ‰ª§„Åô„Çã",[7,71],"ÁµêÂêà: Âë≥ÊñπHP+5","Â¢óÊÆñ„Ç∑„Ç∞„Éä„É´",25,[{id:"atp",n:1}]),
mk(9,"PI3K","PIK3CA",T.S,110,"„ÄåÂÆà„Çä„ÇíÂõ∫„ÇÅ„ÇçÔºÅ„Äç„Å®Akt„ÇíÂëº„Å≥Âá∫„ÅôÂè∏‰ª§ÂÆò",[10,41],"ÁµêÂêà: „Ç®„Éç+2","PIP3ÁîüÊàê",40,[{id:"atp",n:2}]),
mk(10,"Akt","AKT1",T.S,56,"PI3K„Å´Âëº„Å∞„Çå„Å¶Á¥∞ËÉû„ÇíÂÆà„ÇãÈ®éÂ£´„ÄÇÁîüÂ≠ò„ÇíÂøúÊè¥„Åô„Çã",[9,11],"ÁµêÂêà: HP15ÂõûÂæ©","„Çµ„Éê„Ç§„Éê„É´",30,[{id:"atp",n:1}]),
mk(11,"mTOR","MTOR",T.S,289,"„Åî„ÅØ„Çì„ÅåË∂≥„Çä„Å¶„Çã„ÅãË¶ã„ÇãÊ†ÑÈ§ä„Çª„É≥„Çµ„Éº„ÄÇË∂≥„Çä„Å¶„Åü„ÇâÊàêÈï∑OKÔºÅ",[10,118],"ÁµêÂêà: „Çπ„Ç≠„É´2ÂÄç","ÊàêÈï∑„Éû„Çπ„Çø„Éº",60,[{id:"atp",n:2}]),
mk(12,"PKA","PRKACA",T.S,40,"„É°„ÉÉ„Çª„Éº„Ç∏„ÅßÁõÆË¶ö„ÇÅ„Çã‰∏áËÉΩ„Ç≠„Éº„ÄÇ„ÅÑ„Çç„Çì„Å™‰ª≤Èñì„ÇíON„Å´„Åô„Çã",[1,77],"ÁµêÂêà: „É©„É≥„ÉÄ„É†„Çπ„Ç≠„É´","„É™„É≥ÈÖ∏Âåñ",22,[{id:"atp",n:1}]),
mk(13,"PKC","PRKCA",T.S,77,"„Ç´„É´„Ç∑„Ç¶„É†„ÅßÁõÆË¶ö„ÇÅ„Çã„Çπ„Ç§„ÉÉ„ÉÅ„ÄÇÂ¢óÊÆñ„ÇÑÂÖçÁñ´„ÇíÂä©„Åë„Çã",[14],"ÁµêÂêà: Áõ∏Êâã1ÊûöÁÑ°Âäπ","PKC„Éê„Éº„Çπ„Éà",35,[{id:"ca2",n:1}]),
mk(14,"„Ç´„É´„É¢„Ç∏„É•„É™„É≥","CALM1",T.S,17,"„Ç´„É´„Ç∑„Ç¶„É†„Çí4„Å§„ÅÆÊâã„Åß„Ç≠„É£„ÉÉ„ÉÅ„Åó„Å¶‰ª≤Èñì„ÇíËµ∑„Åì„Åô„Çª„É≥„Çµ„Éº",[13,15],"ÁµêÂêà: Ca2++1","Ca„Çª„É≥„Çµ„Éº",15,"free"),
mk(15,"CaMKII","CAMK2A",T.S,54,"Ë®òÊÜ∂„Çí„Å§„Åè„Çã„Çπ„Ç§„ÉÉ„ÉÅ„ÄÇ‰∏ÄÂ∫¶ON„Å´„Å™„Çã„Å®Ëá™ÂàÜ„ÅßON„ÇíÁ∂ö„Åë„Çã",[14],"ÁµêÂêà: „Çπ„Ç≠„É´2Âõû","„É°„É¢„É™„Éº„Ç≠„Éä„Éº„Çº",30,[{id:"ca2",n:1}]),
mk(16,"JAK2","JAK2",T.S,131,"Â§ñ„ÅÆ‰ø°Âè∑„ÇíÂèó„ÅëÂèñ„Å£„Å¶STAT„ÇíËµ∑„Åì„ÅôÂèó‰ªò‰øÇ",[17,86,87],"ÁµêÂêà: ÂÖçÁñ´„Ç≥„Çπ„Éà-1","JAK-STAT„Éë„Çπ",45,[{id:"atp",n:1}]),
mk(17,"STAT3","STAT3",T.S,92,"Ëµ∑„Åì„Åï„Çå„Çã„Å®Ê†∏„Å´Ëµ∞„Å£„Å¶ÈÅ∫‰ºùÂ≠ê„ÇíON„Å´„Åô„Çã‰ºù‰ª§",[16],"ÁµêÂêà: 2Êûö„Éâ„É≠„Éº","Ëª¢ÂÜôÊ¥ªÊÄßÂåñ",35,[{id:"atp",n:1}]),
mk(18,"Src","SRC",T.S,60,"„ÅÑ„Çç„Çì„Å™‰ª≤Èñì„ÇíON„Å´„Åß„Åç„Çã‰Ωï„Åß„ÇÇÂ±ã",[41,113],"ÁµêÂêà: ÊîªÊíÉ+15","„ÉÅ„É≠„Ç∑„É≥„Ç∑„Éß„ÉÉ„Éà",30,[{id:"atp",n:1}]),
mk(19,"Wnt","WNT3A",T.S,39,"Á¥∞ËÉû„ÅÆÈÅãÂëΩ„ÇíÊ±∫„ÇÅ„ÇãÁßòÂØÜ„ÅÆÊâãÁ¥ô",[20],"ÁµêÂêà: Âë≥Êñπ1ÊûöÂæ©Ê¥ª","Wnt„Ç∑„Ç∞„Éä„É´",20,"free"),
mk(20,"Œ≤-„Ç´„ÉÜ„Éã„É≥","CTNNB1",T.S,85,"Wnt„ÅÆÊâãÁ¥ô„ÇíÂ±ä„Åë„ÇãÈÖçÈÅîÂì°„ÄÇÁ¥∞ËÉû„ÅÆÊé•ÁùÄÂâ§„Å´„ÇÇ„Å™„Çã",[19,112],"ÁµêÂêà: Êé•ÁùÄ+10","Ê†∏ÁßªË°å„Ç∑„Ç∞„Éä„É´",35,[{id:"atp",n:1}]),
mk(21,"„Ç¢„ÇØ„ÉÅ„É≥","ACTB",T.ST,42,"Á¥∞ËÉû„ÅÆÈ™®Ê†º„Çí„Å§„Åè„ÇãÁ≥∏„ÄÇÂΩ¢„Å®Âãï„Åç„ÇíÊîØ„Åà„Çã",[22,61,115,116,117],"ÁµêÂêà: HP+10","„Éï„Ç£„É©„É°„É≥„Éà",20,"free"),
mk(22,"Œ±-„ÉÅ„É•„Éº„Éñ„É™„É≥","TUBA1A",T.ST,50,"Œ≤„Å®„Éö„Ç¢„ÅßÁ∑öË∑Ø„Çí„Å§„Åè„Çã„ÄÇÁ¥∞ËÉûÂÜÖ„ÅÆËç∑Áâ©„ÇíÈÅã„Å∂„É¨„Éº„É´",[23,62,63],"ÁµêÂêà: „Ç®„Éç+1","ÂæÆÂ∞èÁÆ°Œ±",25,"free"),
mk(23,"Œ≤-„ÉÅ„É•„Éº„Éñ„É™„É≥","TUBB",T.ST,50,"Œ±„Å®„Éö„Ç¢„ÅßÁ∑öË∑Ø„Çí„Å§„Åè„Çã„ÄÇ‰º∏„Å≥„Åü„ÇäÁ∏Æ„Çì„Å†„Çä„Åô„Çã„É¨„Éº„É´",[22,62,63],"ÁµêÂêà: HP+5","ÂæÆÂ∞èÁÆ°Œ≤",25,"free"),
mk(24,"„Éì„É°„É≥„ÉÅ„É≥","VIM",T.ST,54,"Á¥∞ËÉû„Å´„Åó„Å™„ÇÑ„Åã„Åï„Çí‰∏é„Åà„Çã„Ç¥„É†„Åø„Åü„ÅÑ„Å™Á≥∏",[25],"ÁµêÂêà: „ÉÄ„É°-5","‰∏≠ÈñìÂæÑ",20,"free"),
mk(25,"„É©„Éü„É≥A","LMNA",T.ST,74,"Ê†∏„ÅÆÂÜÖÂÅ¥„ÇíË£úÂº∑„Åô„Çã„Éï„É¨„Éº„É†„ÄÇÈÅ∫‰ºùÂ≠ê„ÇíÂÆà„Çã",[24],"ÁµêÂêà: TF„Ç≥„Çπ„Éà-1","Ê†∏„É©„Éü„Éä",30,"free"),
mk(26,"„Çπ„Éö„ÇØ„Éà„É™„É≥","SPTA1",T.ST,280,"Ëµ§Ë°ÄÁêÉ„ÅÆÂΩ¢„Çí‰øù„Å§„Éê„Éç„ÄÇÁã≠„ÅÑË°ÄÁÆ°„ÇÇÈÄö„Çå„Çã„Çà„ÅÜ„Å´„Åô„Çã",[21],"ÁµêÂêà: „ÉÄ„É°ËªΩÊ∏õ","ËÜúÈ™®Ê†º",50,"free"),
mk(27,"„Éá„Çπ„Éü„É≥","DES",T.ST,53,"Á≠ãËÇâÂ∞ÇÁî®„ÅÆÁ≥∏„ÄÇÁ≠ãËÇâ„ÅÆÊßãÈÄ†„Çí„Å§„Å™„ÅÑ„ÅßÂäõ„ÇíÂá∫„Åô",[61],"ÁµêÂêà: „É¢„Éº„Çø„Éº+5","Á≠ãÈ™®Ê†º",25,"free"),
mk(28,"„Ç±„É©„ÉÅ„É≥","KRT14",T.ST,60,"ÁöÆ„Åµ„ÇÑÈ´™„ÇíÂÆà„Çã„Éê„É™„Ç¢„ÄÇÂ§ñ„ÅÆ„ÉÄ„É°„Éº„Ç∏„ÇíÈò≤„Åê",[],"È´ò„ÅÑÈò≤Âæ°Âäõ","„Éê„É™„Ç¢",15,"free"),
mk(29,"„Ç≥„É©„Éº„Ç≤„É≥I","COL1A1",T.ST,139,"È™®„ÉªËÖ±„ÉªÁöÆ„Åµ„Çí‰∏àÂ§´„Å´„Åô„Çã3Êú¨„ÅÆ„É≠„Éº„Éó„ÄÇ‰Ωì„Åß‰∏ÄÁï™Â§ö„ÅÑÔºÅ",[30,113],"ÁµêÂêà: ÂÖ®Âì°HP+15","ECMÊßãÁØâ",40,"free"),
mk(30,"„Éï„Ç£„Éñ„É≠„Éç„ÇØ„ÉÅ„É≥","FN1",T.ST,250,"Á¥∞ËÉû„ÅÆ„Åæ„Çè„Çä„Å´Á∂≤„ÇíÂºµ„ÇãË∂≥Â†¥„ÄÇ„Åè„Å£„Å§„ÅÑ„Åü„ÇäÂãï„ÅèÊâãÂä©„Åë",[29,113,114],"ÁµêÂêà: Êé•ÁùÄ+10","ECM„Éç„ÉÉ„Éà",50,"free"),
mk(31,"ATPÂêàÊàêÈÖµÁ¥†","ATP5F1A",T.E,600,"ÂõûËª¢„Åó„Å¶ATP„Çí‰Ωú„ÇãÁô∫ÈõªÊ©ü„ÄÇ„Ç®„Éç„É´„ÇÆ„ÉºÂ∑•Â†¥„ÅÆ„Ç®„Éº„Çπ",[],"ÊØé„Çø„Éº„É≥ATP+2","[„Çµ„Éù„Éº„Éà]",0,"free"),
mk(32,"DNA„Éù„É™„É°„É©„Éº„Çº","POLD1",T.E,130,"DNA„Çí„Ç≥„Éî„Éº„Åô„ÇãËÅ∑‰∫∫„ÄÇÈñìÈÅï„ÅÑ„ÇÇÁõ¥„Åõ„Çã",[35],"ÁµêÂêà: 3Êûö„Éâ„É≠„Éº","[„Çµ„Éù„Éº„Éà]",0,"free"),
mk(33,"RNA„Éù„É™„É°„É©„Éº„ÇºII","POLR2A",T.E,514,"DNA„ÅÆÊÉÖÂ†±„ÇímRNA„Å´Êõ∏„ÅçÂÜô„Åô„Ç≥„Éî„ÉºÊ©ü",[71,72,73,74],"ÁµêÂêà: TFÂäπÊûú2ÂÄç","[„Çµ„Éù„Éº„Éà]",0,"free"),
mk(34,"„Éà„Éù„Ç§„ÇΩ„É°„É©„Éº„ÇºII","TOP2A",T.E,174,"„Åã„Çâ„Åæ„Å£„ÅüDNA„ÅÆ„Å≠„Åò„Çå„Çí„Åª„Å©„Åè‰øÆÁêÜÂ±ã",[32],"ÁµêÂêà: Áõ∏ÊâãÁµêÂêàËß£Èô§","[„Çµ„Éù„Éº„Éà]",0,"free"),
mk(35,"„Éò„É™„Ç´„Éº„Çº","MCM2",T.E,47,"DNA„ÅÆ„Ç∏„ÉÉ„Éë„Éº„ÇíÈñã„Åë„Çã‰øÇ„ÄÇ„Ç≥„Éî„Éº„ÅÆÊ∫ñÂÇô„Çí„Åô„Çã",[32],"ÁµêÂêà: Èò≤Âæ°ÁÑ°Ë¶ñ","[„Çµ„Éù„Éº„Éà]",0,"free"),
mk(36,"„Ç´„Çπ„Éë„Éº„Çº-3","CASP3",T.AP,32,"„ÄåÂ£ä„ÅõÔºÅ„Äç„ÅÆÂëΩ‰ª§„ÅßÁ¥∞ËÉû„Çí„Éê„É©„Éê„É©„Å´„Åô„ÇãËß£‰ΩìÂ±ã",[37,104],"ÁµêÂêà: Áõ∏Êâã1ÊûöÁ†¥Â£ä","„Ç¢„Éù„Éà„Éº„Ç∑„Çπ",35,[{id:"atp",n:1}]),
mk(37,"„Ç´„Çπ„Éë„Éº„Çº-9","CASP9",T.AP,47,"„Ç´„Çπ„Éë„Éº„Çº3„ÇíËµ∑„Åì„Åó„Å¶Á¥∞ËÉû„ÅÆËß£‰Ωì„ÇíÂßã„ÇÅ„Çã„Çπ„Ç§„ÉÉ„ÉÅ",[36,104],"ÁµêÂêà: +15„ÉÄ„É°","„Ç´„Çπ„Ç±„Éº„Éâ",30,[{id:"atp",n:1}]),
mk(38,"SOD1","SOD1",T.E,16,"Ê¥ªÊÄßÈÖ∏Á¥†Ôºà„Çµ„ÉìÔºâ„Åã„ÇâÁ¥∞ËÉû„ÇíÂÆà„Çã„Éí„Éº„É≠„Éº",[39],"ÁµêÂêà: HP10ÂõûÂæ©","[„Çµ„Éù„Éº„Éà]",0,"free"),
mk(39,"„Ç´„Çø„É©„Éº„Çº","CAT",T.E,60,"ÊúâÂÆ≥„Å™ÈÅéÈÖ∏ÂåñÊ∞¥Á¥†„ÇíÊ∞¥„Å®ÈÖ∏Á¥†„Å´ÂàÜ„Åë„ÇãÊéÉÈô§Â±ã",[38],"ÁµêÂêà: Áä∂ÊÖãÂõûÂæ©","[„Çµ„Éù„Éº„Éà]",0,"free"),
mk(40,"„ÉÜ„É≠„É°„É©„Éº„Çº","TERT",T.E,127,"ÊüìËâ≤‰Ωì„ÅÆÁ´Ø„Å£„Åì„Çí‰º∏„Å∞„Åó„Å¶Á¥∞ËÉû„ÅÆËÄÅÂåñ„ÇíÈÅÖ„Çâ„Åõ„Çã",[32],"ÁµêÂêà: Á†¥Â£ä„Ç´„Éº„ÉâÂæ©Ê¥ª","[„Çµ„Éù„Éº„Éà]",0,"free"),
mk(41,"EGFR","EGFR",T.R,134,"EGF„ÇíÂèó„ÅëÂèñ„Å£„Å¶„ÄåÂ¢ó„Åà„ÇçÔºÅ„Äç„Å®‰ºù„Åà„Çã„Ç¢„É≥„ÉÜ„Éä",[5,96],"ÁµêÂêà: Ras„Ç≥„Çπ„Éà-1","EGF„Ç∑„Ç∞„Éä„É´",45,[{id:"atp",n:1}]),
mk(42,"VEGFR","KDR",T.R,150,"„ÄåË°ÄÁÆ°„Çí‰Ωú„ÇåÔºÅ„Äç„ÅÆ‰ø°Âè∑„ÇíÂèó„ÅëÂèñ„Çã„Ç¢„É≥„ÉÜ„Éä",[97],"ÁµêÂêà: HP20ÂõûÂæ©","Ë°ÄÁÆ°Êñ∞Áîü",45,[{id:"atp",n:1}]),
mk(43,"„Ç§„É≥„Çπ„É™„É≥ÂèóÂÆπ‰Ωì","INSR",T.R,400,"„Ç§„É≥„Çπ„É™„É≥„ÇíÂèó„ÅëÂèñ„Å£„Å¶Ê†ÑÈ§ä„ÇíÂ±ä„Åë„Çã„Ç¢„É≥„ÉÜ„Éä",[9,51],"ÁµêÂêà: Glc+3","„Ç§„É≥„Çπ„É™„É≥ÂøúÁ≠î",60,[{id:"glucose",n:1}]),
mk(44,"GPCR","ADRB2",T.R,46,"Â§ñ„ÅÆ‰ø°Âè∑„ÇíG„Çø„É≥„Éë„ÇØË≥™„Å´‰ºù„Åà„Çã7ÂõûË≤´ÈÄö„Ç¢„É≥„ÉÜ„Éä",[1,2],"ÁµêÂêà: GËõãÁôΩÂÖ•Êâã","„Ç¢„Éâ„É¨„Éä„É™„É≥",25,"free"),
mk(45,"Notch","NOTCH1",T.R,300,"„Å®„Å™„Çä„ÅÆÁ¥∞ËÉû„Åã„Çâ„ÅÆ‰ø°Âè∑„ÅßÁ¥∞ËÉû„ÅÆÈÅãÂëΩ„ÇíÊ±∫„ÇÅ„Çã„Ç¢„É≥„ÉÜ„Éä",[],null,"„É©„ÉÜ„É©„É´ÊäëÂà∂",55,[{id:"atp",n:2}]),
mk(46,"NMDAÂèóÂÆπ‰Ωì","GRIN1",T.R,120,"ËÑ≥„ÅÆË®òÊÜ∂„Çπ„Ç§„ÉÉ„ÉÅ„ÄÇÊù°‰ª∂„Åå„Åù„Çç„ÅÜ„Å®„Ç´„É´„Ç∑„Ç¶„É†„ÇíÈÄö„Åô",[14,15],"ÁµêÂêà: Ca2++2","„Ç∑„Éä„Éó„ÇπÂèØÂ°ëÊÄß",45,[{id:"ca2",n:1}]),
mk(47,"AMPAÂèóÂÆπ‰Ωì","GRIA1",T.R,100,"ËÑ≥„ÅÆÈÄü„ÅÑ‰ø°Âè∑„Çí‰ºù„Åà„Çã„ÄÇÁ•ûÁµå„ÅÆËààÂ•Æ„Çí„Åô„Å∞„ÇÑ„ÅèÂ±ä„Åë„Çã",[46],"ÁµêÂêà: +1„Ç¢„ÇØ„Ç∑„Éß„É≥","ÈÄü„ÅÑ‰ºùÈÅî",35,[{id:"electrical",n:1}]),
mk(48,"TLR4","TLR4",T.R,95,"„Éê„Ç§Ëèå„ÇíË¶ã„Å§„Åë„Å¶ÁÇéÁóá„Ç¢„É©„Éº„É†„ÇíÈ≥¥„Çâ„ÅôÂÖçÁñ´„Çª„É≥„Çµ„Éº",[72,86],"ÁµêÂêà: ÁÇéÁóá10„ÉÄ„É°","„Éë„Çø„Éº„É≥Ë™çË≠ò",40,[{id:"atp",n:1}]),
mk(49,"TNFÂèóÂÆπ‰Ωì","TNFRSF1A",T.R,55,"„ÄåÊ≠ª„Å≠„Äç„Å®„ÅÑ„ÅÜ‰ø°Âè∑„ÇíÁ¥∞ËÉû„Å´‰ºù„Åà„ÇãÂèóÂÆπ‰Ωì",[86,36],"ÁµêÂêà: ÊåÅÁ∂ö„ÉÄ„É°","„Éá„Çπ„Ç∑„Ç∞„Éä„É´",30,[{id:"atp",n:1}]),
mk(50,"Fas","FAS",T.AP,48,"Êäº„Åï„Çå„Çã„Å®Á¥∞ËÉû„ÅÆËá™ÁàÜ„ÅåÂßã„Åæ„Çã„Çπ„Ç§„ÉÉ„ÉÅ",[36,37],"ÁµêÂêà: Â§ß„ÉÄ„É°„Éº„Ç∏","Fas„É™„Ç¨„É≥„Éâ",35,[{id:"atp",n:1}]),
mk(51,"GLUT1","SLC2A1",T.TR,55,"„Éñ„Éâ„Ç¶Á≥ñ„ÇíÁ¥∞ËÉû„Å´Âèñ„ÇäËæº„ÇÄÊââ„ÄÇ„Ç®„Éç„É´„ÇÆ„Éº„ÅÆÂÖ•„ÇäÂè£",[43],"ÊØé„Çø„Éº„É≥Glc+1","„Ç∞„É´„Ç≥„Éº„ÇπËº∏ÈÄÅ",20,"free"),
mk(52,"„Ç¢„ÇØ„Ç¢„Éù„É™„É≥","AQP1",T.TR,28,"Ê∞¥„Å†„Åë„ÇíÈÄö„ÅôÁâπÂà•„Å™ÈÄöË∑Ø„ÄÇÊ∞¥ÂàÜ„Éê„É©„É≥„Çπ„ÇíË™øÊï¥",[],"Áä∂ÊÖãÁï∞Â∏∏Ëß£Èô§","Ê∞¥ÂàÜË™øÁØÄ",15,"free"),
mk(53,"Na/K ATPase","ATP1A1",T.TR,112,"Na‚Å∫„Å®K‚Å∫„ÇíÂá∫„ÅóÂÖ•„Çå„Åô„Çã„Éù„É≥„Éó„ÄÇÈõªÊ∞ó‰ø°Âè∑„ÅÆÂúüÂè∞",[],"ÊØé„Çø„Éº„É≥ÈõªÊ∞ó+1","„Ç§„Ç™„É≥„Éù„É≥„Éó",40,[{id:"atp",n:1}]),
mk(54,"CFTR","CFTR",T.TR,168,"Â°©Á¥†„Ç§„Ç™„É≥„ÇíÈÄö„ÅôÈÄöË∑Ø„ÄÇÂ£ä„Çå„Çã„Å®ÁóÖÊ∞ó„Å´„Å™„Çã",[],"„Ç®„ÉçÂ§âÊèõ","Cl„ÉÅ„É£„Éç„É´",45,[{id:"atp",n:1}]),
mk(55,"SERCA","ATP2A2",T.TR,110,"‰Ωø„ÅÑÁµÇ„Çè„Å£„Åü„Ç´„É´„Ç∑„Ç¶„É†„Çí„Åó„Åæ„ÅÜ„Éù„É≥„Éó",[14],"ÁµêÂêà: Ca2+ËìÑÁ©ç","Ca2+„Éù„É≥„Éó",40,[{id:"atp",n:1}]),
mk(56,"„Éò„É¢„Ç∞„É≠„Éì„É≥","HBA1",T.TR,64,"ÈÖ∏Á¥†„ÇíÈÅã„Å∂Ëµ§„ÅÑÈÖçÈÅî‰∫∫„ÄÇËÇ∫„Åã„ÇâÂÖ®Ë∫´„Å´Â±ä„Åë„Çã",[],"ÊØé„Çø„Éº„É≥HP+3","O2‰æõÁµ¶",25,"free"),
mk(57,"„Éà„É©„É≥„Çπ„Éï„Çß„É™„É≥","TF",T.TR,80,"ÈâÑ„ÇíÂøÖË¶Å„Å™Â†¥ÊâÄ„Å´Â±ä„Åë„ÇãÈÖçÈÅî‰∫∫",[38],"ÁµêÂêà: ÈÖµÁ¥†+5","ÈâÑËº∏ÈÄÅ",30,"free"),
mk(58,"„Ç¢„É´„Éñ„Éü„É≥","ALB",T.TR,67,"Ëñ¨„ÇÑÊ†ÑÈ§ä„Çí‰πó„Åõ„Å¶ÈÅã„Å∂Ë°ÄÊ∂≤‰∏≠„ÅÆ‰∏áËÉΩ„Çø„ÇØ„Ç∑„Éº",[],"ÂÖ®„Ç≥„Çπ„Éà-1","‰∏áËÉΩËº∏ÈÄÅ",20,"free"),
mk(59,"„ÇØ„É©„Çπ„É™„É≥","CLTC",T.TR,192,"ËÜú„ÇíÂåÖ„Çì„Åß„Ç´„Ç¥„Çí‰Ωú„Çä„ÄÅÂ§ñ„Åã„ÇâÁâ©„ÇíÂèñ„ÇäËæº„ÇÄ",[65,107],"ÁµêÂêà: Áõ∏Êâã1ÊûöÂ•™Âèñ","„Ç®„É≥„Éâ„Çµ„Ç§„Éà„Éº„Ç∑„Çπ",50,[{id:"atp",n:1}]),
mk(60,"„Ç§„É≥„Éù„Éº„ÉÜ„Ç£„É≥","KPNB1",T.TR,97,"Ê†∏„ÅÆÈñÄ„ÇíÈÄö„Å£„Å¶„Çø„É≥„Éë„ÇØË≥™„ÇíÂ±ä„Åë„ÇãÈÖçÈÅî‰∫∫",[25,71,72],"ÁµêÂêà: TFÂç≥Â†¥„Å´","Ê†∏Ëº∏ÈÄÅ",35,[{id:"gtp",n:1}]),
mk(61,"„Éü„Ç™„Ç∑„É≥II","MYH2",T.M,470,"Á≠ãËÇâ„ÇíÂãï„Åã„Åô„É¢„Éº„Çø„Éº„ÄÇ„Ç¢„ÇØ„ÉÅ„É≥„ÅÆ‰∏ä„ÇíÊ≠©„ÅÑ„Å¶Âäõ„ÇíÁîü„ÇÄ",[21],"ÁµêÂêà: ÊîªÊíÉ+25","„Éë„ÉØ„Éº„Çπ„Éà„É≠„Éº„ÇØ",70,[{id:"atp",n:2}]),
mk(62,"„Ç≠„Éç„Ç∑„É≥","KIF5B",T.M,120,"Á∑öË∑Ø„ÅÆ‰∏ä„ÇíÊ≠©„ÅÑ„Å¶Ëç∑Áâ©„ÇíÁ´Ø„Åæ„ÅßÂ±ä„Åë„ÇãÈÅã„Å≥Â±ã",[22,23],"ÁµêÂêà: ÊâãÊú≠ÂÖ•Êõø","È†ÜË°åËº∏ÈÄÅ",40,[{id:"atp",n:1}]),
mk(63,"„ÉÄ„Ç§„Éã„É≥","DYNC1H1",T.M,530,"Á∑öË∑Ø„ÇíÈÄÜÊñπÂêë„Å´Ê≠©„ÅÑ„Å¶Ëç∑Áâ©„Çí‰∏≠ÂøÉ„Å´Êàª„ÅôÈÅã„Å≥Â±ã",[22,23],"ÁµêÂêà: Áõ∏ÊâãÊâãÊú≠Êàª„Åó","ÈÄÜË°åËº∏ÈÄÅ",70,[{id:"atp",n:2}]),
mk(64,"„Éü„Ç™„Ç∑„É≥V","MYO5A",T.M,190,"Èï∑„ÅÑËÖï„ÅßÂ§ß„Åç„ÅèÊ≠©„ÅÑ„Å¶Â∞èËÉû„ÇíÈÅã„Å∂ÈÖçÈÅî„É≠„Éú„ÉÉ„Éà",[21],"ÁµêÂêà: Â∞èËÉû+10","Â∞èËÉû„Éá„É™„Éê„É™„Éº",45,[{id:"atp",n:1}]),
mk(65,"„ÉÄ„Ç§„Éä„Éü„É≥","DNM1",T.M,98,"ËÜú„ÅÆ„Åè„Å≥„Çå„ÇíÂàá„Å£„Å¶Â∞èËÉû„ÇíÂàá„ÇäÈõ¢„Åô„Éè„Çµ„Éü",[59],"ÁµêÂêà: ÁµêÂêàÂÖ®Ëß£Èô§","ËÜú„Éï„Ç£„ÉÉ„Ç∑„Éß„É≥",40,[{id:"gtp",n:1}]),
mk(66,"HSP70","HSPA1A",T.CH,70,"Â£ä„Çå„Åü„Çø„É≥„Éë„ÇØË≥™„ÇíÊ≠£„Åó„ÅÑÂΩ¢„Å´Áõ¥„Åô„ÅäÂåªËÄÖ„Åï„Çì",[67],"Âë≥Êñπ1ÊûöHPÂÖ®ÂõûÂæ©","ÂàÜÂ≠ê„Ç∑„É£„Éö„É≠„É≥",25,[{id:"atp",n:1}]),
mk(67,"HSP90","HSP90AA1",T.CH,90,"Â§ß‰∫ã„Å™„Çø„É≥„Éë„ÇØË≥™„ÇíÂÆâÂÆö„Åï„Åõ„Çã„Éú„Éá„Ç£„Ç¨„Éº„Éâ",[66],"ÁµêÂêà: ÂÖ®Âì°ÊîªÊíÉ+5","„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Ç±„Ç¢",35,[{id:"atp",n:1}]),
mk(68,"HSP60","HSPD1",T.CH,60,"„Éü„Éà„Ç≥„É≥„Éâ„É™„Ç¢„ÅÆ‰∏≠„Åß„Çø„É≥„Éë„ÇØË≥™„ÇíÁõ¥„Åô„ÅäÂåªËÄÖ„Åï„Çì",[],"Á†¥Â£ä„Ç´„Éº„ÉâÂæ©Â∏∞","„Éü„Éà„Ç∑„É£„Éö„É≠„É≥",25,[{id:"atp",n:1}]),
mk(69,"HSP27","HSPB1",T.CH,27,"„Çø„É≥„Éë„ÇØË≥™„ÅåÂõ∫„Åæ„Çã„ÅÆ„ÇíÈò≤„ÅêÂ∞è„Åï„Å™„Ç¨„Éº„Éâ",[21],"ÁµêÂêà: „ÉÄ„É°-10","„Çπ„Éà„É¨„Çπ„Ç¨„Éº„Éâ",15,"free"),
mk(70,"BiP","HSPA5",T.CH,78,"Êñ∞„Åó„ÅÑ„Çø„É≥„Éë„ÇØË≥™„ÇíÊ≠£„Åó„ÅèÊäò„Çä„Åü„Åü„ÇÄÂìÅË≥™„ÉÅ„Çß„ÉÉ„ÇØ‰øÇ",[],null,"ER„Ç∑„É£„Éö„É≠„É≥",30,[{id:"atp",n:1}]),
mk(71,"p53","TP53",T.TF,44,"DNA„ÅÆÂÆàË≠∑ËÄÖ„ÄÇÂÇ∑„ÇíË¶ã„Å§„Åë„Çã„Å®‰øÆÁêÜ„ÅãÁ¥∞ËÉûÊ≠ª„ÇíÂëΩ‰ª§",[36,37,93],"Â§ß„ÉÄ„É° or HPÂõûÂæ©","„Ç¨„Éº„Éá„Ç£„Ç¢„É≥",35,[{id:"atp",n:1}]),
mk(72,"NF-Œ∫B","RELA",T.TF,65,"Êïµ„ÅåÊù•„Çã„Å®ÁõÆË¶ö„ÇÅ„Å¶Èò≤Âæ°ÈÅ∫‰ºùÂ≠ê„ÇíON„Å´„Åô„Çã„Éú„Çπ",[48,86,87],"ÁµêÂêà: ÂÖçÁñ´+10","ÁÇéÁóáÂøúÁ≠î",30,[{id:"atp",n:1}]),
mk(73,"HIF-1Œ±","HIF1A",T.TF,93,"ÈÖ∏Á¥†„ÅåË∂≥„Çä„Å™„ÅÑ„Å®Ë°ÄÁÆ°„ÇíÂ¢ó„ÇÑ„Åó„Å¶Â±ä„Åë„Çã„Çª„É≥„Çµ„Éº",[42],"ÁµêÂêà: 1„Çø„Éº„É≥ÁÑ°Âäπ","‰ΩéÈÖ∏Á¥†ÈÅ©Âøú",35,[{id:"glucose",n:1}]),
mk(74,"c-Myc","MYC",T.TF,49,"„Åü„Åè„Åï„Çì„ÅÆÈÅ∫‰ºùÂ≠ê„Çí‰∏ÄÊ∞ó„Å´ON„Å´„Åô„ÇãÂº∑Âäõ„Ç¢„ÇØ„Çª„É´",[8],"ÊØé„Çø„Éº„É≥+1„Éâ„É≠„Éº","Â¢óÊÆñ„Éâ„É©„Ç§„Éê„Éº",30,[{id:"atp",n:1}]),
mk(75,"Oct4","POU5F1",T.TF,39,"‰∏áËÉΩÁ¥∞ËÉû„Çí‰∏áËÉΩ„ÅÆ„Åæ„Åæ‰øù„Å§„ÄÇiPSÁ¥∞ËÉû„Å´„ÇÇ‰Ωø„ÅÜÂ±±‰∏≠Âõ†Â≠ê",[76],"ÁµêÂêà: ‰ªªÊÑè„ÇíÊâãÊú≠„Å´","‰∏áËÉΩÊÄß",25,"free"),
mk(76,"Sox2","SOX2",T.TF,34,"Oct4„ÅÆ„Éë„Éº„Éà„Éä„Éº„ÄÇ‰∏ÄÁ∑í„Å´‰∏áËÉΩÊÄß„ÇíÂÆà„ÇãÂ±±‰∏≠Âõ†Â≠ê",[75],"ÁµêÂêà: „Ç≥„Éî„Éº","„É™„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞",25,"free"),
mk(77,"CREB","CREB1",T.TF,37,"Èï∑ÊúüË®òÊÜ∂„Çí„Å§„Åè„Çã„Å®„ÅçÈÅ∫‰ºùÂ≠ê„ÇíON„Å´„Åô„Çã„Çπ„Ç§„ÉÉ„ÉÅ",[12],"ÁµêÂêà: „Çπ„Ç≠„É´ÂÜçÂà©Áî®","Èï∑ÊúüË®òÊÜ∂",25,[{id:"atp",n:1}]),
mk(78,"Jun","JUN",T.TF,36,"Fos„Å®„Éö„Ç¢„ÅßÁ¥∞ËÉû„ÅÆÂ¢óÊÆñ„ÇÑÂàÜÂåñ„ÇíÊåáÁ§∫„Åô„Çã",[79],"ÁµêÂêà: ÊîªÊíÉ+10","AP-1",20,"free"),
mk(79,"Fos","FOS",T.TF,41,"Âà∫ÊøÄ„Åß„Åô„ÅêÁèæ„Çå„ÇãÂç≥Âøú‰øÇ„ÄÇJun„Å®„Éö„Ç¢„ÅßÈÅ∫‰ºùÂ≠êON",[78],"ÁµêÂêà: ÂÖ®ÊîªÊíÉ+20","Âç≥ÂàùÊúüÂøúÁ≠î",22,"free"),
mk(80,"YAP","YAP1",T.TF,65,"ËáìÂô®„ÅÆÂ§ß„Åç„Åï„ÇíÊ±∫„ÇÅ„ÇãÊàêÈï∑„Ç≥„É≥„Éà„É≠„Éº„É©„Éº",[20],"Â†¥„ÅÆÊï∞„Å´ÊØî‰æãUP","„É°„Ç´„Éé„Çª„É≥„Çµ„Éº",30,[{id:"atp",n:1}]),
mk(81,"MHC-I","HLA-A",T.IM,44,"Á¥∞ËÉû„ÅÆ‰∏≠Ë∫´„ÇíÂÖçÁñ´„Å´Ë¶ã„Åõ„ÇãÁ™ì„ÄÇ„Ç¶„Ç§„É´„ÇπÊÑüÊüì„ÇíÁü•„Çâ„Åõ„Çã",[89],"Áõ∏Êâã„Ç´„Éº„ÉâÂÖ¨Èñã","ÊäóÂéüÊèêÁ§∫I",25,"free"),
mk(82,"MHC-II","HLA-DRA",T.IM,55,"Â§ñÊïµ„ÅÆÊñ≠Áâá„ÇíÂÖçÁñ´„Å´Ë¶ã„Åõ„ÇãÁ™ì„ÄÇ„ÄåÊïµ„Å†ÔºÅ„Äç„Å®Êïô„Åà„Çã",[90],"ÁµêÂêà: ÂÖçÁñ´1Êûö„Éâ„É≠„Éº","ÊäóÂéüÊèêÁ§∫II",30,"free"),
mk(83,"IgGÈáçÈéñ","IGHG1",T.IM,50,"YÂ≠óÂûã„ÅÆÊäó‰ΩìÊú¨‰Ωì„ÄÇÊïµ„Å´„Åè„Å£„Å§„ÅÑ„Å¶„ÄåÊîªÊíÉ„Åó„Å¶„Äç„Å®‰ºù„Åà„Çã",[84],"ÁµêÂêà: „ÉÄ„É°2ÂÄç","„Ç™„Éó„ÇΩ„Éã„É≥Âåñ",30,"free"),
mk(84,"IgGËªΩÈéñ","IGKC",T.IM,25,"Êäó‰Ωì„ÅÆËÖï„ÄÇÊïµ„ÅÆÂΩ¢„ÇíË¶ãÂàÜ„Åë„ÇãË™çË≠ò„Éë„Éº„ÉÑ",[83],"ÁµêÂêà: ‰∏≠Âíå","Êäó‰Ωì‰∏≠Âíå",15,"free"),
mk(85,"Ë£ú‰ΩìC3","C3",T.IM,187,"ÂÖçÁñ´„ÅÆÂ¢óÂπÖÂô®„ÄÇÊïµ„Å∏„ÅÆÊîªÊíÉ„Çí‰ΩïÂÄç„Å´„ÇÇÂº∑„ÇÅ„Çã",[83],"ÁµêÂêà: ÂÖ®‰Ωì5„ÉÄ„É°","Ë£ú‰ΩìÊ¥ªÊÄßÂåñ",50,[{id:"atp",n:1}]),
mk(86,"TNF-Œ±","TNF",T.IM,17,"ÁÇéÁóá„ÇíËµ∑„Åì„Åó„Å¶ÂÖçÁñ´Á¥∞ËÉû„ÇíÂëº„Å≥ÈõÜ„ÇÅ„Çã„Çµ„Ç§„Éà„Ç´„Ç§„É≥",[49,72],"ÁµêÂêà: ÊØé„Çø„Éº„É≥5„ÉÄ„É°","ÁÇéÁóá„Çπ„Éà„Éº„É†",20,"free"),
mk(87,"IL-6","IL6",T.IM,21,"ÁÇéÁóá„ÇíËµ∑„Åì„Åó„Åü„ÇäÂÖçÁñ´„ÇíÊ¥ªÊÄßÂåñ„Åô„ÇãÂ§öÊ©üËÉΩ„É°„ÉÉ„Çª„É≥„Ç∏„É£„Éº",[16,72],"ÁµêÂêà: ÂÖçÁñ´HP+10","ÊÄ•ÊÄßÊúüÂøúÁ≠î",15,"free"),
mk(88,"IFN-Œ≥","IFNG",T.IM,17,"„Éû„ÇØ„É≠„Éï„Ç°„Éº„Ç∏„ÇíÂÖÉÊ∞ó„Å´„Åó„Å¶Èò≤Âæ°Âäõ„Çí‰∏ä„Åí„Çã„Ç§„É≥„Çø„Éº„Éï„Çß„É≠„É≥",[81],"ÁµêÂêà: 2TÂ∞ÅÂç∞","ÂÖçÁñ´Áõ£Ë¶ñ",20,"free"),
mk(89,"PD-1","PDCD1",T.IM,32,"ÂÖçÁñ´„ÅÆ„Éñ„É¨„Éº„Ç≠„ÄÇTÁ¥∞ËÉû„ÅåÊö¥Ëµ∞„Åó„Å™„ÅÑ„Çà„ÅÜÊ≠¢„ÇÅ„Çã",[81],"Áõ∏ÊâãÂÖçÁñ´ÊîªÊíÉÂçäÊ∏õ","„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà",20,"free"),
mk(90,"CD28","CD28",T.IM,25,"TÁ¥∞ËÉû„ÅÆ„Ç¢„ÇØ„Çª„É´„ÄÇÊîªÊíÉÂäõ„Çí„Éñ„Éº„Çπ„Éà„Åô„Çã",[82],"ÁµêÂêà: ÂÖçÁñ´ÊîªÊíÉ2ÂÄç","ÂÖ±Âà∫ÊøÄ",20,"free"),
mk(91,"„É¶„Éì„Ç≠„ÉÅ„É≥","UBB",T.UB,9,"„ÅÑ„Çâ„Å™„ÅÑ„Çø„É≥„Éë„ÇØË≥™„Å´„ÄåÊç®„Å¶„Å¶„Äç„Çø„Ç∞„Çí„Å§„Åë„Çã„Éû„Éº„Ç´„Éº",[92,93],"ÂàÜËß£„Éû„Éº„ÇØ‰ªò‰∏é","Ub„Çø„Ç∞",10,"free"),
mk(92,"E1„É™„Ç¨„Éº„Çº","UBA1",T.UB,118,"„É¶„Éì„Ç≠„ÉÅ„É≥„Çø„Ç∞„ÇíÊ¥ªÊÄßÂåñ„Åô„ÇãÊ∫ñÂÇô‰øÇ",[91,93],"ÁµêÂêà: Ub„Ç≥„Çπ„Éà0","UbÊ¥ªÊÄßÂåñ",40,[{id:"atp",n:1}]),
mk(93,"MDM2","MDM2",T.UB,55,"p53„Å´„ÄåÂàÜËß£„Åó„Çç„Äç„Çø„Ç∞„Çí„Å§„Åë„Å¶Èáè„ÇíË™øÁØÄ„Åô„Çã",[71,91],"ÁµêÂêà: TFÁ†¥Â£ä","p53ÂàÜËß£",30,[{id:"atp",n:1}]),
mk(94,"„Éó„É≠„ÉÜ„Ç¢„ÇΩ„Éº„É†20S","PSMA1",T.UB,700,"„Çø„Ç∞‰ªò„Åç„Çø„É≥„Éë„ÇØË≥™„Çí„Éê„É©„Éê„É©„Å´„Åô„Çã„Ç¥„ÉüÂá¶ÁêÜÂ†¥",[91],"ÁµêÂêà: „Éû„Éº„ÇØ‰ªò„ÅçÁ†¥Â£ä","„Éó„É≠„ÉÜ„Ç¢„ÇΩ„Éº„É†",80,[{id:"atp",n:2}]),
mk(95,"„Éó„É≠„ÉÜ„Ç¢„ÇΩ„Éº„É†26S","PSMD1",T.UB,2500,"ÊúÄÂº∑„ÅÆ„Ç¥„ÉüÂá¶ÁêÜ„Éû„Ç∑„É≥„ÄÇ„Çø„É≥„Éë„ÇØË≥™„ÇíÂÆåÂÖ®„Å´ÂàÜËß£„Åô„Çã",[91,94],"ÁµêÂêà: 2ÊûöÂêåÊôÇÁ†¥Â£ä","ÂÆåÂÖ®ÂàÜËß£",100,[{id:"atp",n:3}]),
mk(96,"EGF","EGF",T.G,6,"„ÄåÂ¢ó„Åà„ÇçÔºÅ„Äç„Å®Á¥∞ËÉû„Å´‰ºù„Åà„ÇãÊâãÁ¥ô„ÄÇEGFR„Å´Â±ä„Åè",[41],"ÁµêÂêà: ÂèóÂÆπ‰Ωì+15","Â¢óÊÆñ‰øÉÈÄ≤",10,"free"),
mk(97,"VEGF","VEGFA",T.G,23,"„ÄåË°ÄÁÆ°„Çí‰Ωú„ÇåÔºÅ„Äç„Å®ÂëΩ‰ª§„Åô„ÇãÊâãÁ¥ô„ÄÇÈÖ∏Á¥†‰∏çË∂≥„ÅßÂ¢ó„Åà„Çã",[42],"ÁµêÂêà: HP30ÂõûÂæ©","Ë°ÄÁÆ°Êñ∞Áîü",15,"free"),
mk(98,"PDGF","PDGFB",T.G,25,"„Ç±„Ç¨„ÇíÊ≤ª„ÅôÊâãÁ¥ô„ÄÇÂÇ∑Âè£„Å´ÈõÜ„Åæ„Å£„Å¶‰øÆÂæ©„ÇíÂä©„Åë„Çã",[18],"ÁµêÂêà: Âë≥ÊñπHP+5","ÂâµÂÇ∑Ê≤ªÁôí",15,"free"),
mk(99,"TGF-Œ≤","TGFB1",T.G,25,"ÂÖçÁñ´„ÇíÊäë„Åà„Åü„ÇäÁµÑÁπî„ÇíÂ§âÂåñ„Åï„Åõ„ÇãÂ§öÊ©üËÉΩ„É°„ÉÉ„Çª„É≥„Ç∏„É£„Éº",[],"ÂÖçÁñ´ÂäπÊûúÂçäÊ∏õ","ÂÖçÁñ´ÊäëÂà∂",18,"free"),
mk(100,"FGF","FGF2",T.G,17,"Ë°ÄÁÆ°„ÇÑÂÇ∑„ÅÆ‰øÆÂæ©„ÇíÂä©„Åë„ÇãÊâãÁ¥ô„ÄÇÂÜçÁîü„Çí„ÅÜ„Å™„Åå„Åô",[],"ÊßãÈÄ†HP+10","ÁµÑÁπîÂÜçÁîü",15,"free"),
mk(101,"NGF","NGF",T.G,13,"Á•ûÁµå„ÇíËÇ≤„Å¶„ÇãÊâãÁ¥ô„ÄÇÁ•ûÁµåÁ¥∞ËÉû„ÅÆÁîüÂ≠ò„Å®ÊàêÈï∑„ÇíÂä©„Åë„Çã",[10],"ÁµêÂêà: „Ç∑„Ç∞„Éä„É´+5","Á•ûÁµåÊ†ÑÈ§ä",12,"free"),
mk(102,"IGF-1","IGF1",T.G,8,"ÊàêÈï∑„Éõ„É´„É¢„É≥„ÅÆÂëΩ‰ª§„ÇíÂ±ä„Åë„Çã„ÄÇ‰Ωì„ÅÆÊàêÈï∑„Çí„ÅÜ„Å™„Åå„Åô",[43,9],"ÁµêÂêà: ÂÖ®ÊîªÊíÉ+5","ÊàêÈï∑„Éõ„É´„É¢„É≥",10,"free"),
mk(103,"BMP-2","BMP2",T.G,26,"„ÄåÈ™®„Å´„Å™„ÇåÔºÅ„Äç„Å®È™®„ÇÑËªüÈ™®„ÅÆÁ¥∞ËÉû„Å´ÂëΩ‰ª§„Åô„ÇãÊâãÁ¥ô",[],"ÊßãÈÄ†Èò≤Âæ°+15","È™®ÂΩ¢Êàê",18,"free"),
mk(104,"„Ç∑„Éà„ÇØ„É≠„É†c","CYCS",T.AP,12,"ÈõªÂ≠ê„ÅÆÈÅã„Å≥Â±ã„ÄÇ„Éî„É≥„ÉÅ„ÅÆ„Å®„Åç„ÅØ„ÄåËá™ÁàÜ„Åó„Çç„Äç„ÅÆÂêàÂõ≥„Å´„ÇÇ",[36,37],"ÁµêÂêà: „Ç´„Çπ„Ç±„Éº„ÉâÂ§ß„ÉÄ„É°","„Éü„ÉàÁµåË∑Ø",20,"free"),
mk(105,"Bcl-2","BCL2",T.AP,26,"Á¥∞ËÉûÊ≠ª„ÇíÊ≠¢„ÇÅ„Çã„Ç¨„Éº„Éâ„ÄÇ„Éü„Éà„Ç≥„É≥„Éâ„É™„Ç¢„ÇíÂÆà„ÇãÁõæ",[106],"„Ç¢„ÉùÊîªÊíÉÁÑ°ÂäπÂåñ","Á¥∞ËÉûÁîüÂ≠ò",18,"free"),
mk(106,"Bax","BAX",T.AP,21,"„Éü„Éà„Ç≥„É≥„Éâ„É™„Ç¢„Å´Á©¥„ÇíÈñã„Åë„Å¶Á¥∞ËÉûÊ≠ª„ÇíÂßã„ÇÅ„Çã„Çπ„Ç§„ÉÉ„ÉÅ",[105,104],"ÁµêÂêà: Èò≤Âæ°ÂÖ®Ëß£Èô§","ËÜúÁ©øÂ≠î",20,[{id:"atp",n:1}]),
mk(107,"„Ç∑„É≥„Çø„Ç≠„Ç∑„É≥","STX1A",T.V,33,"Â±ä„ÅëÂÖà„ÅÆËÜú„Å´„Åè„Å£„Å§„ÅèÁõÆÂç∞„ÄÇËÜú„ÅÆÂêà‰Ωì„Çí„Ç¨„Ç§„Éâ„Åô„Çã",[108,109],"ÁµêÂêà: 1ÊûöÂç≥Â†¥„Å´","ËÜúËûçÂêà",20,"free"),
mk(108,"„Ç∑„Éä„Éó„Éà„Éñ„É¨„Éì„É≥","VAMP2",T.V,13,"Â∞èËÉû„ÅÆÂÅ¥„ÅÆ„Ç≥„Éç„ÇØ„Çø„ÄÇ„Ç∑„É≥„Çø„Ç≠„Ç∑„É≥„Å®„Åè„Å£„Å§„ÅÑ„Å¶ËÜú„ÇíÂêà‰Ωì",[107,109],"ÁµêÂêà: ÈÄüÊîª","Â∞èËÉûËûçÂêà",12,"free"),
mk(109,"SNAP-25","SNAP25",T.V,25,"3„Å§„Åù„Çç„ÅÜ„Å®ËÜú„ÅåÂêà‰Ωì„Åô„ÇãÊúÄÂæå„ÅÆ„Éî„Éº„Çπ",[107,108],"3ÊûöÂÖ®ÁµêÂêà: ÂÖ®‰Ωì20„ÉÄ„É°","SNARE",18,"free"),
mk(110,"„Ç≥„Éç„Ç≠„Ç∑„É≥43","GJA1",T.AD,43,"„Å®„Å™„Çä„ÅÆÁ¥∞ËÉû„Å®„Éà„É≥„Éç„É´„Åß„Å§„Å™„Åå„ÇãÈÄöË∑Ø",[],null,"„ÇÆ„É£„ÉÉ„ÉóÁµêÂêà",20,"free"),
mk(111,"„ÇØ„É≠„Éº„Éá„Ç£„É≥","CLDN1",T.AD,23,"Á¥∞ËÉû„ÅÆ„Åô„Åç„Åæ„Çí„Éî„ÉÉ„Çø„É™Èñâ„Åò„Çã„Éê„É™„Ç¢",[],null,"„Éê„É™„Ç¢ÂΩ¢Êàê",15,"free"),
mk(112,"E-„Ç´„Éâ„Éò„É™„É≥","CDH1",T.AD,97,"„Ç´„É´„Ç∑„Ç¶„É†„ÅßÊé•ÁùÄÂäõ„ÅåÂá∫„ÇãÁ≥ä„ÄÇÁ¥∞ËÉûÂêåÂ£´„Çí„Å§„Å™„Åê",[20],"ÁµêÂêà: Èò≤Âæ°+15","Á¥∞ËÉûÈñìÊé•ÁùÄ",35,"free"),
mk(113,"„Ç§„É≥„ÉÜ„Ç∞„É™„É≥Œ±5","ITGA5",T.AD,115,"Á¥∞ËÉû„Çí„Åæ„Çè„Çä„ÅÆË∂≥Â†¥„Å´„Åè„Å£„Å§„Åë„Çã„Ç¢„É≥„Ç´„Éº„ÄÇŒ≤1„Å®„Éö„Ç¢",[114,29,30],"ÁµêÂêà: ÊßãÈÄ†+10","ECMÊé•ÁùÄ",40,[{id:"ca2",n:1}]),
mk(114,"„Ç§„É≥„ÉÜ„Ç∞„É™„É≥Œ≤1","ITGB1",T.AD,88,"Œ±5„Å®„Éö„Ç¢„ÅßÁ¥∞ËÉû„ÇíË∂≥Â†¥„Å´Âõ∫ÂÆö„ÄÇ‰ø°Âè∑„ÇÇ‰ºù„Åà„Çã",[113,18],"ÁµêÂêà: ÊîªÈò≤+10","„Ç∑„Ç∞„Éä„É´PF",35,[{id:"ca2",n:1}]),
mk(115,"RhoA","RHOA",T.S,21,"Á¥∞ËÉû„Çí„Ç≠„É•„ÉÉ„Å®Âºï„ÅçÁ∑†„ÇÅ„Å¶ÂΩ¢„Çí„Å§„Åè„ÇãÊåáÊèÆÂÆò",[21,116],"ÁµêÂêà: ÊßãÈÄ†+10","„Çπ„Éà„É¨„Çπ„Éï„Ç°„Ç§„Éê„Éº",15,"free"),
mk(116,"Cdc42","CDC42",T.S,21,"Á¥∞ËÉû„ÅÆÂÖà„Å´„Å®„Åå„Å£„ÅüÁ™ÅËµ∑„Çí„Å§„Åè„Çã„ÄÇÊñπÂêë„ÇíÊ±∫„ÇÅ„Çã",[21,115],"ÁµêÂêà: ÂÖàÊîªÊ®©","„Éï„Ç£„É≠„Éù„Éá„Ç£„Ç¢",15,"free"),
mk(117,"Rac1","RAC1",T.S,21,"Á¥∞ËÉû„ÅÆÂâç„Å´„Éí„É©„Éí„É©„Åó„ÅüËÜú„Çí‰Ωú„Å£„Å¶ÁßªÂãï„ÅÆÂÖàÈ†≠„Å´Á´ã„Å§",[21,115],"ÁµêÂêà: Áõ∏ÊâãÈÖçÁΩÆÂ§âÊõ¥","„É©„É°„É™„Éù„Éá„Ç£„Ç¢",15,"free"),
mk(118,"AMPK","PRKAA1",T.S,63,"ATP„ÅÆÊÆãÈáè„Çª„É≥„Çµ„Éº„ÄÇÂ∞ë„Å™„ÅÑ„Å®ÁúÅ„Ç®„Éç„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà",[11],"„Ç®„ÉçÂ∞ë„Å™„ÅÑÊôÇ: +2","„Ç®„Éç„É´„ÇÆ„Éº„Çª„É≥„Çµ„Éº",30,[{id:"atp",n:1}]),
mk(119,"„Çµ„Ç§„ÇØ„É™„É≥D1","CCND1",T.CY,34,"CDK4„Å®„Éö„Ç¢„ÅßÁ¥∞ËÉûÂàÜË£Ç„ÅÆ„Çπ„Çø„Éº„Éà„ÇíÂàá„ÇãÈñÄÁï™",[120],"ÁµêÂêà: „Ç¢„ÇØ„Ç∑„Éß„É≥2ÂÄç","G1/SÁßªË°å",20,"free"),
mk(120,"CDK4","CDK4",T.CY,34,"„Çµ„Ç§„ÇØ„É™„É≥D1„Å®„Éö„Ç¢„ÅßÂàÜË£Ç„ÇíÈñãÂßã„Åô„Çã„Ç´„ÇÆ",[119],"ÁµêÂêà: ËøΩÂä†„Çø„Éº„É≥ÔºÅ","Rb‰∏çÊ¥ªÊÄßÂåñ",20,"free"),
mk(121,"„Çµ„Éê„Ç§„Éì„É≥","BIRC5",T.AP,16,"Á¥∞ËÉûÊ≠ª„ÇíÈò≤„ÅêÁîüÂ≠òËÄÖ„ÄÇÂàÜË£Ç„ÅÆË¶ãÂºµ„Çä„ÇÇÂÖº„Å≠„Çã",[],null,"„Ç¢„ÉùÈòªÂÆ≥",15,"free"),
mk(122,"Beclin1","BECN1",T.E,52,"Á¥∞ËÉû„ÅÆÂ§ßÊéÉÈô§Ôºà„Ç™„Éº„Éà„Éï„Ç°„Ç∏„ÉºÔºâ„ÇíÂßã„ÇÅ„Çã„Çπ„Ç§„ÉÉ„ÉÅ",[105],"Â¢ìÂú∞„Åã„Çâ2Êûö„Éâ„É≠„Éº","[„Çµ„Éù„Éº„Éà]",0,"free"),
];
/* ‚ïê‚ïê‚ïê SUPPORT CARD EFFECTS (one-shot spells) ‚ïê‚ïê‚ïê */
const SEFF={
  31:{type:"energy",eid:"atp",n:2,desc:"‚ö° ATP√ó2 ‰ªò‰∏é"},
  32:{type:"draw",n:3,desc:"üì• 3Êûö„Éâ„É≠„Éº"},
  33:{type:"atkMul",n:2,desc:"‚öî ÊîªÊíÉÂäõ2ÂÄç(1„Çø„Éº„É≥)"},
  34:{type:"breakBind",desc:"üîì Áõ∏Êâã„ÅÆÁµêÂêà„Çí1„Å§Ëß£Èô§"},
  35:{type:"pierce",desc:"üó° Èò≤Âæ°ÁÑ°Ë¶ñ(1„Çø„Éº„É≥)"},
  38:{type:"heal",n:15,desc:"üíö HP15ÂõûÂæ©"},
  39:{type:"shield",n:15,desc:"üõ° Ë¢´„ÉÄ„É°-15(1„Çø„Éº„É≥)"},
  40:{type:"revive",desc:"‚ôª Â¢ìÂú∞„Åã„Çâ1ÊûöÂæ©Ê¥ª"},
  122:{type:"draw",n:2,from:"grave",desc:"üì• Â¢ìÂú∞‚ÜíÊâãÊú≠2Êûö"},
};
const BUFF0=()=>({atkMul:1,shield:0,pierce:false,extraE:[]});
/* ‚ïê‚ïê‚ïê GAME LOGIC ‚ïê‚ïê‚ïê */
const shuffle=a=>{const b=[...a];for(let i=b.length-1;i>0;i--){const j=0|Math.random()*(i+1);[b[i],b[j]]=[b[j],b[i]];}return b;};
const pick=a=>a[0|Math.random()*a.length];
const uid=()=>Math.random().toString(36).slice(2,9);
function mkDeck(){
  /* Full deck: all 122 cards + enzyme copies √ó3 ‚Üí ~140+ cards */
  const pool=[];
  CARDS.forEach(c=>{
    pool.push(c);
    if(c.isSupport){pool.push(c);pool.push(c);}
  });
  return shuffle(pool).map(c=>({...c,uid:uid(),dmg:0,bw2:[],es:[],tp:-1}));
}
function canPay(es,costs){if(!costs||!costs.length)return true;const pool={};es.forEach(e=>{pool[e]=(pool[e]||0)+1;});for(const c of costs)if((pool[c.id]||0)<c.n)return false;return true;}
function payEnergy(es,costs){if(!costs||!costs.length)return es;const pool=[...es];for(const c of costs){let rem=c.n;for(let i=pool.length-1;i>=0&&rem>0;i--)if(pool[i]===c.id){pool.splice(i,1);rem--;}}return pool;}
/* Pay energy cost across a bind group's members. Only removes exactly the cost. */
function payGroupCost(cards,costs){
  if(!costs||!costs.length)return cards;
  const need={};costs.forEach(c=>{need[c.id]=(need[c.id]||0)+c.n;});
  const updated=cards.map(c=>({...c,es:[...c.es]}));
  for(const eid of Object.keys(need)){
    let rem=need[eid];
    for(const card of updated){
      for(let i=card.es.length-1;i>=0&&rem>0;i--){
        if(card.es[i]===eid){card.es.splice(i,1);rem--;}
      }
    }
  }
  return updated;
}
/* Bound group HP = sum of MW of all bound members. Damage is tracked per-card and doesn't reset. */
/* Binding: same type OR explicit bw list */
function canBind(a,b){return a.bw.includes(b.id)||b.bw.includes(a.id)||a.type===b.type;}
function getGroupHP(card, allField){
  const group=getBindGroup(card,allField);
  return group.reduce((s,c)=>s+(c.hp||0),0);
}
function getBindGroup(card, allField){
  const visited=new Set();
  const q=[card.uid];
  while(q.length){const u=q.pop();if(visited.has(u))continue;visited.add(u);const c=allField.find(x=>x.uid===u);if(c)c.bw2.forEach(b=>{if(!visited.has(b))q.push(b);});}
  return allField.filter(c=>visited.has(c.uid));
}
function getGroupDmg(card, allField){
  return getBindGroup(card,allField).reduce((s,c)=>s+c.dmg,0);
}
function getGroupCurrentHP(card, allField){
  return Math.max(0, getGroupHP(card,allField) - getGroupDmg(card,allField));
}
/* Get all skills available to active card (own + bound partners) */
function getGroupSkills(card, allField){
  const group=getBindGroup(card,allField);
  return group.map(c=>({uid:c.uid,name:c.name,an:c.an,ad:c.ad,ae:c.ae,skill:c.skill,isSupport:c.isSupport})).filter(s=>s.ad>0||s.skill);
}
/* Bind bonus: partner stats + synergy from diversity */
function getBindBonus(card, allField){
  const grp=getBindGroup(card,allField);
  const partners=grp.filter(c=>c.uid!==card.uid);
  if(!partners.length)return 0;
  let bonus=0;
  for(const p of partners){
    /* Base: partner's attack power + rarity bonus */
    const base=p.ad*0.25+p.rarity*3;
    /* Synergy: different strengths complement each other */
    const adDiff=Math.abs(card.ad-p.ad);
    const rarDiff=Math.abs((card.rarity||1)-(p.rarity||1));
    const synergy=adDiff*0.2+rarDiff*4;
    bonus+=base+synergy;
  }
  return Math.round(bonus);
}
const DIFF={easy:{nm:"„ÇÑ„Åï„Åó„ÅÑ",ai:1200,sm:0.2,em:"üå±"},normal:{nm:"„Åµ„Å§„ÅÜ",ai:800,sm:0.5,em:"üåø"},hard:{nm:"„Å§„Çà„ÅÑ",ai:500,sm:0.85,em:"üå≥"}};
const KO_TO_WIN=3;
/* ‚ïê‚ïê‚ïê PVP ONLINE SYSTEM ‚ïê‚ïê‚ïê */
const PVP_Q="pvp:q:";const PVP_M="pvp:m:";
/* ‚ïê‚ïê‚ïê ACCOUNT / TROPHY SYSTEM ‚ïê‚ïê‚ïê */
const RANKS=[
  {min:0,title:"Ë¶ãÁøí„ÅÑÁ†îÁ©∂Âì°",badge:"üî¨",color:"#b8a99a"},
  {min:2,title:"Â≠¶ÈÉ®1Âπ¥Áîü",badge:"üìó",color:"#8b9e6b"},
  {min:5,title:"Â≠¶ÈÉ®2Âπ¥Áîü",badge:"üìó",color:"#7a9e6b"},
  {min:9,title:"Â≠¶ÈÉ®3Âπ¥Áîü",badge:"üìó",color:"#6b9e6b"},
  {min:14,title:"Â≠¶ÈÉ®4Âπ¥Áîü",badge:"üìó",color:"#5b9e6b"},
  {min:20,title:"‰øÆÂ£´1Âπ¥",badge:"üìò",color:"#6b8e9e"},
  {min:28,title:"‰øÆÂ£´2Âπ¥",badge:"üìò",color:"#5b7e9e"},
  {min:37,title:"ÂçöÂ£´Ë™≤Á®ã",badge:"üìô",color:"#c49e5e"},
  {min:48,title:"„Éù„Çπ„Éâ„ÇØ",badge:"üß™",color:"#9e7eab"},
  {min:60,title:"Âä©Êïô",badge:"üéì",color:"#c47e5e"},
  {min:75,title:"ÂáÜÊïôÊéà",badge:"üèõÔ∏è",color:"#b87e8e"},
  {min:95,title:"ÊïôÊéà",badge:"üë®‚Äçüè´",color:"#8b6e9e"},
  {min:120,title:"ÂêçË™âÊïôÊéà",badge:"üéñÔ∏è",color:"#9e8b5e"},
  {min:150,title:"„Éé„Éº„Éô„É´Ë≥ûÂèóË≥ûËÄÖ",badge:"üèÜ",color:"#c49e2e"},
  {min:200,title:"„Ç§„Ç∞„Éé„Éº„Éô„É´Ë≥ûÂèóË≥ûËÄÖ",badge:"ü§£",color:"#e07030"},
  {min:260,title:"ÂÖ®„Å¶„ÅÆÁßëÂ≠¶ËÄÖ„Å´Êï¨ÊÑè„ÇíÊâï„ÅÜ",badge:"üåç",color:"#4a8a5a"},
];
const getRank=w=>{let r=RANKS[0];for(const rk of RANKS)if(w>=rk.min)r=rk;return r;};
const AVATARS=[
  /* ÁÑ°Êñô (2) */
  {id:"cell",em:"üß¨",cost:0,name:"DNA"},
  {id:"micro",em:"üî¨",cost:0,name:"È°ïÂæÆÈè°"},
  /* 150„Ç≥„Ç§„É≥ (5) */
  {id:"bact",em:"ü¶†",cost:150,name:"Á¥∞ËÉû"},
  {id:"drop",em:"ü©∏",cost:150,name:"Ë°ÄÊ∂≤"},
  {id:"bone",em:"ü¶¥",cost:150,name:"È™®"},
  {id:"herb",em:"üåø",cost:150,name:"„Éè„Éº„Éñ"},
  {id:"mush",em:"üçÑ",cost:150,name:"„Ç≠„Éé„Ç≥"},
  /* 250„Ç≥„Ç§„É≥ (5) */
  {id:"heart",em:"ü´Ä",cost:250,name:"ÂøÉËáì"},
  {id:"lung",em:"ü´Å",cost:250,name:"ËÇ∫"},
  {id:"brain",em:"üß†",cost:250,name:"ËÑ≥"},
  {id:"eye",em:"üëÅÔ∏è",cost:250,name:"Áúº"},
  {id:"tooth",em:"ü¶∑",cost:250,name:"Ê≠Ø"},
  /* 350„Ç≥„Ç§„É≥ (5) */
  {id:"dna2",em:"üß™",cost:350,name:"Ë©¶È®ìÁÆ°"},
  {id:"pill",em:"üíä",cost:350,name:"„Ç´„Éó„Çª„É´"},
  {id:"petri",em:"üß´",cost:350,name:"„Ç∑„É£„Éº„É¨"},
  {id:"syringe",em:"üíâ",cost:350,name:"Ê≥®Â∞ÑÂô®"},
  {id:"scope2",em:"üî≠",cost:350,name:"ÊúõÈÅ†Èè°"},
  /* 500„Ç≥„Ç§„É≥ (8) */
  {id:"star",em:"‚≠ê",cost:500,name:"„Çπ„Çø„Éº"},
  {id:"fire",em:"üî•",cost:500,name:"„Éï„É¨„Ç§„É†"},
  {id:"bolt",em:"‚ö°",cost:500,name:"„Çµ„É≥„ÉÄ„Éº"},
  {id:"snowfl",em:"‚ùÑÔ∏è",cost:500,name:"„Çπ„Éé„Éº"},
  {id:"wave",em:"üåä",cost:500,name:"„Ç¶„Çß„Éº„Éñ"},
  {id:"moon",em:"üåô",cost:500,name:"„É†„Éº„É≥"},
  {id:"sun",em:"‚òÄÔ∏è",cost:500,name:"„Çµ„É≥"},
  {id:"tornado",em:"üå™Ô∏è",cost:500,name:"„Éà„É´„Éç„Éº„Éâ"},
  /* 650„Ç≥„Ç§„É≥ (6) */
  {id:"crown",em:"üëë",cost:650,name:"ÁéãÂÜ†"},
  {id:"gem",em:"üíé",cost:650,name:"„ÉÄ„Ç§„É§"},
  {id:"medal",em:"ü•á",cost:650,name:"Èáë„É°„ÉÄ„É´"},
  {id:"crystal",em:"üîÆ",cost:650,name:"Ê∞¥Êô∂Áéâ"},
  {id:"ring",em:"üíç",cost:650,name:"„É™„É≥„Ç∞"},
  {id:"trident",em:"üî±",cost:650,name:"„Éà„É©„Ç§„Éá„É≥„Éà"},
  /* 800„Ç≥„Ç§„É≥ (6) */
  {id:"rocket",em:"üöÄ",cost:800,name:"„É≠„Ç±„ÉÉ„Éà"},
  {id:"ufo",em:"üõ∏",cost:800,name:"UFO"},
  {id:"sat",em:"üõ∞Ô∏è",cost:800,name:"Ë°õÊòü"},
  {id:"comet",em:"‚òÑÔ∏è",cost:800,name:"ÂΩóÊòü"},
  {id:"milky",em:"üåå",cost:800,name:"ÈäÄÊ≤≥"},
  {id:"globe",em:"üåç",cost:800,name:"Âú∞ÁêÉ"},
  /* 1000„Ç≥„Ç§„É≥ (5) */
  {id:"rainbow",em:"üåà",cost:1000,name:"„É¨„Ç§„É≥„Éú„Éº"},
  {id:"dragon",em:"üêâ",cost:1000,name:"„Éâ„É©„Ç¥„É≥"},
  {id:"phoenix",em:"ü¶Ö",cost:1000,name:"„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ"},
  {id:"whale",em:"üêã",cost:1000,name:"„ÇØ„Ç∏„É©"},
  {id:"octo",em:"üêô",cost:1000,name:"„Çø„Ç≥"},
  /* 1300„Ç≥„Ç§„É≥ (4) */
  {id:"uni",em:"ü¶Ñ",cost:1300,name:"„É¶„Éã„Ç≥„Éº„É≥"},
  {id:"alien",em:"üëæ",cost:1300,name:"„Ç®„Ç§„É™„Ç¢„É≥"},
  {id:"robot",em:"ü§ñ",cost:1300,name:"„É≠„Éú„ÉÉ„Éà"},
  {id:"ghost",em:"üëª",cost:1300,name:"„Ç¥„Éº„Çπ„Éà"},
  /* 1600„Ç≥„Ç§„É≥ (3) */
  {id:"cherry",em:"üå∏",cost:1600,name:"„Çµ„ÇØ„É©"},
  {id:"aurora",em:"üéÜ",cost:1600,name:"„Ç™„Éº„É≠„É©"},
  {id:"infinity",em:"‚ôæÔ∏è",cost:1600,name:"„Ç§„É≥„Éï„Ç£„Éã„ÉÜ„Ç£"},
  /* 2000„Ç≥„Ç§„É≥ (2) */
  {id:"blackhole",em:"üï≥Ô∏è",cost:2000,name:"„Éñ„É©„ÉÉ„ÇØ„Éõ„Éº„É´"},
  {id:"bigbang",em:"üí•",cost:2000,name:"„Éì„ÉÉ„Ç∞„Éê„É≥"},
];
const COMPLETE_AVATAR={id:"complete",em:"üåü",name:"„Éû„Çπ„Çø„Éº„Çª„É´"};/* ÂÖ®Ë≥ºÂÖ•„Åß‰ªò‰∏é */
const BUYABLE_IDS=AVATARS.filter(a=>a.cost>0).map(a=>a.id);
const getMonthKey=()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;};
const TROPHY_PREFIX="trophy:";
const F=`'Zen Maru Gothic','Kosugi Maru',sans-serif`;
const CSS=`@import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap');*{box-sizing:border-box;margin:0;padding:0;user-select:none;-webkit-tap-highlight-color:transparent}::-webkit-scrollbar{display:none}html{font-size:clamp(12px,2.5vw,16px)}@media(max-width:400px){.card-sm{transform:scale(0.85)!important}.card-md{transform:scale(0.9)!important}}@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}@keyframes softGlow{0%,100%{box-shadow:0 0 4px #c49e5e22}50%{box-shadow:0 0 14px #c49e5e44}}@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1.2)}100%{opacity:0;transform:translateY(-50px) scale(.6)}}@keyframes pop{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}@keyframes eBounce{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}@keyframes dropGlow{0%,100%{border-color:#8b9e6b44}50%{border-color:#8b9e6b}}@keyframes sparkle{0%,100%{box-shadow:0 0 3px #c49e5e33,0 0 6px #c49e5e11}50%{box-shadow:0 0 8px #c49e5eaa,0 0 16px #c49e5e44,inset 0 0 4px #c49e5e22}}@keyframes bindPulse{0%,100%{box-shadow:0 0 4px #8b9e6b22;border-color:inherit}50%{box-shadow:0 0 12px #8b9e6baa,0 0 20px #8b9e6b44;border-color:#8b9e6b}}@keyframes dragTarget{0%,100%{box-shadow:0 0 6px #c49e5e44}50%{box-shadow:0 0 16px #c49e5edd,0 0 24px #c49e5e66}}@keyframes goldGlow{0%,100%{box-shadow:0 0 6px #ffd70033,0 0 12px #ffd70011}50%{box-shadow:0 0 14px #ffd700aa,0 0 24px #ffd70044,0 0 36px #ffd70022}}`;
const ESvg=({id,size})=>{const fn=EART[id];if(!fn)return null;return <span style={{display:"inline-block",flexShrink:0,verticalAlign:"middle"}} dangerouslySetInnerHTML={{__html:fn(size||14)}}/>;};
/* ‚ïê‚ïê‚ïê CARD COMPONENT ‚ïê‚ïê‚ïê */
const AtkInfo=({c,sz,showFull})=>{
  if(c.isSupport){const eff=SEFF[c.id];return <div style={{fontSize:sz>7?8:5,color:"#c49e5e",fontWeight:700,marginTop:1,textAlign:"center"}}>{eff?eff.desc:"‚öô „Çµ„Éù„Éº„Éà"}</div>;}
  if(!c.ad||c.ad<=0)return null;
  const fs=sz;
  const noCost=!c.ae||!c.ae.length;
  return <div style={{marginTop:1,display:"flex",flexDirection:"column",alignItems:"center",gap:0,width:"100%",lineHeight:1.2}}>
    <div style={{fontSize:fs,fontWeight:800,display:"flex",alignItems:"center",gap:2,flexWrap:"wrap",justifyContent:"center"}}>
      <span style={{color:"#c47e5e"}}>‚öî{c.ad}</span>
      {noCost?null:
        <span style={{display:"flex",gap:1,alignItems:"center",background:"rgba(0,0,0,.06)",borderRadius:4,padding:"0 3px"}}>
          {c.ae.map((e,i)=><React.Fragment key={i}>{i>0&&<span style={{fontSize:fs-2,color:"#aaa"}}>+</span>}<ESvg id={e.id} size={fs+1}/>{e.n>1&&<span style={{fontSize:fs-1,color:"#8b7e6b"}}>√ó{e.n}</span>}</React.Fragment>)}
        </span>}
    </div>
    {showFull&&<div style={{fontSize:Math.max(fs-2,4),color:"#8b7e6b",marginTop:1}}>{c.an}</div>}
  </div>;
};
const CardComp=({c,size="sm",onTap,selected,hit,glow,sparkle,bindPulse,dragTarget,faceDown,allField})=>{
  if(!c&&!faceDown)return null;
  const isLg=size==="lg",isMd=size==="md";
  const w=isLg?140:isMd?80:56, h=isLg?220:isMd?112:84, r=isLg?18:isMd?14:10;
  if(faceDown)return <div style={{width:w,height:h,borderRadius:r,background:"#e8e0d4",border:"2px solid #d4ccc0",display:"flex",alignItems:"center",justifyContent:"center",fontSize:isLg?28:16,flexShrink:0}}>üß¨</div>;
  const isEnz=c.type===T.E;
  const tc=TC[c.type]||["#8b7e6b","#f0eeea","#3d3a2e"];
  const bg=isEnz?"linear-gradient(165deg,#1a1a1a,#2d2d2d)":
    `linear-gradient(165deg,${tc[1]},#faf6f0)`;
  const txtC=isEnz?"#e0d8cc":tc[2];
  const subC=isEnz?"#999":tc[0];
  let hpPct=1, maxHp=c.hp||0, curHp=c.hp||0;
  if(allField&&allField.length>0){
    maxHp=getGroupHP(c,allField);
    const dmgTotal=getGroupDmg(c,allField);
    curHp=Math.max(0,maxHp-dmgTotal);
    hpPct=maxHp>0?curHp/maxHp:0;
  }
  const anim=dragTarget?"dragTarget .8s ease infinite":sparkle?"sparkle 1.2s ease infinite":bindPulse?"bindPulse 1.5s ease infinite":hit?"shake .4s ease":glow?"softGlow 1.5s ease infinite":"none";
  return <div onClick={onTap} style={{width:w,height:h,borderRadius:r,background:bg,
    border:`${isLg?3:2}px solid ${selected?"#c49e5e":dragTarget?"#c49e5e":bindPulse?"#8b9e6b88":isEnz?"#444":tc[0]}${selected||dragTarget||bindPulse?"":"55"}`,
    boxShadow:selected?`0 0 0 3px #c49e5e33`:hit?`0 0 16px #c47e5e44`:`0 2px 8px #0001`,
    display:"flex",flexDirection:"column",alignItems:"center",padding:isLg?7:isMd?4:2,
    position:"relative",cursor:"pointer",transition:"all .2s",flexShrink:0,overflow:"hidden",animation:anim}}>
    {isEnz&&isLg&&<div style={{position:"absolute",top:4,left:6,fontSize:7,color:"#888",fontWeight:700,background:"#333",borderRadius:6,padding:"1px 5px"}}>‚öô „Çµ„Éù„Éº„Éà</div>}
    <div style={{width:isLg?56:isMd?36:24,height:isLg?56:isMd?36:24,flexShrink:0}} dangerouslySetInnerHTML={{__html:`<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">${getArt(c.id,c.type)}</svg>`}}/>
    <div style={{fontSize:isLg?12:isMd?8:6,color:txtC,fontFamily:F,fontWeight:900,textAlign:"center",lineHeight:1.1,marginTop:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"96%"}}>{c.name}</div>
    <div style={{fontSize:isLg?8:isMd?6:4,color:c.rarity>=4?"#c49e5e":c.rarity>=3?"#8b9e6b":"#b8a99a",lineHeight:1,letterSpacing:isLg?1:0}}>{"‚òÖ".repeat(c.rarity||1)}{"‚òÜ".repeat(5-(c.rarity||1))}</div>
    {!isEnz&&<div style={{position:"absolute",top:isLg?4:isMd?2:1,left:isLg?6:isMd?3:2,fontSize:isLg?9:isMd?7:6,fontWeight:900,color:"#fff",background:hpPct>0.5?"#8b9e6b":hpPct>0.25?"#c49e5e":"#c47e5e",borderRadius:isLg?8:6,padding:isLg?"1px 5px":"0px 3px",lineHeight:1.3,boxShadow:"0 1px 3px #0002"}}>‚ô°{curHp}</div>}
    <div style={{fontSize:isLg?8:isMd?6:5,color:subC,fontWeight:600,opacity:0.7}}>{c.mw}kDa</div>
    {isLg&&<div style={{fontSize:7,color:isEnz?"#aaa":"#6b6358",lineHeight:1.3,marginTop:2,padding:"0 4px",textAlign:"center",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",maxHeight:20}}>{c.desc}</div>}
    {!isEnz&&<div style={{width:"90%",marginTop:isLg?4:2}}>
      <div style={{height:isLg?5:isMd?3:2,background:"#e8e0d422",borderRadius:4,overflow:"hidden"}}>
        <div style={{height:"100%",borderRadius:4,width:`${Math.max(0,hpPct*100)}%`,background:hpPct>0.5?"#8b9e6b":hpPct>0.25?"#c49e5e":"#c47e5e",transition:"width .4s"}}/>
      </div>
      {isLg&&<div style={{display:"flex",justifyContent:"space-between",fontSize:7,color:"#8b7e6b",marginTop:1}}><span>‚ô° {curHp}/{maxHp}</span></div>}
    </div>}
    {(isLg||isMd)&&<div style={{display:"flex",gap:1,marginTop:isLg?2:1,alignItems:"center",justifyContent:"center",flexWrap:"wrap"}}>
      {(c.es||[]).map((eid,i)=><ESvg key={i} id={eid} size={isLg?12:8}/>)}
    </div>}
    <AtkInfo c={c} sz={isLg?9:isMd?7:5} showFull={isLg}/>
    {c.bw2?.length>0&&<div style={{position:"absolute",top:isLg?4:2,right:isLg?4:2,fontSize:isLg?9:6,background:"#8b9e6b",color:"#fff",borderRadius:"50%",width:isLg?18:12,height:isLg?18:12,display:"flex",alignItems:"center",justifyContent:"center"}}>üîó</div>}
  </div>;
};
const KODots=({count,max,color})=><div style={{display:"flex",gap:3}}>{Array.from({length:max},(_,i)=><div key={i} style={{width:12,height:12,borderRadius:"50%",background:i<count?color:"transparent",border:`2px solid ${i<count?color:"#d4ccc055"}`,transition:"all .3s"}}/>)}</div>;
/* ‚ïê‚ïê‚ïê MAIN GAME ‚ïê‚ïê‚ïê */
export default function CellBattle(){
  const[screen,setScreen]=useState("loading");
  const[diff,setDiff]=useState(null);
  const[acct,setAcct]=useState(null);
  const[shopMsg,setShopMsg]=useState(null);
  const[g,setG]=useState(null);
  const[phase,setPhase]=useState("start");
  const[turn,setTurn]=useState(1);
  const[winner,setWinner]=useState(null);
  const[msg,setMsg]=useState(null);
  const[eChoice,setEChoice]=useState(null);
  const[hitAnim,setHitAnim]=useState(null);
  const[dmgFloat,setDmgFloat]=useState(null);
  const[detail,setDetail]=useState(null);
  const[drag,setDrag]=useState(null);
  const[attacked,setAttacked]=useState(false);
  const[coinReward,setCoinReward]=useState(0);
  const[playerFirst,setPlayerFirst]=useState(true);
  /* PVP state */
  const[pvp,setPvp]=useState(false);
  const[pvpRole,setPvpRole]=useState(null);
  const[pvpMatch,setPvpMatch]=useState(null);
  const[pvpTimer,setPvpTimer]=useState(0);
  const[pvpOppInfo,setPvpOppInfo]=useState(null);
  const pvpSid=useRef(Math.random().toString(36).slice(2,10));
  const pvpPoll=useRef(null);
  const pvpVer=useRef(0);
  const pvpSetupDone=useRef(false);
  const[turnClock,setTurnClock]=useState(20);
  const pvpOppIdle=useRef(0);
  const pvpHbRef=useRef(null);
  const[pvpForfeit,setPvpForfeit]=useState(null);/* null | "idle" | "disconnect" */
  const[leaderboard,setLeaderboard]=useState([]);/* [{name,avatar,trophies}] */
  const tid=useRef(0);
  const flash=useCallback((text,dur)=>{const k=++tid.current;setMsg({k,text});setTimeout(()=>setMsg(p=>p?.k===k?null:p),dur||2200);},[]);

  /* Account persistence */
  useEffect(()=>{(async()=>{
    cleanupOldEntries();/* Clean old PvP queue/match entries */
    try{const r=await storage.get("cellbattle_acct");
      if(r&&r.value){setAcct(JSON.parse(r.value));setScreen("title");}
      else{setScreen("register");}
    }catch(e){setScreen("register");}
  })();},[]);
  const saveAcct=useCallback(async(data)=>{
    setAcct(data);
    try{await storage.set("cellbattle_acct",JSON.stringify(data));}catch(e){}
  },[]);
  const awardResult=useCallback(async(won,difficulty)=>{
    if(!acct)return;
    const coinReward=won?{easy:15,normal:25,hard:40}[difficulty]||20:{easy:5,normal:8,hard:12}[difficulty]||5;
    const na={...acct,wins:acct.wins+(won?1:0),losses:acct.losses+(won?0:1),coins:acct.coins+coinReward};
    await saveAcct(na);
    /* Update monthly trophy with opponent-relative scoring */
    try{
      const mk=getMonthKey();const tKey=TROPHY_PREFIX+mk+":"+acct.name;
      const cur=await storage.get(tKey,true);
      const prev=cur?JSON.parse(cur.value):{name:acct.name,avatar:acct.avatar,trophies:0};
      /* Get opponent trophies */
      let oppTrophies=0;
      if(pvpOppInfo?.name){
        try{const oR=await storage.get(TROPHY_PREFIX+mk+":"+pvpOppInfo.name,true);
          if(oR)oppTrophies=JSON.parse(oR.value).trophies||0;}catch(e){}
      }
      const myT=prev.trophies||0;
      let delta=0;
      if(won){delta=oppTrophies>myT?5:4;}
      else{delta=myT>oppTrophies?-5:-4;}
      prev.trophies=Math.max(0,(prev.trophies||0)+delta);prev.avatar=acct.avatar;prev.ts=Date.now();
      await storage.set(tKey,JSON.stringify(prev),true);
    }catch(e){}
    return coinReward;
  },[acct,saveAcct,pvpOppInfo]);
  const fetchLeaderboard=useCallback(async()=>{
    try{
      const mk=getMonthKey();const keys=await storage.list(TROPHY_PREFIX+mk+":",true);
      if(!keys?.keys)return;
      const entries=[];
      for(const k of keys.keys){
        try{const r=await storage.get(k,true);if(r)entries.push(JSON.parse(r.value));}catch(e){}
      }
      entries.sort((a,b)=>(b.trophies||0)-(a.trophies||0));
      setLeaderboard(entries.slice(0,5));
    }catch(e){}
  },[]);
  const resultAwarded=useRef(false);

  /* ‚ïê‚ïê‚ïê PVP: Matchmaking ‚ïê‚ïê‚ïê */
  const pvpCleanup=useCallback(async()=>{
    if(pvpPoll.current){clearTimeout(pvpPoll.current);pvpPoll.current=null;}
    /* Write surrender if active match */
    if(pvpMatch&&pvpMatch!=="ai"&&!winner){
      try{
        const r=await storage.get(PVP_M+pvpMatch,true);
        if(r){const st=JSON.parse(r.value);
          if(!st.winner){st.winner=pvpRole==="p1"?"p2":"p1";st.v++;
            await storage.set(PVP_M+pvpMatch,JSON.stringify(st),true);}}
      }catch(e){}
    }
    try{await storage.delete(PVP_Q+pvpSid.current,true);}catch(e){}
    try{await storage.delete("pvp:hb:"+pvpMatch+":"+pvpRole,true);}catch(e){}
  },[pvpMatch,pvpRole,winner]);
  useEffect(()=>()=>{pvpCleanup();},[pvpCleanup]);
  /* Handle tab close / navigation away ‚Üí surrender */
  useEffect(()=>{
    const handler=()=>{if(pvpMatch&&pvpMatch!=="ai"&&!winner){pvpCleanup();}};
    window.addEventListener("beforeunload",handler);
    return()=>window.removeEventListener("beforeunload",handler);
  },[pvpMatch,winner,pvpCleanup]);

  const pvpStartMatch=useCallback(async()=>{
    setPvpTimer(0);setPvpMatch(null);setPvpRole(null);setPvpOppInfo(null);pvpSetupDone.current=false;pvpVer.current=0;pvpOppIdle.current=0;setPvpForfeit(null);
    setScreen("pvp_matching");
    const me={name:acct?.name||"„Ç≤„Çπ„Éà",avatar:acct?.avatar||"cell",wins:acct?.wins||0,sid:pvpSid.current,ts:Date.now(),matched:false};
    await storage.set(PVP_Q+pvpSid.current,JSON.stringify(me),true);
    let elapsed=0;
    const poll=async()=>{
      elapsed+=1200;setPvpTimer(Math.floor(elapsed/1000));
      /* Check if we got matched by someone else */
      try{
        const myQ=await storage.get(PVP_Q+pvpSid.current,true);
        if(myQ){const d=JSON.parse(myQ.value);
          if(d.matched&&d.matchId){
            setPvpMatch(d.matchId);setPvpRole(d.role);
            if(d.oppName)setPvpOppInfo({name:d.oppName,avatar:d.oppAvatar||"cell"});
            pvpLoadMatch(d.matchId,d.role);return;
          }
        }
      }catch(e){}
      /* Search for other waiting players */
      try{
        const keys=await storage.list(PVP_Q,true);
        console.log("[PVP] mySid:",pvpSid.current,"allKeys:",keys?.keys,"elapsed:",elapsed);
        if(keys?.keys){
          const others=keys.keys.filter(k=>k!==PVP_Q+pvpSid.current);
          console.log("[PVP] others:",others);
          for(const ok of others){
            try{
              const r=await storage.get(ok,true);
              if(!r)continue;
              const opp=JSON.parse(r.value);
              if(opp.matched)continue;
              /* I'm the one with lower SID ‚Üí I create the match */
              if(pvpSid.current<opp.sid){
                const matchId="m_"+Date.now()+"_"+pvpSid.current.slice(0,4);
                /* Create match state: generate both decks */
                const pD=mkDeck(),eD=mkDeck();
                const drawH=(deck)=>{const pr=[],su=[];for(let i=0;i<deck.length;i++){if(!deck[i].isSupport&&pr.length<2)pr.push(i);else if(deck[i].isSupport&&su.length<1)su.push(i);if(pr.length>=2&&su.length+pr.length>=3)break;}const ix=[...pr];if(ix.length<3)for(const si of su){if(ix.length>=3)break;ix.push(si);}for(let i=0;ix.length<3&&i<deck.length;i++){if(!ix.includes(i))ix.push(i);}ix.sort((a,b)=>a-b);return[ix.map(i=>deck[i]),deck.filter((_,i)=>!ix.includes(i))];};
                const[p1H,p1D]=drawH(pD);const[p2H,p2D]=drawH(eD);
                const state={v:1,turn:0,currentTurn:null,winner:null,
                  p1:{act:null,bench:[],hand:p1H,deck:p1D,grave:[],ko:0,buff:BUFF0(),setupDone:false,info:{name:acct?.name||"„Ç≤„Çπ„Éà",avatar:acct?.avatar||"cell",wins:acct?.wins||0}},
                  p2:{act:null,bench:[],hand:p2H,deck:p2D,grave:[],ko:0,buff:BUFF0(),setupDone:false,info:{name:opp.name,avatar:opp.avatar,wins:opp.wins||0}}};
                await storage.set(PVP_M+matchId,JSON.stringify(state),true);
                /* Update both queue entries */
                await storage.set(PVP_Q+pvpSid.current,JSON.stringify({...me,matched:true,matchId,role:"p1",oppName:opp.name,oppAvatar:opp.avatar}),true);
                await storage.set(ok,JSON.stringify({...opp,matched:true,matchId,role:"p2",oppName:acct?.name||"„Ç≤„Çπ„Éà",oppAvatar:acct?.avatar||"cell"}),true);
                setPvpMatch(matchId);setPvpRole("p1");setPvpOppInfo({name:opp.name,avatar:opp.avatar});
                pvpLoadMatch(matchId,"p1");return;
              }
            }catch(e){}
          }
        }
      }catch(e){}
      /* Timeout ‚Üí AI fallback */
      if(elapsed>=15000){
        pvpCleanup();
        setPvp(true);setPvpMatch("ai");setPvpRole("p1");
        start("normal");return;
      }
      pvpPoll.current=setTimeout(poll,1200);
    };
    pvpPoll.current=setTimeout(poll,1200);
  },[acct,pvpCleanup]);

  const pvpLoadMatch=useCallback(async(matchId,role)=>{
    pvpCleanup();
    try{
      const r=await storage.get(PVP_M+matchId,true);
      if(!r)return;
      const st=JSON.parse(r.value);
      const me=st[role],opp=st[role==="p1"?"p2":"p1"];
      setPvpOppInfo(opp.info);pvpVer.current=st.v;pvpSetupDone.current=false;
      setG({pAct:me.act,pBench:me.bench,ph:me.hand,pd:me.deck,pg:me.grave,pko:me.ko,
        eAct:opp.act,eBench:opp.bench,eh:opp.hand,ed:opp.deck,eg:opp.grave,eko:opp.ko,
        pBuff:me.buff||BUFF0(),eBuff:opp.buff||BUFF0(),ipt:true});
      setPvp(true);setPvpMatch(matchId);setPvpRole(role);
      turnDrawn.current=0;enemyRunning.current=false;resultAwarded.current=false;
      setCoinReward(0);setTurn(0);setPhase("setup");setWinner(null);setDetail(null);setScreen("game");
      flash("„Éê„Éà„É´Â†¥„Å´Âá∫„Åô„Ç´„Éº„Éâ„ÇíÈÅ∏„Åº„ÅÜÔºÅ");
    }catch(e){flash("Êé•Á∂ö„Ç®„É©„Éº");setScreen("title");}
  },[pvpCleanup,flash]);

  /* PVP: Write game state to shared storage */
  const pvpWriteState=useCallback(async(gs,currentPhase,currentTurn,currentWinner,autoEnd=false)=>{
    if(!pvpMatch||pvpMatch==="ai")return;
    const role=pvpRole;const oRole=role==="p1"?"p2":"p1";
    try{
      const r=await storage.get(PVP_M+pvpMatch,true);
      if(!r)return;
      const st=JSON.parse(r.value);
      st.v=++pvpVer.current;st.turn=currentTurn;st.winner=currentWinner;
      st.currentTurn=currentPhase==="pvp_wait"?oRole:currentPhase==="setup"?null:role;
      st[role]={...st[role],act:gs.pAct,bench:gs.pBench,hand:gs.ph,deck:gs.pd,grave:gs.pg,ko:gs.pko,buff:gs.pBuff,setupDone:pvpSetupDone.current,autoEnd,lastSeen:Date.now()};
      st[oRole]={...st[oRole],act:gs.eAct,bench:gs.eBench,hand:gs.eh,deck:gs.ed,grave:gs.eg,ko:gs.eko,buff:gs.eBuff};
      await storage.set(PVP_M+pvpMatch,JSON.stringify(st),true);
    }catch(e){}
  },[pvpMatch,pvpRole]);

  /* PVP: Poll for opponent's actions */
  const pvpLastState=useRef("");
  useEffect(()=>{
    if(!pvp||!pvpMatch||pvpMatch==="ai")return;
    if(phase!=="pvp_wait"&&phase!=="setup")return;
    const poll=async()=>{
      if(phase==="setup"&&!pvpSetupDone.current)return;
      try{
        const r=await storage.get(PVP_M+pvpMatch,true);
        if(!r)return;
        if(r.value===pvpLastState.current)return;
        pvpLastState.current=r.value;
        const st=JSON.parse(r.value);
        const me=st[pvpRole],opp=st[pvpRole==="p1"?"p2":"p1"];
        /* Check setup phase */
        if(phase==="setup"&&pvpSetupDone.current){
          if(opp.setupDone&&opp.act){
            const myMw=me.act?.mw||999,oppMw=opp.act?.mw||999;
            const iFirst=myMw<=oppMw;
            setPlayerFirst(iFirst);
            setG(p=>({...p,eAct:opp.act,eBench:opp.bench,eh:opp.hand,ed:opp.deck,eg:opp.grave,eko:opp.ko,eBuff:opp.buff||BUFF0()}));
            flash(`${me.act?.name||"?"}(${myMw}kDa) vs ${opp.act?.name||"?"}(${oppMw}kDa) ‚Üí ${iFirst?"„ÅÇ„Å™„Åü„ÅåÂÖàÊîªÔºÅ":"Áõ∏Êâã„ÅåÂÖàÊîª‚Ä¶"}`);
            setTurn(1);
            if(iFirst){setPhase("main");}
            else{setPhase("pvp_wait");}
          }
          return;
        }
        /* Winner detected */
        if(st.winner){
          setG({pAct:me.act,pBench:me.bench,ph:me.hand,pd:me.deck,pg:me.grave,pko:me.ko,
            eAct:opp.act,eBench:opp.bench,eh:opp.hand,ed:opp.deck,eg:opp.grave,eko:opp.ko,
            pBuff:me.buff||BUFF0(),eBuff:opp.buff||BUFF0(),ipt:false});
          setTurn(st.turn);
          setWinner(st.winner===pvpRole?"player":"enemy");
          return;
        }
        /* Opponent finished their turn ‚Üí my turn now */
        if(st.currentTurn===pvpRole){
          if(opp.autoEnd){pvpOppIdle.current++;}else{pvpOppIdle.current=0;}
          if(pvpOppIdle.current>=2){
            setPvpForfeit("idle");setWinner("player");return;
          }
          setG({pAct:me.act,pBench:me.bench,ph:me.hand,pd:me.deck,pg:me.grave,pko:me.ko,
            eAct:opp.act,eBench:opp.bench,eh:opp.hand,ed:opp.deck,eg:opp.grave,eko:opp.ko,
            pBuff:me.buff||BUFF0(),eBuff:opp.buff||BUFF0(),ipt:true});
          setTurn(st.turn);
          setPhase("main");
          return;
        }
        /* Check opponent heartbeat during pvp_wait */
        if(phase==="pvp_wait"){
          try{
            const oRole=pvpRole==="p1"?"p2":"p1";
            const hb=await storage.get("pvp:hb:"+pvpMatch+":"+oRole,true);
            if(hb){const age=Date.now()-Number(hb.value);
              if(age>15000){setPvpForfeit("disconnect");setWinner("player");return;}
            }
          }catch(e){}
        }
      }catch(e){}
    };
    const iv=setInterval(poll,1200);
    return()=>clearInterval(iv);
  },[pvp,pvpMatch,pvpRole,phase,flash]);

  const pvpEndTurn=useCallback(async(autoEnd=false)=>{
    if(!pvp||!pvpMatch)return;
    if(pvpMatch==="ai"){setG(p=>({...p,ipt:false}));setPhase("enemy");flash("Áõ∏Êâã„ÅÆ„Çø„Éº„É≥‚Ä¶");return;}
    const newTurn=turn+1;setTurn(newTurn);
    setG(p=>{
      pvpWriteState(p,"pvp_wait",newTurn,winner,autoEnd);
      return{...p,ipt:false};
    });
    setPhase("pvp_wait");flash(autoEnd?"‚è∞ „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÔºÅ„Çø„Éº„É≥ÁµÇ‰∫Ü":"‚è≥ Áõ∏Êâã„ÅÆ„Çø„Éº„É≥‚Ä¶");
  },[pvp,pvpMatch,pvpWriteState,turn,winner,flash]);

  const pvpCancelMatch=useCallback(()=>{
    pvpCleanup();setScreen("title");setPvp(false);setPvpMatch(null);
  },[pvpCleanup]);

  /* PVP: Write state when winner is determined */
  useEffect(()=>{
    if(!pvp||!pvpMatch||pvpMatch==="ai"||!winner||!g)return;
    const w=winner==="player"?pvpRole:(pvpRole==="p1"?"p2":"p1");
    pvpWriteState(g,"done",turn,w);
  },[pvp,pvpMatch,pvpRole,winner,g,turn,pvpWriteState]);
  useEffect(()=>{
    if(!winner||resultAwarded.current)return;
    if(!pvp&&!diff)return;
    resultAwarded.current=true;
    (async()=>{
      const d=pvp?(pvpMatch==="ai"?"normal":"hard"):diff;
      const c=await awardResult(winner==="player",d);setCoinReward(c||0);
    })();
  },[winner,diff,pvp,pvpMatch,awardResult]);

  /* Drag handlers - distinguish tap (<10px) from drag (>50px vertical) */
  const onDS=useCallback((cardUid,x,y)=>{
    if(phase!=="main"||!g?.ipt||winner)return;
    if(!g.ph.some(c=>c.uid===cardUid))return;
    setDrag({uid:cardUid,sx:x,sy:y,cx:x,cy:y,moved:false});
  },[phase,g,winner]);
  const onDM=useCallback((x,y)=>{if(drag){const dx=Math.abs(x-drag.sx)+Math.abs(y-drag.sy);setDrag(p=>({...p,cx:x,cy:y,moved:p.moved||dx>8}));}},[drag]);
  const onDE=useCallback(()=>{
    if(!drag||!g)return;
    const c=g.ph.find(x=>x.uid===drag.uid);
    if(!c){setDrag(null);return;}
    /* Tap = show detail */
    if(!drag.moved){setDrag(null);setDetail(c);return;}
    const dy=drag.sy-drag.cy;
    if(dy>50){
      /* Support cards = instant spell: apply effect ‚Üí graveyard */
      if(c.isSupport){
        const eff=SEFF[c.id];
        if(!eff){flash("ÂäπÊûú„Å™„Åó");setDrag(null);return;}
        setG(p=>{
          let np={...p,ph:p.ph.filter(x=>x.uid!==c.uid),pg:[...p.pg,c]};
          const allF=[np.pAct,...np.pBench].filter(Boolean);
          switch(eff.type){
            case"energy":/* Grant energy to active */
              if(np.pAct){const es=[...np.pAct.es];for(let i=0;i<eff.n;i++)es.push(eff.eid);np.pAct={...np.pAct,es};}
              flash(`‚ö° ${c.name}: ${eff.desc}`);break;
            case"draw":/* Draw cards from deck or graveyard */
              if(eff.from==="grave"){const revived=np.pg.slice(-eff.n);np={...np,ph:[...np.ph,...revived],pg:np.pg.slice(0,-eff.n)};}
              else{const drawn=np.pd.slice(0,eff.n);np={...np,ph:[...np.ph,...drawn],pd:np.pd.slice(eff.n)};}
              flash(`üì• ${c.name}: ${eff.n}Êûö„Ç≤„ÉÉ„ÉàÔºÅ`);break;
            case"atkMul":np={...np,pBuff:{...np.pBuff,atkMul:np.pBuff.atkMul*eff.n}};flash(`‚öî ${c.name}: ÊîªÊíÉÂäõ${eff.n}ÂÄçÔºÅ`);break;
            case"pierce":np={...np,pBuff:{...np.pBuff,pierce:true}};flash(`üó° ${c.name}: Èò≤Âæ°ÁÑ°Ë¶ñÔºÅ`);break;
            case"shield":np={...np,pBuff:{...np.pBuff,shield:np.pBuff.shield+eff.n}};flash(`üõ° ${c.name}: Ë¢´„ÉÄ„É°-${eff.n}ÔºÅ`);break;
            case"heal":/* Heal active */
              if(np.pAct){np.pAct={...np.pAct,dmg:Math.max(0,np.pAct.dmg-eff.n)};}
              flash(`üíö ${c.name}: HP${eff.n}ÂõûÂæ©ÔºÅ`);break;
            case"breakBind":/* Break one enemy binding */
              if(np.eAct&&np.eAct.bw2.length){
                const eAllF=[np.eAct,...np.eBench].filter(Boolean);
                const partnerId=np.eAct.bw2[0];
                const partner=eAllF.find(x=>x.uid===partnerId);
                const rem=x=>({...x,bw2:(x.bw2||[]).filter(u=>u!==partnerId&&u!==np.eAct.uid)});
                /* Partner goes back to enemy deck */
                if(partner){
                  np.eBench=np.eBench.filter(x=>x.uid!==partnerId);
                  np.ed=shuffle([...np.ed,{...partner,dmg:0,bw2:[],es:[]}]);
                }
                np.eAct=rem(np.eAct);np.eBench=np.eBench.map(rem);
                flash(`üîì ${c.name}: Áõ∏Êâã„ÅÆÁµêÂêàËß£Èô§ÔºÅ${partner?partner.name:""}‚ÜíÂ±±Êú≠`);
              }else{flash(`üîì ${c.name}: Ëß£Èô§„Åô„ÇãÁµêÂêà„Å™„Åó`);}
              break;
            case"revive":/* Revive from graveyard */
              if(np.pg.length){const rev=np.pg[np.pg.length-1];np={...np,ph:[...np.ph,{...rev,dmg:0,bw2:[],es:[]}],pg:np.pg.slice(0,-1)};flash(`‚ôª ${c.name}: ${rev.name}Âæ©Ê¥ªÔºÅ`);}
              else flash(`‚ôª ${c.name}: Âæ©Ê¥ªÂØæË±°„Å™„Åó`);break;
            default:flash(`‚öô ${c.name} ‰ΩøÁî®`);
          }
          return np;
        });
        setDrag(null);return;
      }
      /* Support cards can NEVER go to active or bench */
      if(c.isSupport){flash("‚öô „Çµ„Éù„Éº„Éà„ÅØËÉΩÂäõ‰ªò‰∏é„ÅÆ„ÅøÔºÅ");setDrag(null);return;}
      if(!g.pAct){
        setG(p=>({...p,ph:p.ph.filter(x=>x.uid!==c.uid),pAct:{...c,tp:turn}}));
        flash(`${c.name} „Éê„Éà„É´Â†¥„Å∏ÔºÅ`);
      }else if(g.pBench.length<3){
        const nc={...c,tp:turn};
        setG(p=>{
          const np={...p,ph:p.ph.filter(x=>x.uid!==c.uid),pBench:[...p.pBench,nc]};
          const allField=[np.pAct,...np.pBench].filter(Boolean);
          for(const f of allField){
            if(f.uid!==nc.uid&&canBind(nc,f)&&!nc.bw2.includes(f.uid)){
              const u=x=>{if(x.uid===nc.uid)return{...x,bw2:[...x.bw2,f.uid]};if(x.uid===f.uid)return{...x,bw2:[...x.bw2,nc.uid]};return x;};
              const bp=getBindBonus(np.pAct||nc,[np.pAct,...np.pBench].filter(Boolean));
              flash(`üîó ${nc.name}‚áî${f.name} ÁµêÂêàÔºÅ ÊîªÊíÉ+${bp}`);
              return{...np,pAct:np.pAct?u(np.pAct):null,pBench:np.pBench.map(u)};
            }
          }
          flash(`${c.name} „Éô„É≥„ÉÅ„Å∏ÔºÅ`);
          return np;
        });
      }else{flash("„Éô„É≥„ÉÅ„Åå„ÅÑ„Å£„Å±„ÅÑ");}
    }
    setDrag(null);
  },[drag,g,turn,flash,eChoice,winner,phase]);
  const gp=e=>e.touches?[e.touches[0].clientX,e.touches[0].clientY]:[e.clientX,e.clientY];

  /* Start game */
  const start=useCallback(d=>{
    setDiff(d);
    if(!pvp){setPvp(false);setPvpMatch(null);setPvpRole(null);setPvpOppInfo(null);}
    const pD=mkDeck(),eD=mkDeck();
    /* Ensure at least 2 protein (non-support) cards in each starting hand */
    const drawHand=(deck)=>{
      const proteins=[],supports=[];
      for(let i=0;i<deck.length;i++){
        if(!deck[i].isSupport&&proteins.length<2)proteins.push(i);
        else if(deck[i].isSupport&&supports.length<1)supports.push(i);
        if(proteins.length>=2&&supports.length+proteins.length>=3)break;
      }
      /* pick 3: 2+ proteins guaranteed */
      const idxs=[...proteins];
      if(idxs.length<3){for(const si of supports){if(idxs.length>=3)break;idxs.push(si);}}
      /* fill rest from deck if needed */
      for(let i=0;idxs.length<3&&i<deck.length;i++){if(!idxs.includes(i))idxs.push(i);}
      idxs.sort((a,b)=>a-b);
      const hand=idxs.map(i=>deck[i]);
      const rest=deck.filter((_,i)=>!idxs.includes(i));
      return[hand,rest];
    };
    let[pH,pDr]=drawHand(pD);
    let[eH,eDr]=drawHand(eD);
    /* Enemy active = first non-support in hand */
    const eActIdx=eH.findIndex(c=>!c.isSupport);
    const eAct=eH[eActIdx>=0?eActIdx:0];
    eH=eH.filter(c=>c.uid!==eAct.uid);
    setG({pAct:null,pBench:[],ph:pH,pd:pDr,pg:[],pko:0,
      eAct,eBench:[],eh:eH,ed:eDr,eg:[],eko:0,
      pBuff:BUFF0(),eBuff:BUFF0(),
      pe:{glucose:0,atp:0,ca2:0,electrical:0,gtp:0},
      ee:{glucose:0,atp:0,ca2:0,electrical:0,gtp:0},ipt:true});
    turnDrawn.current=0;enemyRunning.current=false;resultAwarded.current=false;setCoinReward(0);setTurn(0);setPhase("setup");setWinner(null);setDetail(null);setScreen("game");
    flash("„Éê„Éà„É´Â†¥„Å´Âá∫„Åô„Ç´„Éº„Éâ„ÇíÈÅ∏„Åº„ÅÜÔºÅ");
  },[flash]);

  /* Pick first active ‚Üí determines turn order by MW */
  const pickActive=useCallback(uid=>{
    if(phase!=="setup")return;
    const c=g.ph.find(x=>x.uid===uid);
    if(!c||c.isSupport)return;
    /* PVP: write setup state and wait for opponent */
    if(pvp&&pvpMatch&&pvpMatch!=="ai"){
      pvpSetupDone.current=true;
      setG(p=>{
        const np={...p,ph:p.ph.filter(x=>x.uid!==uid),pAct:{...c,tp:0}};
        /* Write setup state */
        (async()=>{
          try{
            const r=await storage.get(PVP_M+pvpMatch,true);
            if(!r)return;
            const st=JSON.parse(r.value);
            st.v=++pvpVer.current;
            st[pvpRole]={...st[pvpRole],act:{...c,tp:0},hand:np.ph,setupDone:true};
            const opp=st[pvpRole==="p1"?"p2":"p1"];
            await storage.set(PVP_M+pvpMatch,JSON.stringify(st),true);
            /* If opponent already picked, determine turn order */
            if(opp.setupDone&&opp.act){
              const myMw=c.mw,oppMw=opp.act.mw||999;
              const iFirst=myMw<=oppMw;
              setPlayerFirst(iFirst);
              setG(p2=>({...p2,eAct:opp.act,eBench:opp.bench,eh:opp.hand,ed:opp.deck,eg:opp.grave,eko:opp.ko,eBuff:opp.buff||BUFF0()}));
              flash(`${c.name}(${myMw}kDa) vs ${opp.act.name||"?"}(${oppMw}kDa) ‚Üí ${iFirst?"„ÅÇ„Å™„Åü„ÅåÂÖàÊîªÔºÅ":"Áõ∏Êâã„ÅåÂÖàÊîª‚Ä¶"}`);
              setTurn(1);setPhase(iFirst?"main":"pvp_wait");
            }else{
              flash(`${c.name}„Çí„Çª„ÉÉ„ÉàÔºÅ Áõ∏Êâã„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô‚Ä¶`);
            }
          }catch(e){}
        })();
        return np;
      });
      return;
    }
    /* Normal AI mode */
    const eMw=g.eAct?.mw||999;
    const pFirst=c.mw<=eMw; /* lighter = goes first */
    setPlayerFirst(pFirst);
    setG(p=>({...p,ph:p.ph.filter(x=>x.uid!==uid),pAct:{...c,tp:0}}));
    flash(`${c.name}(${c.mw}kDa) vs ${g.eAct?.name||"?"}(${eMw}kDa) ‚Üí ${pFirst?"„ÅÇ„Å™„Åü„ÅåÂÖàÊîªÔºÅ":"Áõ∏Êâã„ÅåÂÖàÊîª‚Ä¶"}`);
    setTurn(1);
    if(pFirst){setPhase("main");}
    else{setPhase("enemy");}
  },[phase,g,flash,pvp,pvpMatch,pvpRole]);

  /* Turn start: draw 1 + get random energy (runs when main phase begins) */
  const turnDrawn=useRef(0);
  useEffect(()=>{
    if(!g||phase!=="main"||!g.ipt||winner)return;
    if(turnDrawn.current>=turn)return; /* already drew this turn */
    turnDrawn.current=turn;
    setAttacked(false);
    /* Draw 1 + reset buffs in single setG to avoid double-trigger */
    setG(p=>{
      let np={...p,pBuff:BUFF0()};
      if(np.pd.length){np={...np,ph:[...np.ph,np.pd[0]],pd:np.pd.slice(1)};}
      return np;
    });
    const e=pick(EN);
    setEChoice(e);
    flash(`${e.n}„Çí„Ç≤„ÉÉ„ÉàÔºÅ „Å§„Åë„Åü„ÅÑ„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„ÉóÔºàÂæå„Åß„ÇÇOKÔºâ`);
  },[phase,g?.ipt,winner,turn]);

  /* Attach energy to any field card - doesn't end main phase */
  const attachE=useCallback(uid=>{
    if(!eChoice)return;
    setG(p=>{
      const u=c=>c.uid===uid?{...c,es:[...c.es,eChoice.id]}:c;
      return{...p,pAct:p.pAct?u(p.pAct):null,pBench:p.pBench.map(u)};
    });
    flash("‚ö° „ÉÅ„É£„Éº„Ç∏ÔºÅ");setEChoice(null);/* stay in main phase */
  },[eChoice,flash]);

  /* Attack using a specific skill from the bind group */
  const doAttack=useCallback((skillCard)=>{
    if(!g?.pAct||!g.eAct||phase!=="main"||!g.ipt||attacked)return;
    const allPField=[g.pAct,...g.pBench].filter(Boolean);
    const sc=allPField.find(c=>c.uid===skillCard.uid);
    if(!sc)return;
    /* Check energy on the active card's pool (all bound cards share energy) */
    const group=getBindGroup(g.pAct,allPField);
    const groupEs=group.flatMap(c=>c.es);
    if(!canPay(groupEs,sc.ae)){flash(`„Ç®„Éç„É´„ÇÆ„Éº‰∏çË∂≥ÔºÅ`);return;}
    const bindBonus=getBindBonus(g.pAct,[g.pAct,...g.pBench].filter(Boolean));
    let dmg=Math.round((sc.ad+bindBonus)*(g.pBuff?.atkMul||1));
    /* Enemy shield buff reduces incoming damage (unless pierce) */
    if(g.eBuff?.shield&&!g.pBuff?.pierce)dmg=Math.max(1,dmg-(g.eBuff.shield||0));
    /* Pay energy from group members (only deducts cost, keeps the rest) */
    setG(p=>{
      const allF=[p.pAct,...p.pBench].filter(Boolean);
      const grp=getBindGroup(p.pAct,allF);
      const grpUids=new Set(grp.map(c=>c.uid));
      const paidGrp=payGroupCost(grp,sc.ae);
      /* Apply updated energy back to state */
      const esMap={};paidGrp.forEach(c=>{esMap[c.uid]=c.es;});
      const applyEs=c=>grpUids.has(c.uid)?{...c,es:esMap[c.uid]||[]}:c;
      let np={...p,pAct:p.pAct?applyEs(p.pAct):null,pBench:p.pBench.map(applyEs)};

      /* Deal damage to enemy active */
      const eAllF=[np.eAct,...np.eBench].filter(Boolean);
      const eGrpHp=getGroupCurrentHP(np.eAct,eAllF);
      const newGrpHp=Math.max(0,eGrpHp-dmg);
      if(newGrpHp<=0){
        /* KO: entire bind group dies together ‚Üí all to graveyard, counts as 1 KO */
        const eGrp=getBindGroup(np.eAct,eAllF);
        const koUids=new Set(eGrp.map(c=>c.uid));
        const nko=np.eko+1;
        flash(`üí• ${np.eAct.name}${eGrp.length>1?"„Ç∞„É´„Éº„ÉóÂÖ®ÊªÖ":"ÊíÉÁ†¥"}ÔºÅ(${nko}/${KO_TO_WIN})`);
        if(nko>=KO_TO_WIN){setTimeout(()=>setWinner("player"),400);}
        /* All group members ‚Üí graveyard */
        const dead=eGrp.map(c=>({...c,dmg:c.hp,bw2:[],es:[]}));
        const newEBench=np.eBench.filter(c=>!koUids.has(c.uid));
        const clr=c=>({...c,bw2:(c.bw2||[]).filter(u=>!koUids.has(u))});
        return{...np,eAct:newEBench.length?clr(newEBench.shift()):null,
          eBench:newEBench.map(clr),eko:nko,
          eg:[...np.eg,...dead]};
      }else{
        /* Distribute damage to enemy active */
        const ea={...np.eAct,dmg:np.eAct.dmg+dmg};
        return{...np,eAct:ea};
      }
    });
    setHitAnim("e");setTimeout(()=>setHitAnim(null),500);
    setDmgFloat(dmg);setTimeout(()=>setDmgFloat(null),900);
    flash(`‚öî ${sc.an}ÔºÅ ${dmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ`);
    setAttacked(true);
  },[g,phase,flash,attacked]);

  const swapActive=useCallback(uid=>{
    if(phase!=="main"||!g.ipt||attacked)return;
    const bc=g.pBench.find(x=>x.uid===uid);
    if(!bc||bc.isSupport)return;
    /* Cannot swap if bench card is bound to active */
    if(g.pAct&&(g.pAct.bw2||[]).includes(uid)){flash("üîó ÁµêÂêà‰∏≠„ÅØ‰∫§‰ª£„Åß„Åç„Åæ„Åõ„Çì");return;}
    setG(p=>({...p,pAct:bc,pBench:p.pAct?[...p.pBench.filter(x=>x.uid!==uid),p.pAct]:p.pBench.filter(x=>x.uid!==uid)}));
    setAttacked(true);
    flash(`üîÑ ${bc.name} ‰∫§‰ª£ÔºÅÔºàÊîªÊíÉÊ®©Ê∂àË≤ªÔºâ`);
  },[g,phase,flash,attacked]);

  /* Voluntary unbind: card returns to hand */
  const unbindCard=useCallback(uid=>{
    if(phase!=="main"||!g?.ipt)return;
    setG(p=>{
      const allF=[p.pAct,...p.pBench].filter(Boolean);
      const card=allF.find(c=>c.uid===uid);
      if(!card||!card.bw2.length)return p;
      /* Remove bw2 refs from partners */
      const rem=c=>{if(!c)return c;return{...c,bw2:(c.bw2||[]).filter(u=>u!==uid)};};
      /* Remove card from field, clear its bw2, return to hand */
      const returned={...card,bw2:[],es:[],dmg:0};
      let np={...p,
        pAct:p.pAct?.uid===uid?null:rem(p.pAct),
        pBench:p.pBench.filter(c=>c.uid!==uid).map(rem),
        ph:[...p.ph,returned]};
      /* If active was removed, promote from bench */
      if(!np.pAct&&np.pBench.length){
        const next=np.pBench[0];
        np={...np,pAct:next,pBench:np.pBench.slice(1)};
      }
      return np;
    });
    flash("üîì ÁµêÂêàËß£Èô§ ‚Üí ÊâãÊú≠„Å∏ÔºàÊîªÊíÉÊ®©Ê∂àË≤ªÔºâ");
    setAttacked(true);/* Unbinding costs your attack */
  },[g,phase,flash]);

  const endTurn=useCallback((autoEnd=false)=>{
    if(pvp&&pvpMatch&&pvpMatch!=="ai"){pvpEndTurn(autoEnd);return;}
    setG(p=>({...p,ipt:false}));setPhase("enemy");flash(autoEnd?"‚è∞ „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÔºÅ":"Áõ∏Êâã„ÅÆ„Çø„Éº„É≥‚Ä¶");
  },[flash,pvp,pvpMatch,pvpEndTurn]);

  /* 20-second turn timer */
  const endTurnRef=useRef(endTurn);
  endTurnRef.current=endTurn;
  useEffect(()=>{
    if(phase!=="main"||winner)return;
    setTurnClock(20);
    const iv=setInterval(()=>{
      setTurnClock(p=>{
        if(p<=1){setTimeout(()=>endTurnRef.current(true),0);return 20;}
        return p-1;
      });
    },1000);
    return()=>clearInterval(iv);
  },[phase,winner]);

  /* PVP heartbeat: write lastSeen every 3s */
  useEffect(()=>{
    if(!pvp||!pvpMatch||pvpMatch==="ai"||winner)return;
    const hbKey="pvp:hb:"+pvpMatch+":"+pvpRole;
    const write=async()=>{try{await storage.set(hbKey,String(Date.now()),true);}catch(e){}};
    write();
    const iv=setInterval(write,3000);
    return()=>{clearInterval(iv);storage.delete(hbKey,true).catch(()=>{});};
  },[pvp,pvpMatch,pvpRole,winner]);

  /* Enemy AI turn (skipped in PvP online mode) */
  const enemyRunning=useRef(false);
  useEffect(()=>{
    if(phase!=="enemy"||!g||winner)return;
    if(pvp&&pvpMatch&&pvpMatch!=="ai")return;/* PvP online = poll instead */
    if(enemyRunning.current)return;
    enemyRunning.current=true;
    const s=DIFF[diff];
    (async()=>{
      const w=ms=>new Promise(r=>setTimeout(r,ms));
      await w(s.ai);
      /* Enemy draws */
      setG(p=>{if(!p.ed.length)return p;return{...p,eh:[...p.eh,p.ed[0]],ed:p.ed.slice(1)};});
      /* Enemy gets energy */
      const et=pick(EN);
      setG(p=>{
        if(p.eAct)return{...p,eAct:{...p.eAct,es:[...p.eAct.es,et.id]}};
        return p;
      });
      await w(s.ai*0.3);
      /* If enemy has no active, promote from bench or hand */
      setG(p=>{
        if(p.eAct)return p;
        if(p.eBench.length){const[next,...rest]=p.eBench;return{...p,eAct:next,eBench:rest};}
        const playable=p.eh.filter(c=>!c.isSupport);
        if(playable.length){const pick0=playable[0];return{...p,eAct:{...pick0,tp:turn},eh:p.eh.filter(c=>c.uid!==pick0.uid)};}
        return p;
      });
      await w(s.ai*0.2);
      /* Reset enemy buffs */
      setG(p=>({...p,eBuff:BUFF0()}));
      /* Enemy places cards (no energy cost) */
      setG(p=>{
        if(!p.eh.length)return p;
        const playable=p.eh.filter(c=>!c.isSupport);
        const supports=p.eh.filter(c=>c.isSupport);
        let np={...p};
        /* Place a non-support to bench */
        if(playable.length&&np.eBench.length<3&&Math.random()<(0.4+s.sm*0.4)){
          const tp=Math.random()<s.sm?playable.reduce((b,c)=>c.mw>b.mw?c:b,playable[0]):pick(playable);
          np={...np,eh:np.eh.filter(c=>c.uid!==tp.uid),eBench:[...np.eBench,{...tp,tp:turn}]};
        }
        /* Play support cards as instant spells */
        if(supports.length&&Math.random()<(0.3+s.sm*0.4)){
          const sp=pick(supports);
          const eff=SEFF[sp.id];
          np={...np,eh:np.eh.filter(c=>c.uid!==sp.uid),eg:[...np.eg,sp]};
          if(eff){
            flash(`ü§ñ‚öô ${sp.name}: ${eff.desc}`);
            switch(eff.type){
              case"energy":if(np.eAct){const es=[...np.eAct.es];for(let i=0;i<eff.n;i++)es.push(eff.eid);np.eAct={...np.eAct,es};}break;
              case"draw":if(np.ed.length){const n=Math.min(eff.n,np.ed.length);np={...np,eh:[...np.eh,...np.ed.slice(0,n)],ed:np.ed.slice(n)};}break;
              case"atkMul":np={...np,eBuff:{...np.eBuff,atkMul:np.eBuff.atkMul*eff.n}};break;
              case"pierce":np={...np,eBuff:{...np.eBuff,pierce:true}};break;
              case"shield":np={...np,eBuff:{...np.eBuff,shield:np.eBuff.shield+eff.n}};break;
              case"heal":if(np.eAct)np.eAct={...np.eAct,dmg:Math.max(0,np.eAct.dmg-eff.n)};break;
              case"breakBind":/* Break player binding */
                if(np.pAct&&np.pAct.bw2.length){
                  const pid=np.pAct.bw2[0];const partner=[...np.pBench].find(x=>x.uid===pid);
                  const rem=x=>({...x,bw2:(x.bw2||[]).filter(u=>u!==pid&&u!==np.pAct.uid)});
                  if(partner){np.pBench=np.pBench.filter(x=>x.uid!==pid);np.pd=shuffle([...np.pd,{...partner,dmg:0,bw2:[],es:[]}]);}
                  np.pAct=rem(np.pAct);np.pBench=np.pBench.map(rem);
                }break;
              case"revive":if(np.eg.length){const rev=np.eg[np.eg.length-1];np={...np,eh:[...np.eh,{...rev,dmg:0,bw2:[],es:[]}],eg:np.eg.slice(0,-1)};}break;
            }
          }
        }
        return np;
      });
      await w(s.ai*0.3);
      /* Enemy tries bindings */
      setG(p=>{
        const allF=[p.eAct,...p.eBench].filter(Boolean);
        for(const a of allF)for(const b of allF){
          if(a.uid!==b.uid&&!a.bw2.includes(b.uid)&&canBind(a,b)&&Math.random()<s.sm){
            const u=c=>{if(c.uid===a.uid)return{...c,bw2:[...c.bw2,b.uid]};if(c.uid===b.uid)return{...c,bw2:[...c.bw2,a.uid]};return c;};
            return{...p,eAct:p.eAct?u(p.eAct):null,eBench:p.eBench.map(u)};
          }
        }
        return p;
      });
      await w(s.ai*0.3);
      /* Enemy attacks */
      setG(p=>{
        if(!p.eAct||!p.pAct)return p;
        const eAllF=[p.eAct,...p.eBench].filter(Boolean);
        const skills=getGroupSkills(p.eAct,eAllF).filter(s2=>s2.ad>0);
        const groupEs=getBindGroup(p.eAct,eAllF).flatMap(c=>c.es);
        const usable=skills.filter(s2=>canPay(groupEs,s2.ae));
        if(!usable.length)return p;
        const chosen=Math.random()<s.sm?usable.reduce((b,s2)=>s2.ad>b.ad?s2:b,usable[0]):pick(usable);
        const eBindBonus=getBindBonus(p.eAct,[p.eAct,...p.eBench].filter(Boolean));
        let dmg=Math.round((chosen.ad+eBindBonus)*(p.eBuff?.atkMul||1));
        if(p.pBuff?.shield&&!p.eBuff?.pierce)dmg=Math.max(1,dmg-(p.pBuff.shield||0));
        setHitAnim("p");setTimeout(()=>setHitAnim(null),500);
        setDmgFloat(-dmg);setTimeout(()=>setDmgFloat(null),900);
        flash(`ü§ñ ${chosen.an}ÔºÅ ${dmg}„ÉÄ„É°`);
        /* Pay energy (only deducts cost) */
        const grp=getBindGroup(p.eAct,eAllF);
        const grpUids=new Set(grp.map(c=>c.uid));
        const paidGrp=payGroupCost(grp,chosen.ae);
        const esMap={};paidGrp.forEach(c=>{esMap[c.uid]=c.es;});
        const applyEs=c=>grpUids.has(c.uid)?{...c,es:esMap[c.uid]||[]}:c;
        let np={...p,eAct:applyEs(p.eAct),eBench:p.eBench.map(applyEs)};
        /* Deal damage */
        const pAllF=[np.pAct,...np.pBench].filter(Boolean);
        const pGrpHp=getGroupCurrentHP(np.pAct,pAllF);
        const newHp=Math.max(0,pGrpHp-dmg);
        if(newHp<=0){
          const pGrp=getBindGroup(np.pAct,pAllF);
          const koUids=new Set(pGrp.map(c=>c.uid));
          const nko=np.pko+1;
          flash(`üòµ ${np.pAct.name}${pGrp.length>1?"„Ç∞„É´„Éº„ÉóÂÖ®ÊªÖ":"ÊíÉÁ†¥"}ÔºÅ(${nko}/${KO_TO_WIN})`);
          if(nko>=KO_TO_WIN){setTimeout(()=>setWinner("enemy"),400);}
          /* All group members ‚Üí graveyard, counts as 1 KO */
          const dead=pGrp.map(c=>({...c,dmg:c.hp,bw2:[],es:[]}));
          const newPBench=np.pBench.filter(c=>!koUids.has(c.uid));
          const clr=c=>({...c,bw2:(c.bw2||[]).filter(u=>!koUids.has(u))});
          return{...np,pAct:newPBench.length?clr(newPBench.shift()):null,
            pBench:newPBench.map(clr),pko:nko,
            pg:[...np.pg,...dead]};
        }
        return{...np,pAct:{...np.pAct,dmg:np.pAct.dmg+dmg}};
      });
      await w(s.ai*0.4);
      enemyRunning.current=false;
      setTurn(t=>t+1);setG(p=>({...p,ipt:true}));setPhase("main");
    })();
  },[phase,diff,turn,winner,g,flash]);

  const isDragging=!!drag;
  const dragCard=drag?g?.ph.find(c=>c.uid===drag.uid):null;
  const dragDy=drag?(drag.sy-drag.cy):0;
  /* Which hand cards can bind with field cards? */
  const pAllField=g?[g.pAct,...(g.pBench||[])].filter(Boolean):[];
  /* Hand cards that can bind with field cards */
  const canBindIds=new Set();
  if(g)g.ph.forEach(hc=>{if(!hc.isSupport&&pAllField.some(fc=>canBind(hc,fc)))canBindIds.add(hc.uid);});
  /* Field cards that have unbound potential partners on field */
  const fieldBindableIds=new Set();
  for(const a of pAllField)for(const b of pAllField){
    if(a.uid!==b.uid&&canBind(a,b)&&!a.bw2.includes(b.uid)){fieldBindableIds.add(a.uid);fieldBindableIds.add(b.uid);}
  }
  /* When dragging, which field cards can the dragged card bind with? */
  const dragTargetIds=new Set();
  if(drag){const dc=g?.ph.find(x=>x.uid===drag.uid);if(dc)pAllField.forEach(fc=>{if(canBind(dc,fc))dragTargetIds.add(fc.uid);});}
  /* Available attack skills for current active */
  const pGroupSkills=g?.pAct?getGroupSkills(g.pAct,pAllField).filter(s2=>s2.ad>0):[];
  const pGroupEs=g?.pAct?getBindGroup(g.pAct,pAllField).flatMap(c=>c.es):[];
  const pBindBonus=g?.pAct?getBindBonus(g.pAct,pAllField):0;
  /* ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê */
  const[regName,setRegName]=useState("");
  const[regAvatar,setRegAvatar]=useState("cell");
  const registerAcct=useCallback(async()=>{
    if(!regName.trim())return;
    const na={name:regName.trim(),avatar:regAvatar,coins:0,wins:0,losses:0,unlocked:["cell","micro"]};
    await saveAcct(na);setScreen("title");
  },[regName,regAvatar,saveAcct]);
  const buyAvatar=useCallback(async(av)=>{
    if(!acct||acct.coins<av.cost)return;
    if((acct.unlocked||[]).includes(av.id))return;
    const newUnlocked=[...(acct.unlocked||[]),av.id];
    const na={...acct,coins:acct.coins-av.cost,unlocked:newUnlocked};
    /* Check if all buyable avatars now owned ‚Üí grant complete avatar */
    if(hasAllAvatars(newUnlocked)&&!newUnlocked.includes(COMPLETE_AVATAR.id)){
      na.unlocked=[...na.unlocked,COMPLETE_AVATAR.id];
      na.avatar=COMPLETE_AVATAR.id;
      await saveAcct(na);setShopMsg(`üéä ÂÖ®„Ç¢„Éê„Çø„Éº„Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅ ${COMPLETE_AVATAR.em} ${COMPLETE_AVATAR.name}„ÇíÁç≤ÂæóÔºÅ`);setTimeout(()=>setShopMsg(null),4000);
    }else{
      await saveAcct(na);setShopMsg(`${av.em} ${av.name}„Çí„Ç≤„ÉÉ„ÉàÔºÅ`);setTimeout(()=>setShopMsg(null),2000);
    }
  },[acct,saveAcct]);
  const equipAvatar=useCallback(async(av)=>{
    const aid=av.id||av;
    if(!acct||(acct.unlocked||[]).indexOf(aid)===-1)return;
    await saveAcct({...acct,avatar:aid});
  },[acct,saveAcct]);
  const getAvatarEm=(id)=>{
    if(id===COMPLETE_AVATAR.id)return COMPLETE_AVATAR.em;
    return (AVATARS.find(a=>a.id===id)||AVATARS[0]).em;
  };
  const hasAllAvatars=(unlocked)=>BUYABLE_IDS.every(id=>(unlocked||[]).includes(id));
  /* Avatar border tier: bronze(1/3) ‚Üí silver(2/3) ‚Üí gold+glow(complete) */
  const getAvatarBorder=(unlocked)=>{
    const owned=BUYABLE_IDS.filter(id=>(unlocked||[]).includes(id)).length;
    const total=BUYABLE_IDS.length;
    if(owned>=total)return{border:"3px solid #ffd700",animation:"goldGlow 2s ease infinite",borderRadius:"50%"};
    if(owned>=Math.ceil(total*2/3))return{border:"3px solid #c0c0c0",borderRadius:"50%"};
    if(owned>=Math.ceil(total/3))return{border:"3px solid #cd7f32",borderRadius:"50%"};
    return{};
  };
  /* Render avatar with border */
  const AvatarIcon=({id,unlocked,size=32})=>{
    const em=getAvatarEm(id);const bs=getAvatarBorder(unlocked);
    const hasBorder=!!bs.border;
    return <span style={{fontSize:size,display:"inline-flex",alignItems:"center",justifyContent:"center",
      width:size*1.4,height:size*1.4,...(hasBorder?{...bs,padding:2}:{})}}>{em}</span>;
  };

  if(screen==="loading")return(<div style={{minHeight:"100vh",background:"#f5f0e6",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:F}}><div style={{fontSize:48,animation:"float 2s ease infinite"}}>üß¨</div></div>);

  if(screen==="register")return(
    <React.Fragment><style>{CSS}</style>
    <div style={{minHeight:"100vh",background:"linear-gradient(170deg,#f5f0e6,#ede7db)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:32,fontFamily:F}}>
      <div style={{fontSize:56,animation:"float 3s ease infinite"}}>üß¨</div>
      <h1 style={{fontSize:22,fontWeight:900,color:"#3d3229",marginTop:10}}>Á†îÁ©∂ËÄÖÁôªÈå≤</h1>
      <p style={{fontSize:11,color:"#8b7e6b",marginTop:4}}>ÂêçÂâç„Å®„Ç¢„Éê„Çø„Éº„ÇíÈÅ∏„Çì„Åß„Çπ„Çø„Éº„ÉàÔºÅ</p>
      <input value={regName} onChange={e=>setRegName(e.target.value)} placeholder="„Å™„Åæ„Åà„ÇíÂÖ•Âäõ..." maxLength={12}
        style={{marginTop:24,width:220,padding:"12px 16px",borderRadius:14,border:"2px solid #d4ccc0",fontFamily:F,fontSize:15,fontWeight:700,color:"#3d3229",background:"#faf6f0",outline:"none",textAlign:"center"}}/>
      <div style={{display:"flex",gap:8,marginTop:16,flexWrap:"wrap",justifyContent:"center",maxWidth:280}}>
        {AVATARS.filter(a=>a.cost===0).map(a=>(
          <div key={a.id} onClick={()=>setRegAvatar(a.id)} style={{width:52,height:52,borderRadius:14,border:`3px solid ${regAvatar===a.id?"#c49e5e":"#d4ccc044"}`,background:regAvatar===a.id?"#c49e5e11":"#faf6f0",display:"flex",alignItems:"center",justifyContent:"center",fontSize:28,cursor:"pointer",transition:"all .2s"}}>{a.em}</div>
        ))}
      </div>
      <button onClick={registerAcct} disabled={!regName.trim()}
        style={{marginTop:28,border:"none",borderRadius:16,padding:"14px 40px",fontFamily:F,fontWeight:700,fontSize:16,cursor:regName.trim()?"pointer":"default",background:regName.trim()?"linear-gradient(135deg,#8b9e6b,#6b8e7b)":"#e8e0d4",color:regName.trim()?"#fff":"#b8a99a",boxShadow:regName.trim()?"0 4px 16px rgba(139,158,107,.3)":"none"}}>üî¨ Á†îÁ©∂ÈñãÂßãÔºÅ</button>
    </div></React.Fragment>);

  if(screen==="profile"&&acct){const rk=getRank(acct.wins);const nextRk=RANKS.find(r=>r.min>acct.wins);const ownedBuyable=BUYABLE_IDS.filter(id=>(acct.unlocked||[]).includes(id)).length;return(
    <React.Fragment><style>{CSS}</style>
    <div style={{minHeight:"100vh",background:"linear-gradient(170deg,#f5f0e6,#ede7db)",display:"flex",flexDirection:"column",alignItems:"center",padding:"24px 20px",fontFamily:F,overflowY:"auto"}}>
      <div style={{marginTop:12}}><AvatarIcon id={acct.avatar} unlocked={acct.unlocked} size={52}/></div>
      <div style={{fontSize:11,color:rk.color,fontWeight:700,marginTop:4}}>{rk.badge} {rk.title}</div>
      <h2 style={{fontSize:22,fontWeight:900,color:"#3d3229",marginTop:4}}>{acct.name}</h2>
      <div style={{display:"flex",gap:12,marginTop:4}}>
        <span style={{fontSize:12,color:"#c49e5e",fontWeight:700}}>ü™ô {acct.coins}</span>
        <span style={{fontSize:12,color:"#8b9e6b",fontWeight:700}}>üé® {ownedBuyable}/{BUYABLE_IDS.length}</span>
      </div>
      {hasAllAvatars(acct.unlocked)&&<div style={{fontSize:10,color:"#c49e2e",fontWeight:700,marginTop:2}}>‚ú® {COMPLETE_AVATAR.em} „Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅ</div>}
      <div style={{background:"#faf6f0",borderRadius:18,padding:"16px 24px",marginTop:14,width:"100%",maxWidth:280,boxShadow:"0 2px 8px #0001"}}>
        <div style={{display:"flex",justifyContent:"space-between",fontSize:13,fontWeight:700,color:"#3d3229"}}><span>üèÜ ÈÄöÁÆóÂãùÂà©</span><span>{acct.wins}</span></div>
        <div style={{display:"flex",justifyContent:"space-between",fontSize:13,fontWeight:700,color:"#3d3229",marginTop:8}}><span>üíî ÊïóÂåó</span><span>{acct.losses}</span></div>
        <div style={{display:"flex",justifyContent:"space-between",fontSize:13,fontWeight:700,color:"#3d3229",marginTop:8}}><span>üìä ÂãùÁéá</span><span>{acct.wins+acct.losses>0?Math.round(acct.wins/(acct.wins+acct.losses)*100):0}%</span></div>
        {nextRk&&<div style={{marginTop:12,fontSize:10,color:"#8b7e6b"}}>Ê¨°„ÅÆÁß∞Âè∑„Äå{nextRk.badge} {nextRk.title}„Äç„Åæ„Åß„ÅÇ„Å®{nextRk.min-acct.wins}Âãù</div>}
        <div style={{marginTop:6,height:6,background:"#e8e0d4",borderRadius:4,overflow:"hidden"}}>
          <div style={{height:"100%",background:`linear-gradient(90deg,${rk.color},${nextRk?.color||rk.color})`,borderRadius:4,width:`${nextRk?Math.min(100,((acct.wins-(RANKS[RANKS.indexOf(rk)]?.min||0))/(nextRk.min-(RANKS[RANKS.indexOf(rk)]?.min||0)))*100):100}%`,transition:"width .4s"}}/></div>
        <div style={{marginTop:12,borderTop:"1px solid #e8e0d4",paddingTop:10}}>
          <div style={{fontSize:10,color:"#8b7e6b",marginBottom:4}}>üóì ÊúàÈñì„Éà„É≠„Éï„Ç£„ÉºÔºà{getMonthKey()}Ôºâ</div>
          <div style={{fontSize:9,color:"#b8a99a"}}>ÂãùÂà©„Åô„Çã„Åü„Å≥„Å´ÊúàÈñì„É©„É≥„Ç≠„É≥„Ç∞„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇÊØéÊúà1Êó•„Å´„É™„Çª„ÉÉ„Éà„ÄÇ</div>
        </div>
      </div>
      <div style={{display:"flex",gap:10,marginTop:18}}>
        <button onClick={()=>setScreen("title")} style={{border:"none",borderRadius:14,padding:"10px 24px",fontFamily:F,fontWeight:700,fontSize:13,background:"#e8e0d4",color:"#3d3229",cursor:"pointer"}}>‚Üê „ÇÇ„Å©„Çã</button>
        <button onClick={()=>setScreen("shop")} style={{border:"none",borderRadius:14,padding:"10px 24px",fontFamily:F,fontWeight:700,fontSize:13,background:"linear-gradient(135deg,#c49e5e,#c47e5e)",color:"#fff",cursor:"pointer"}}>üõç „Ç∑„Éß„ÉÉ„Éó</button>
      </div>
    </div></React.Fragment>);}

  if(screen==="shop"&&acct){
    const ownedBuyable=BUYABLE_IDS.filter(id=>(acct.unlocked||[]).includes(id)).length;
    const totalBuyable=BUYABLE_IDS.length;
    const isComplete=hasAllAvatars(acct.unlocked);
    const completeOwned=(acct.unlocked||[]).includes(COMPLETE_AVATAR.id);
    return(
    <React.Fragment><style>{CSS}</style>
    <div style={{minHeight:"100vh",background:"linear-gradient(170deg,#f5f0e6,#ede7db)",display:"flex",flexDirection:"column",alignItems:"center",padding:"24px 20px",fontFamily:F,overflowY:"auto"}}>
      <h2 style={{fontSize:20,fontWeight:900,color:"#3d3229"}}>üõç „Ç¢„Éê„Çø„Éº„Ç∑„Éß„ÉÉ„Éó</h2>
      <div style={{fontSize:13,color:"#c49e5e",fontWeight:700,marginTop:4}}>ü™ô {acct.coins} „Ç≥„Ç§„É≥</div>
      {/* Completion progress */}
      <div style={{width:"100%",maxWidth:300,marginTop:10}}>
        <div style={{display:"flex",justifyContent:"space-between",fontSize:9,color:"#8b7e6b",marginBottom:3}}>
          <span>„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ {ownedBuyable}/{totalBuyable}</span>
          <span>{isComplete?"‚ú® „Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅ":`ÊÆã„Çä${totalBuyable-ownedBuyable}Á®Æ`}</span>
        </div>
        <div style={{height:5,background:"#e8e0d4",borderRadius:4,overflow:"hidden"}}>
          <div style={{height:"100%",background:isComplete?"linear-gradient(90deg,#c49e2e,#c49e5e)":"linear-gradient(90deg,#8b9e6b,#6b8e9e)",borderRadius:4,width:`${(ownedBuyable/totalBuyable)*100}%`,transition:"width .4s"}}/>
        </div>
      </div>
      {shopMsg&&<div style={{fontSize:12,color:"#8b9e6b",fontWeight:700,marginTop:8,animation:"fadeUp .3s ease"}}>{shopMsg}</div>}
      {/* Complete avatar banner */}
      <div style={{width:"100%",maxWidth:300,marginTop:12,background:isComplete?"linear-gradient(135deg,#c49e2e15,#c49e5e15)":"#f5f0e6",borderRadius:16,padding:"10px 14px",border:`2px solid ${isComplete?"#c49e2e":"#d4ccc033"}`,display:"flex",alignItems:"center",gap:10}}>
        <span style={{fontSize:36,filter:isComplete?"none":"grayscale(1) opacity(0.3)"}}>{COMPLETE_AVATAR.em}</span>
        <div style={{flex:1}}>
          <div style={{fontSize:12,fontWeight:900,color:isComplete?"#c49e2e":"#b8a99a"}}>{COMPLETE_AVATAR.name}</div>
          <div style={{fontSize:8,color:isComplete?"#8b7e6b":"#b8a99a"}}>{isComplete?"‚ú® ÂÖ®„Ç¢„Éê„Çø„ÉºË≥ºÂÖ•„ÅßËß£ÊîæÊ∏à„ÅøÔºÅ":"ÂÖ®„Ç¢„Éê„Çø„Éº„ÇíÈõÜ„ÇÅ„Çã„Å®Ëß£ÊîæÔºÅ"}</div>
        </div>
        {completeOwned&&<button onClick={()=>equipAvatar(COMPLETE_AVATAR)} style={{border:"none",borderRadius:10,padding:"4px 10px",fontSize:8,fontWeight:700,fontFamily:F,cursor:"pointer",background:acct.avatar===COMPLETE_AVATAR.id?"#c49e5e":"#e8e0d4",color:acct.avatar===COMPLETE_AVATAR.id?"#fff":"#3d3229"}}>{acct.avatar===COMPLETE_AVATAR.id?"Ë£ÖÂÇô‰∏≠":"Ë£ÖÂÇô"}</button>}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8,marginTop:14,width:"100%",maxWidth:300}}>
        {AVATARS.map(av=>{const owned=(acct.unlocked||[]).includes(av.id);const equipped=acct.avatar===av.id;const canBuy=acct.coins>=av.cost&&!owned;
          return <div key={av.id} onClick={()=>{if(equipped)return;if(owned){equipAvatar(av);}else if(canBuy){buyAvatar(av);}}}
            style={{background:equipped?"#c49e5e11":"#faf6f0",borderRadius:14,padding:"8px 4px",display:"flex",flexDirection:"column",alignItems:"center",gap:2,
              border:`2px solid ${equipped?"#c49e5e":owned?"#8b9e6b44":"#d4ccc033"}`,cursor:equipped?"default":owned||canBuy?"pointer":"default",opacity:!owned&&!canBuy?0.4:1,transition:"all .2s"}}>
            <div style={{fontSize:28}}>{av.em}</div>
            <div style={{fontSize:7,fontWeight:700,color:"#3d3229"}}>{av.name}</div>
            {equipped&&<div style={{fontSize:6,color:"#c49e5e",fontWeight:700}}>Ë£ÖÂÇô‰∏≠</div>}
            {owned&&!equipped&&<div style={{fontSize:6,color:"#8b9e6b",fontWeight:700}}>Ë£ÖÂÇô</div>}
            {!owned&&<div style={{fontSize:7,color:canBuy?"#c49e5e":"#b8a99a",fontWeight:700}}>ü™ô{av.cost}</div>}
          </div>;})}
      </div>
      <button onClick={()=>setScreen("profile")} style={{marginTop:20,border:"none",borderRadius:14,padding:"10px 24px",fontFamily:F,fontWeight:700,fontSize:13,background:"#e8e0d4",color:"#3d3229",cursor:"pointer"}}>‚Üê „ÇÇ„Å©„Çã</button>
    </div></React.Fragment>);}

  if(screen==="pvp_lobby"){
    /* Fetch leaderboard on mount */
    if(leaderboard.length===0)fetchLeaderboard();
    const medalEm=["ü•á","ü•à","ü•â","4Ô∏è‚É£","5Ô∏è‚É£"];
    return (
    <React.Fragment><style>{CSS}</style>
    <div style={{minHeight:"100vh",background:"linear-gradient(170deg,#f5f0e6,#ede7db)",display:"flex",flexDirection:"column",alignItems:"center",padding:"24px 20px",fontFamily:F,overflowY:"auto"}}>
      <div style={{fontSize:48,animation:"float 3s ease infinite"}}>üåê</div>
      <h1 style={{fontSize:22,fontWeight:900,color:"#3d3229",marginTop:6}}>„Ç™„É≥„É©„Ç§„É≥ÂØæÊà¶</h1>
      <p style={{fontSize:10,color:"#8b7e6b",marginTop:2}}>‰∏ñÁïå‰∏≠„ÅÆ„Éó„É¨„Ç§„É§„Éº„Å®„É™„Ç¢„É´„Çø„Ç§„É†„Éê„Éà„É´ÔºÅ</p>
      {acct&&<div style={{background:"#faf6f0",borderRadius:16,padding:"12px 20px",marginTop:14,display:"flex",alignItems:"center",gap:12,boxShadow:"0 2px 8px #0001",width:"100%",maxWidth:300}}>
        <AvatarIcon id={acct.avatar} unlocked={acct.unlocked} size={28}/>
        <div style={{flex:1}}><div style={{fontSize:14,fontWeight:900,color:"#3d3229"}}>{acct.name}</div>
          <div style={{fontSize:10,color:"#8b9e6b"}}>{getRank(acct.wins).badge} {getRank(acct.wins).title} ¬∑ {acct.wins}Âãù</div></div>
      </div>}
      <button onClick={pvpStartMatch} style={{marginTop:20,border:"none",borderRadius:18,padding:"14px 44px",fontFamily:F,fontWeight:700,fontSize:17,cursor:"pointer",background:"linear-gradient(135deg,#6b8e9e,#8b9e6b)",color:"#fff",boxShadow:"0 4px 20px rgba(107,142,158,.3)",animation:"fadeUp .3s ease"}}>‚öî ÂØæÊà¶„Åô„ÇãÔºÅ</button>
      <p style={{fontSize:8,color:"#b8a99a",marginTop:6}}>15ÁßíÂæÖ„Å£„Å¶„ÇÇ„Éû„ÉÉ„ÉÅ„Åó„Å™„ÅÑÂ†¥Âêà„ÅØAIÂØæÊà¶„Å´„Å™„Çä„Åæ„Åô</p>
      {/* Monthly Leaderboard */}
      <div style={{marginTop:20,width:"100%",maxWidth:300,background:"#faf6f0",borderRadius:18,padding:"14px 16px",boxShadow:"0 2px 8px #0001"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
          <div style={{fontSize:13,fontWeight:900,color:"#3d3229"}}>üèÜ ÊúàÈñì„É©„É≥„Ç≠„É≥„Ç∞</div>
          <div style={{fontSize:8,color:"#b8a99a"}}>{getMonthKey()}</div>
        </div>
        {leaderboard.length===0?<div style={{fontSize:10,color:"#b8a99a",textAlign:"center",padding:12}}>„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>:
          leaderboard.map((e,i)=>(
            <div key={i} style={{display:"flex",alignItems:"center",gap:6,padding:"7px 4px",borderBottom:i<leaderboard.length-1?"1px solid #e8e0d4":"none",background:i===0?"linear-gradient(90deg,#ffd70008,transparent)":"none"}}>
              <span style={{fontSize:16,width:24,textAlign:"center"}}>{medalEm[i]||""}</span>
              <span style={{fontSize:18}}>{getAvatarEm(e.avatar)}</span>
              <div style={{flex:1}}>
                <div style={{fontSize:12,fontWeight:700,color:i===0?"#c49e2e":i===1?"#8b8b8b":i===2?"#c47e5e":"#3d3229"}}>{e.name}</div>
              </div>
              <div style={{fontSize:14,fontWeight:900,color:"#c49e5e"}}>üèÜ{e.trophies}</div>
            </div>
          ))
        }
        <button onClick={fetchLeaderboard} style={{marginTop:6,border:"none",background:"none",fontSize:9,color:"#6b8e9e",fontFamily:F,fontWeight:700,cursor:"pointer",width:"100%",textAlign:"center"}}>üîÑ Êõ¥Êñ∞</button>
        <div style={{marginTop:6,borderTop:"1px solid #e8e0d4",paddingTop:6,fontSize:7,color:"#b8a99a",lineHeight:1.5}}>
          ÂãùÂà©: Ê†º‰∏ä+5 / ÂêåÊ†º‰ª•‰∏ã+4<br/>ÊïóÂåó: Ê†º‰∏ã„Å´-5 / ÂêåÊ†º‰ª•‰∏ä„Å´-4<br/>ÊØéÊúà1Êó•„É™„Çª„ÉÉ„Éà
        </div>
      </div>
      <button onClick={()=>{setScreen("title");setPvp(false);}} style={{marginTop:16,border:"none",borderRadius:12,padding:"8px 20px",fontFamily:F,fontWeight:700,fontSize:12,background:"#e8e0d4",color:"#3d3229",cursor:"pointer"}}>‚Üê „ÇÇ„Å©„Çã</button>
    </div></React.Fragment>);
  }

  if(screen==="pvp_matching")return (
    <React.Fragment><style>{CSS}</style>
    <div style={{minHeight:"100vh",background:"linear-gradient(170deg,#f5f0e6,#ede7db)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:32,fontFamily:F}}>
      <div style={{fontSize:48,animation:"float 1.5s ease infinite"}}>üîç</div>
      <h2 style={{fontSize:18,fontWeight:900,color:"#3d3229",marginTop:14}}>ÂØæÊà¶Áõ∏Êâã„Çí„Åï„Åå„Åó„Å¶„ÅÑ„Åæ„Åô‚Ä¶</h2>
      <div style={{marginTop:16,width:200,height:6,background:"#e8e0d4",borderRadius:4,overflow:"hidden"}}>
        <div style={{height:"100%",background:"linear-gradient(90deg,#6b8e9e,#8b9e6b)",borderRadius:4,width:`${Math.min(100,pvpTimer/15*100)}%`,transition:"width .3s"}}/></div>
      <div style={{fontSize:12,color:"#8b7e6b",marginTop:8,fontWeight:700}}>{pvpTimer}Áßí</div>
      <p style={{fontSize:9,color:"#b8a99a",marginTop:4}}>{pvpTimer>=10?"„Åæ„ÇÇ„Å™„ÅèAIÂØæÊà¶„Å´Âàá„ÇäÊõø„Çè„Çä„Åæ„Åô‚Ä¶":"Âêå„ÅòÁîªÈù¢„Çí‰ªñ„ÅÆ„Çø„Éñ„ÅßÈñã„ÅÑ„Å¶„ÄåÂØæÊà¶„Åô„ÇãÔºÅ„Äç„ÇíÊäº„Åô„Å®„Éû„ÉÉ„ÉÅ„Åó„Åæ„Åô"}</p>
      <button onClick={pvpCancelMatch} style={{marginTop:24,border:"none",borderRadius:12,padding:"8px 20px",fontFamily:F,fontWeight:700,fontSize:12,background:"#e8e0d4",color:"#3d3229",cursor:"pointer"}}>„Ç≠„É£„É≥„Çª„É´</button>
    </div></React.Fragment>);

  if(screen==="title")return (
    <React.Fragment><style>{CSS}</style>
    <div style={{minHeight:"100vh",background:"linear-gradient(170deg,#f5f0e6,#ede7db 40%,#e8dfd1)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:32,fontFamily:F}}>
      <div style={{position:"fixed",inset:0,opacity:0.03,background:"radial-gradient(circle at 30% 40%,#8b9e6b,transparent 50%),radial-gradient(circle at 70% 60%,#c47e5e,transparent 50%)",pointerEvents:"none"}}/>
      {acct&&<div onClick={()=>setScreen("profile")} style={{position:"absolute",top:16,right:16,display:"flex",alignItems:"center",gap:8,background:"rgba(250,246,240,.9)",borderRadius:16,padding:"6px 14px",cursor:"pointer",boxShadow:"0 2px 8px #0001"}}>
        <AvatarIcon id={acct.avatar} unlocked={acct.unlocked} size={20}/>
        <div><div style={{fontSize:11,fontWeight:900,color:"#3d3229"}}>{acct.name}</div><div style={{fontSize:8,color:getRank(acct.wins).color,fontWeight:700}}>{getRank(acct.wins).badge} {getRank(acct.wins).title}</div></div>
        <span style={{fontSize:10,color:"#c49e5e",fontWeight:700}}>ü™ô{acct.coins}</span>
      </div>}
      <div style={{fontSize:56,animation:"float 3s ease infinite"}}>üß¨</div>
      <h1 style={{fontSize:26,fontWeight:900,color:"#3d3229",marginTop:10,letterSpacing:2}}>Cell Battle</h1>
      <p style={{fontSize:12,color:"#8b7e6b",marginTop:6}}>„Çø„É≥„Éë„ÇØË≥™„Ç´„Éº„Éâ„Éê„Éà„É´</p>
      <p style={{fontSize:9,color:"#b8a99a",marginTop:4}}>122Á®Æ ¬∑ ÁµêÂêà„Åß‰ΩìÂäõUP ¬∑ ÂÖàÊîª„ÅØMW„ÅßÊ±∫ÂÆö</p>
      <div style={{display:"flex",flexDirection:"column",gap:10,marginTop:32,width:"100%",maxWidth:260}}>
        {Object.entries(DIFF).map(([k,v],i)=>(
          <button key={k} onClick={()=>start(k)} style={{border:"none",borderRadius:16,padding:"14px 20px",fontFamily:F,fontWeight:700,cursor:"pointer",fontSize:15,display:"flex",alignItems:"center",gap:12,background:"rgba(250,246,240,.8)",color:"#3d3229",boxShadow:"0 2px 8px #0001",animation:`fadeUp .4s ease ${i*0.08}s both`}}><span style={{fontSize:24}}>{v.em}</span>{v.nm}</button>
        ))}
        <button onClick={()=>{setPvp(false);setLeaderboard([]);setScreen("pvp_lobby");}} style={{border:"none",borderRadius:16,padding:"14px 20px",fontFamily:F,fontWeight:700,cursor:"pointer",fontSize:15,display:"flex",alignItems:"center",gap:12,background:"linear-gradient(135deg,rgba(107,142,158,.15),rgba(139,158,107,.15))",color:"#3d3229",boxShadow:"0 2px 8px #0001",animation:`fadeUp .4s ease .24s both`}}><span style={{fontSize:24}}>üåê</span>„Ç™„É≥„É©„Ç§„É≥ÂØæÊà¶</button>
      </div>
    </div></React.Fragment>
  );

  if(!g||screen!=="game")return null;
  const isMain=g.ipt&&phase==="main"&&!winner;
  const isSetup=phase==="setup";
  const eAllField=[g.eAct,...g.eBench].filter(Boolean);

  return (
    <React.Fragment><style>{CSS}</style>
    <div style={{minHeight:"100vh",maxWidth:480,margin:"0 auto",background:"linear-gradient(170deg,#f5f0e6,#ede7db 40%,#e8dfd1)",display:"flex",flexDirection:"column",fontFamily:F,position:"relative",overflow:"hidden",touchAction:isDragging?"none":"auto"}}
      onMouseMove={e=>{if(drag)onDM(e.clientX,e.clientY);}} onMouseUp={()=>{if(drag)onDE();}}
      onTouchMove={e=>{if(drag){const[x,y]=gp(e);onDM(x,y);}}} onTouchEnd={()=>{if(drag)onDE();}}>
      <div style={{position:"fixed",inset:0,opacity:0.025,background:"radial-gradient(circle at 25% 30%,#8b9e6b,transparent 50%),radial-gradient(circle at 75% 70%,#c47e5e,transparent 50%)",pointerEvents:"none"}}/>

      {msg&&<div style={{position:"fixed",top:44,left:"50%",transform:"translateX(-50%)",zIndex:900,background:"rgba(61,50,41,.82)",color:"#faf6f0",padding:"7px 18px",borderRadius:14,fontSize:12,fontFamily:F,fontWeight:700,animation:"fadeUp .2s ease",pointerEvents:"none",maxWidth:"88%",textAlign:"center",backdropFilter:"blur(4px)"}}>{msg.text}</div>}
      {dmgFloat&&<div style={{position:"fixed",left:"50%",top:dmgFloat>0?"22%":"48%",transform:"translateX(-50%)",zIndex:999,fontSize:36,fontWeight:900,color:"#c47e5e",animation:"floatUp .9s ease forwards",pointerEvents:"none"}}>-{Math.abs(dmgFloat)}</div>}

      {/* Drag ghost */}
      {drag&&dragCard&&<div style={{position:"fixed",left:drag.cx-30,top:drag.cy-42,zIndex:2000,pointerEvents:"none",opacity:0.85,transform:"scale(1.1)"}}>
        {(()=>{const tc=TC[dragCard.type]||["#888","#eee","#333"];const isE=dragCard.type===T.E;return (
          <div style={{width:60,height:84,borderRadius:12,background:isE?"#1a1a1a":tc[1],border:`3px solid ${isE?"#444":tc[0]}`,boxShadow:`0 8px 30px ${tc[0]}44`,display:"flex",flexDirection:"column",alignItems:"center",padding:3}}>
            <div style={{width:36,height:36}} dangerouslySetInnerHTML={{__html:`<svg viewBox="0 0 64 64">${getArt(dragCard.id,dragCard.type)}</svg>`}}/>
            <div style={{fontSize:7,color:isE?"#e0d8cc":tc[2],fontFamily:F,fontWeight:700,textAlign:"center"}}>{dragCard.name}</div>
            <div style={{fontSize:5,color:isE?"#888":tc[0]}}>{dragCard.mw}kDa</div>
          </div>);
        })()}
      </div>}

      {/* Winner overlay */}
      {winner&&<div style={{position:"fixed",inset:0,background:"rgba(245,240,230,.96)",zIndex:2000,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",animation:"pop .3s ease",padding:20}}>
        <div style={{fontSize:64}}>{pvpForfeit?"üò∂":winner==="player"?"üéâ":"üò¢"}</div>
        <div style={{fontSize:28,fontWeight:900,color:winner==="player"?"#8b9e6b":"#c47e5e",marginTop:10}}>{pvpForfeit?"ÂØæÊà¶Áõ∏Êâã„Åå„Å™„Åè„Å™„Å£„Å¶„Åó„Åæ„Å£„Åü‚Ä¶":winner==="player"?"ÂãùÂà©ÔºÅ":"ÊïóÂåó‚Ä¶"}</div>
        {pvpForfeit&&<div style={{fontSize:12,color:"#8b7e6b",marginTop:4}}>{pvpForfeit==="idle"?"Áõ∏Êâã„Åå2„Çø„Éº„É≥ÈÄ£Á∂ö„ÅßÁÑ°Êìç‰Ωú„Åß„Åó„Åü":"Áõ∏Êâã„ÅåÂàáÊñ≠„Åó„Åæ„Åó„Åü"}</div>}
        <div style={{fontSize:12,color:"#8b7e6b",marginTop:4}}>„Çø„Éº„É≥{turn}</div>
        {coinReward>0&&<div style={{fontSize:14,color:"#c49e5e",fontWeight:700,marginTop:8,animation:"fadeUp .3s ease .2s both"}}>ü™ô +{coinReward} „Ç≥„Ç§„É≥Áç≤ÂæóÔºÅ</div>}
        {acct&&(()=>{const rk=getRank(acct.wins);return<div style={{marginTop:8,fontSize:11,color:rk.color,fontWeight:700}}>{rk.badge} {rk.title}</div>;})()}
        <div style={{display:"flex",gap:10,marginTop:24}}>
          <button onClick={()=>{setPvp(false);setPvpMatch(null);setPvpRole(null);setScreen("title");}} style={{border:"none",borderRadius:16,padding:"12px 28px",fontFamily:F,fontWeight:700,fontSize:14,background:"#e8e0d4",color:"#3d3229",cursor:"pointer"}}>üè† „ÇÇ„Å©„Çã</button>
          {pvp&&pvpMatch!=="ai"?
            <button onClick={()=>{setPvp(false);setPvpMatch(null);setLeaderboard([]);setScreen("pvp_lobby");}} style={{border:"none",borderRadius:16,padding:"12px 28px",fontFamily:F,fontWeight:700,fontSize:14,background:"linear-gradient(135deg,#6b8e9e,#8b9e6b)",color:"#fff",cursor:"pointer"}}>üåê „É≠„Éì„Éº„Å´Êàª„Çã</button>:
            <button onClick={()=>start(diff)} style={{border:"none",borderRadius:16,padding:"12px 28px",fontFamily:F,fontWeight:700,fontSize:14,background:"linear-gradient(135deg,#8b9e6b,#6b8e7b)",color:"#fff",cursor:"pointer"}}>üîÑ ÂÜçÊà¶</button>}
        </div>
      </div>}

      {/* Setup screen */}
      {isSetup&&<div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:20,overflowY:"auto"}}>
        {pvp&&pvpSetupDone.current&&g.pAct?<React.Fragment>
          <div style={{fontSize:14,fontWeight:900,color:"#3d3229",marginBottom:8}}>‚úÖ {g.pAct.name} „Çí„Çª„ÉÉ„ÉàÔºÅ</div>
          <CardComp c={g.pAct} size="lg"/>
          <div style={{fontSize:12,color:"#6b8e9e",fontWeight:700,marginTop:16,animation:"float 2s ease infinite"}}>‚è≥ Áõ∏Êâã„Åå„Ç´„Éº„Éâ„ÇíÈÅ∏„Çì„Åß„ÅÑ„Åæ„Åô‚Ä¶</div>
        </React.Fragment>:<React.Fragment>
        <div style={{fontSize:17,fontWeight:900,color:"#3d3229",marginBottom:6}}>„Éê„Éà„É´Â†¥„Å´Âá∫„Åô„Ç´„Éº„Éâ„ÇíÈÅ∏„Åº„ÅÜ</div>
        <div style={{fontSize:10,color:"#8b7e6b",marginBottom:4}}>‚ô°=‰ΩìÂäõÔºàÂàÜÂ≠êÈáèÔºâ ¬∑ ËªΩ„ÅÑ„Åª„Å©ÂÖàÊîª</div>
        <div style={{fontSize:9,color:"#b8a99a",marginBottom:16}}>‚öô„Çµ„Éù„Éº„Éà„Ç´„Éº„Éâ(Èªí)„ÅØ„Éê„Éà„É´„Å´Âá∫„Åõ„Åæ„Åõ„Çì</div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap",justifyContent:"center",maxWidth:500}}>
          {g.ph.filter(c=>!c.isSupport).map(c=>(
            <CardComp key={c.uid} c={c} size="lg" onTap={()=>pickActive(c.uid)}/>
          ))}
        </div>
        {g.ph.some(c=>c.isSupport)&&<div style={{marginTop:14}}>
          <div style={{fontSize:9,color:"#888",textAlign:"center",marginBottom:4}}>‚öô „Çµ„Éù„Éº„Éà„Ç´„Éº„ÉâÔºàÊâãÊú≠„Åã„Çâ„Éâ„É©„ÉÉ„Ç∞„ÅßÂç≥‰ΩøÁî®Ôºâ</div>
          <div style={{display:"flex",gap:4,justifyContent:"center"}}>
            {g.ph.filter(c=>c.isSupport).map(c=>(
              <CardComp key={c.uid} c={c} size="sm"/>
            ))}
          </div>
        </div>}
        </React.Fragment>}
      </div>}

      {/* Game screen */}
      {!isSetup&&<React.Fragment>
        {/* Header */}
        <div style={{padding:"6px 14px",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid #e0d8cc",background:"rgba(245,240,230,.9)",zIndex:10}}>
          <div style={{display:"flex",alignItems:"center",gap:6}}>
            <span style={{fontSize:10}}>üß¨</span>
            <span style={{fontSize:9,color:"#c49e5e",fontWeight:700,background:"#c49e5e15",borderRadius:8,padding:"2px 8px"}}>T{turn}</span>
          </div>
          <div style={{fontSize:10,fontWeight:700,color:eChoice?eChoice.c:phase==="enemy"||phase==="pvp_wait"?"#c47e5e":"#8b9e6b"}}>{eChoice?"‚ö° „Ç®„Éç„É´„ÇÆ„Éº":phase==="enemy"||phase==="pvp_wait"?(pvpOppInfo?`‚è≥ ${pvpOppInfo.name}„ÅÆ„Çø„Éº„É≥`:"ü§ñ Áõ∏Êâã"):"‚úã „ÅÇ„Å™„Åü"}</div>
          <button onClick={()=>{if(pvp&&pvpMatch&&pvpMatch!=="ai"){pvpCleanup();}setPvp(false);setPvpMatch(null);setScreen("title");}} style={{background:"none",border:"1px solid #d4ccc0",borderRadius:10,padding:"3px 10px",fontSize:9,color:"#8b7e6b",fontFamily:F,cursor:"pointer"}}>‚úï</button>
        </div>
        {/* Turn timer bar */}
        {phase==="main"&&!winner&&<div style={{height:3,background:"#e0d8cc",position:"relative"}}>
          <div style={{height:"100%",background:turnClock<=5?"#c47e5e":turnClock<=10?"#c49e5e":"#8b9e6b",width:`${(turnClock/20)*100}%`,transition:"width 1s linear",borderRadius:2}}/>
          <span style={{position:"absolute",right:6,top:-10,fontSize:8,fontWeight:700,color:turnClock<=5?"#c47e5e":"#8b7e6b"}}>{turnClock}s</span>
        </div>}

        {/* Enemy zone */}
        <div style={{padding:"3px 14px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <span style={{fontSize:10,fontWeight:700,color:"#8b7e6b"}}>{pvpOppInfo?`${getAvatarEm(pvpOppInfo.avatar)} ${pvpOppInfo.name}`:"ü§ñ Áõ∏Êâã"}</span>
          <div style={{display:"flex",gap:2}}>{g.eBuff?.atkMul>1&&<span style={{fontSize:7,background:"#c47e5e22",color:"#c47e5e",borderRadius:4,padding:"0 3px",fontWeight:700}}>‚öî√ó{g.eBuff.atkMul}</span>}{g.eBuff?.shield>0&&<span style={{fontSize:7,background:"#6b8e9e22",color:"#6b8e9e",borderRadius:4,padding:"0 3px",fontWeight:700}}>üõ°-{g.eBuff.shield}</span>}{g.eBuff?.pierce&&<span style={{fontSize:7,background:"#c49e5e22",color:"#c49e5e",borderRadius:4,padding:"0 3px",fontWeight:700}}>üó°Ë≤´ÈÄö</span>}</div>
          <KODots count={g.eko} max={KO_TO_WIN} color="#c47e5e"/>
          <span style={{fontSize:8,color:"#b8a99a"}}>ÊâãÊú≠{g.eh.length} Â±±{g.ed.length}</span>
        </div>
        <div style={{display:"flex",gap:3,padding:"1px 14px",justifyContent:"center",minHeight:24,flexWrap:"wrap"}}>

          {g.eBench.map(c=><CardComp key={c.uid} c={c} size="md" allField={eAllField} onTap={()=>setDetail(c)}/>)}
        </div>
        <div style={{display:"flex",justifyContent:"center",padding:"3px 0"}}>
          <CardComp c={g.eAct} size="lg" hit={hitAnim==="e"} allField={eAllField} onTap={()=>g.eAct&&setDetail(g.eAct)}/>
        </div>

        {/* Divider */}
        <svg width="100%" height="6" viewBox="0 0 400 6" preserveAspectRatio="none" style={{margin:"3px 0",opacity:0.2}}>
          <path d="M0 3 Q50 0 100 3 Q150 6 200 3 Q250 0 300 3 Q350 6 400 3" fill="none" stroke="#8b7e6b" strokeWidth="1.5"/>
        </svg>

        {/* Player active */}
        <div style={{display:"flex",justifyContent:"center",padding:"3px 0",position:"relative"}}>
          <CardComp c={g.pAct} size="lg" hit={hitAnim==="p"} allField={pAllField}
            selected={!!eChoice&&!!g.pAct}
            bindPulse={g.pAct&&fieldBindableIds.has(g.pAct.uid)}
            dragTarget={g.pAct&&dragTargetIds.has(g.pAct.uid)}
            onTap={()=>{if(eChoice&&g.pAct){attachE(g.pAct.uid);return;}if(g.pAct)setDetail({...g.pAct,_canUnbind:isMain});}}/>
        </div>



        {/* Bench + drop zone */}
        <div style={{display:"flex",gap:4,padding:"4px 14px",justifyContent:"center",minHeight:40,borderRadius:10,margin:"2px 12px",
          border:isDragging&&dragDy>30?"2px dashed #8b9e6b":"2px dashed transparent",
          animation:isDragging&&dragDy>30?"dropGlow 1s ease infinite":"none",transition:"all .2s"}}>
          {g.pBench.map(c=>(
            <CardComp key={c.uid} c={c} size="md" allField={pAllField}
              selected={!!eChoice}
              bindPulse={fieldBindableIds.has(c.uid)}
              dragTarget={dragTargetIds.has(c.uid)}
              onTap={()=>{if(eChoice){attachE(c.uid);return;}const boundToAct=g.pAct&&(g.pAct.bw2||[]).includes(c.uid);setDetail({...c,_canSwap:isMain&&!c.isSupport&&!boundToAct,_canUnbind:isMain,_boundToAct:boundToAct});}}/>
          ))}
          {g.pBench.length<3&&<div style={{width:80,height:108,borderRadius:14,
            border:`2px dashed ${isDragging&&dragDy>30?"#8b9e6b":"#d4ccc044"}`,
            display:"flex",alignItems:"center",justifyContent:"center",
            color:isDragging&&dragDy>30?"#8b9e6b":"#d4ccc0",
            fontSize:isDragging&&dragDy>30?10:20,transition:"all .2s"}}>
            {isDragging&&dragDy>30?"„Åì„Åì„Å´„Éâ„É≠„ÉÉ„Éó":"+"}
          </div>}
        </div>

        {/* Player info + energy pool */}
        <div style={{padding:"3px 14px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <span style={{fontSize:10,fontWeight:700,color:"#3d3229"}}>{acct?`${getAvatarEm(acct.avatar)} ${acct.name}`:"üßë‚Äçüî¨ „ÅÇ„Å™„Åü"}</span>
          <div style={{display:"flex",gap:2}}>{g.pBuff?.atkMul>1&&<span style={{fontSize:7,background:"#c47e5e22",color:"#c47e5e",borderRadius:4,padding:"0 3px",fontWeight:700}}>‚öî√ó{g.pBuff.atkMul}</span>}{g.pBuff?.shield>0&&<span style={{fontSize:7,background:"#6b8e9e22",color:"#6b8e9e",borderRadius:4,padding:"0 3px",fontWeight:700}}>üõ°-{g.pBuff.shield}</span>}{g.pBuff?.pierce&&<span style={{fontSize:7,background:"#c49e5e22",color:"#c49e5e",borderRadius:4,padding:"0 3px",fontWeight:700}}>üó°Ë≤´ÈÄö</span>}</div>
          <KODots count={g.pko} max={KO_TO_WIN} color="#8b9e6b"/>
          <div style={{display:"flex",gap:4,alignItems:"center",flexWrap:"wrap"}}>
            {(()=>{
              const counts={};pGroupEs.forEach(e=>{counts[e]=(counts[e]||0)+1;});
              return Object.entries(counts).map(([eid,n])=>(
                <div key={eid} style={{display:"flex",alignItems:"center",gap:1,background:"#e8e0d4",borderRadius:6,padding:"1px 4px"}}>
                  <ESvg id={eid} size={12}/>
                  <span style={{fontSize:8,fontWeight:700,color:"#6b6358"}}>√ó{n}</span>
                </div>
              ));
            })()}
            {pGroupEs.length===0&&<span style={{fontSize:8,color:"#b8a99a"}}>„Ç®„Éç„É´„ÇÆ„Éº„Å™„Åó</span>}
          </div>
        </div>

        {/* Energy choice */}
        {eChoice&&<div style={{padding:"6px 14px",background:`${eChoice.c}10`,borderTop:`1.5px solid ${eChoice.c}33`,display:"flex",alignItems:"center",justifyContent:"center",gap:10,animation:"fadeUp .2s ease"}}>
          <div style={{animation:"eBounce .5s ease infinite"}}><ESvg id={eChoice.id} size={24}/></div>
          <div><div style={{fontSize:11,fontWeight:700,color:eChoice.c}}>{eChoice.n}„Çí„Ç≤„ÉÉ„ÉàÔºÅ</div><div style={{fontSize:8,color:"#8b7e6b"}}>„Å§„Åë„Åü„ÅÑ„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó</div></div>
          <button onClick={()=>setEChoice(null)} style={{border:"1px solid #d4ccc0",borderRadius:10,padding:"3px 10px",fontSize:8,color:"#8b7e6b",fontFamily:F,cursor:"pointer",background:"transparent",marginLeft:6}}>„Åô„Å¶„Çã</button>
        </div>}

        {/* Attack buttons */}
        {isMain&&<div style={{padding:"5px 14px"}}>
          {attacked?
            <div style={{textAlign:"center",padding:"8px 0"}}>
              <div style={{fontSize:11,color:"#8b9e6b",fontWeight:700}}>‚úÖ ÊîªÊíÉÊ∏à„Åø</div>
              <div style={{fontSize:9,color:"#8b7e6b",marginTop:2}}>„Ç´„Éº„Éâ„ÇíÈÖçÁΩÆ„Éª„Ç®„Éç„É´„ÇÆ„Éº„Çí„Å§„Åë„Å¶„ÄÅ„Çø„Éº„É≥ÁµÇ‰∫Ü„Åó„Çà„ÅÜ</div>
              <button onClick={()=>endTurn(false)} style={{marginTop:8,border:"none",borderRadius:14,padding:"10px 28px",fontFamily:F,fontWeight:700,fontSize:13,cursor:"pointer",background:"linear-gradient(135deg,#8b9e6b,#6b8e7b)",color:"#fff",boxShadow:"0 3px 12px #8b9e6b33"}}>„Çø„Éº„É≥ÁµÇ‰∫Ü {turnClock}s ‚Üí</button>
            </div>:
            <div style={{display:"flex",gap:5,justifyContent:"center",flexWrap:"wrap"}}>
              {pGroupSkills.map(sk=>{
                const can=canPay(pGroupEs,sk.ae);
                return (
                  <button key={sk.uid} onClick={()=>can&&doAttack(sk)}
                    style={{border:can?"none":"1.5px dashed #d4ccc0",borderRadius:14,padding:"6px 12px",fontFamily:F,fontWeight:700,fontSize:10,cursor:can?"pointer":"default",
                      background:can?"linear-gradient(135deg,#c47e5e,#c49e5e)":"#f5f0e6",
                      color:can?"#fff":"#b8a99a",boxShadow:can?"0 3px 12px rgba(196,126,94,.3)":"none",
                      opacity:can?1:0.45,display:"flex",flexDirection:"column",alignItems:"center",gap:2,minWidth:80}}>
                    <div style={{display:"flex",alignItems:"center",gap:4}}>
                      <span>‚öî {sk.an}</span>
                      <span style={{background:can?"rgba(255,255,255,.25)":"#e8e0d4",borderRadius:6,padding:"1px 6px",fontSize:12,fontWeight:900}}>{sk.ad+pBindBonus}</span>
                      {pBindBonus>0&&<span style={{fontSize:7,color:can?"#ffe":"#b8a99a"}}>üîó+{pBindBonus}</span>}
                    </div>
                    <div style={{display:"flex",alignItems:"center",gap:3,fontSize:8,fontWeight:600}}>
                      {sk.ae.map((e,i)=>{
                        const en=EN.find(x=>x.id===e.id);
                        return <span key={i} style={{display:"flex",alignItems:"center",gap:1,background:can?"rgba(255,255,255,.15)":"#e8e0d4",borderRadius:4,padding:"1px 4px"}}>
                          <ESvg id={e.id} size={10}/>
                          <span>√ó{e.n}</span>
                        </span>;
                      })}
                      {!can&&<span style={{color:"#c47e5e",fontWeight:800}}>‚ö†‰∏çË∂≥</span>}
                    </div>
                    <div style={{fontSize:7,opacity:0.7}}>{sk.name}</div>
                  </button>
                );
              })}
              <button onClick={()=>endTurn(false)} style={{border:"1.5px solid #d4ccc0",borderRadius:14,padding:"8px 16px",fontFamily:F,fontWeight:700,fontSize:11,cursor:"pointer",background:"transparent",color:"#8b7e6b",alignSelf:"center"}}>„Çø„Éº„É≥ÁµÇ‰∫Ü {turnClock}s ‚Üí</button>
            </div>}
        </div>}

        {/* PvP waiting for opponent */}
        {phase==="pvp_wait"&&!winner&&<div style={{padding:"12px 14px",textAlign:"center"}}>
          <div style={{fontSize:14,color:"#6b8e9e",fontWeight:700,animation:"float 2s ease infinite"}}>‚è≥ {pvpOppInfo?`${pvpOppInfo.name}„ÅÆ„Çø„Éº„É≥‚Ä¶`:"Áõ∏Êâã„ÅÆ„Çø„Éº„É≥‚Ä¶"}</div>
          <div style={{fontSize:9,color:"#b8a99a",marginTop:4}}>Áõ∏Êâã„ÅÆÊìç‰Ωú„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô</div>
        </div>}

        {/* Hand */}
        <div style={{padding:"5px 14px",borderTop:"1px solid #e0d8cc",background:"rgba(245,240,230,.85)",marginTop:"auto"}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
            <span style={{fontSize:9,color:"#8b7e6b"}}>ÊâãÊú≠ {g.ph.length}</span>
            <span style={{fontSize:9,color:"#b8a99a"}}>Â±±Êú≠ {g.pd.length}</span>
          </div>
          <div style={{display:"flex",gap:4,overflowX:"auto",paddingBottom:6}}>
            {g.ph.map(c=>{
              const canBd=canBindIds.has(c.uid);
              const isDrg=drag?.uid===c.uid;
              return (
                <div key={c.uid} style={{position:"relative",opacity:isDrg?0.3:1,transition:"opacity .15s"}}
                  onMouseDown={e=>{if(isMain)onDS(c.uid,e.clientX,e.clientY);}}
                  onTouchStart={e=>{if(isMain){const[x,y]=gp(e);onDS(c.uid,x,y);}}}
                  onClick={()=>{if(!isMain||drag)return;setDetail(c);}}>
                  <CardComp c={c} size="sm" sparkle={canBd&&!c.isSupport}/>
                  {c.isSupport&&<div style={{position:"absolute",bottom:0,left:0,right:0,background:"#c49e5ecc",color:"#fff",fontSize:5,fontWeight:900,textAlign:"center",borderRadius:"0 0 8px 8px",lineHeight:1.4}}>‚öô„Çπ„Éö„É´</div>}
                </div>
              );
            })}
          </div>
          {isMain&&<div style={{fontSize:8,color:"#b8a99a",textAlign:"center"}}>{eChoice?"‚ö°„Ç®„Éç„É´„ÇÆ„Éº„Çí„Å§„Åë„Çã„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„ÉóÔºà„Ç´„Éº„ÉâÈÖçÁΩÆ„ÇÇOKÔºâ":"‚Üë „Éâ„É©„ÉÉ„Ç∞„ÅßÈÖçÁΩÆ ¬∑ ‚öôÈªí=Âç≥Áô∫Âãï„Çπ„Éö„É´ ¬∑ ‚ú®=ÁµêÂêàÂèØËÉΩ"}</div>}
        </div>
      </React.Fragment>}

      {/* Detail modal */}
      {detail&&<div style={{position:"fixed",inset:0,background:"rgba(61,50,41,.4)",backdropFilter:"blur(3px)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={()=>setDetail(null)}>
        <div onClick={e=>e.stopPropagation()} style={{background:detail.isSupport?"#222":"#faf6f0",borderRadius:22,padding:18,maxWidth:320,width:"100%",animation:"pop .25s ease",boxShadow:"0 12px 40px #0002"}}>
          {(()=>{const tc=TC[detail.type]||["#8b7e6b","#f0eeea","#3d3a2e"];const isE=detail.isSupport;const txtC=isE?"#e0d8cc":tc[2];const subC=isE?"#999":tc[0];return (
            <React.Fragment>
              <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:10}}>
                <div style={{width:80,height:80,flexShrink:0}} dangerouslySetInnerHTML={{__html:`<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">${getArt(detail.id,detail.type)}</svg>`}}/>
                <div>
                  <div style={{fontSize:16,fontWeight:900,color:txtC}}>{detail.name}</div>
                  <div style={{fontSize:10,color:subC,fontWeight:600}}>{detail.nameEn}</div>
                  <div style={{fontSize:10,color:isE?"#777":"#8b7e6b",marginTop:2}}>{detail.type} ¬∑ {detail.mw} kDa</div>
                  {isE&&<div style={{fontSize:9,color:"#c49e5e",fontWeight:700,marginTop:2}}>‚öô „Çµ„Éù„Éº„Éà„Ç´„Éº„ÉâÔºàÂç≥Áô∫Âãï‚ÜíÂ¢ìÂú∞Ôºâ</div>}
                  {isE&&SEFF[detail.id]&&<div style={{fontSize:10,color:"#8b9e6b",fontWeight:700,marginTop:2}}>{SEFF[detail.id].desc}</div>}
                </div>
              </div>
              <div style={{fontSize:11,color:isE?"#ccc":"#4a4038",lineHeight:1.6,marginBottom:10,padding:"8px 10px",background:isE?"#333":`${tc[0]}08`,borderRadius:10}}>{detail.desc}</div>
              <div style={{display:"flex",gap:6,flexWrap:"wrap",fontSize:10,color:isE?"#aaa":"#6b6358",marginBottom:8}}>
                {!isE&&<span style={{background:isE?"#333":"#e8e0d4",borderRadius:8,padding:"3px 8px"}}>‚ô° HP {detail.mw} kDa</span>}
                {detail.ad>0&&<span style={{background:isE?"#333":"#e8e0d4",borderRadius:8,padding:"3px 8px"}}>‚öî ÊîªÊíÉ {detail.ad}</span>}
                <span style={{background:isE?"#333":"#e8e0d4",borderRadius:8,padding:"3px 8px",display:"flex",alignItems:"center",gap:3}}>‚ö° {(!detail.ae||!detail.ae.length)?"‚Äî":detail.ae.map((e,i)=><React.Fragment key={i}><ESvg id={e.id} size={12}/><span>√ó{e.n}</span></React.Fragment>)}</span>
              </div>
              {detail.bw.length>0&&<div style={{fontSize:10,color:isE?"#888":"#8b7e6b",marginBottom:4}}>ÁµêÂêàÂèØËÉΩ: {detail.bw.map(bid=>{const bc=CARDS.find(x=>x.id===bid);return bc?bc.name:`#${bid}`;}).join(", ")}</div>}
              {detail.bw2?.length>0&&(()=>{
                const allCards=[...(g?[g.pAct,...g.pBench,g.eAct,...g.eBench].filter(Boolean):[])];
                const partners=detail.bw2.map(uid=>allCards.find(c=>c.uid===uid)).filter(Boolean);
                return <div style={{fontSize:10,color:"#8b9e6b",marginBottom:6,background:isE?"#333":"#e8f5e0",borderRadius:8,padding:"4px 8px"}}>
                  üîó ÁµêÂêà‰∏≠: {partners.map(p=>p.name).join(" ‚áî ")}
                </div>;
              })()}
              {detail.skill&&<div style={{fontSize:10,color:isE?"#c49e5e":tc[0],fontWeight:700,marginBottom:4}}>üîß {detail.skill}</div>}
              {detail._canSwap&&<button onClick={()=>{if(attacked){flash("ÊîªÊíÉÊ∏à„Åø„ÅÆ„Åü„ÇÅ‰∫§‰ª£„Åß„Åç„Åæ„Åõ„Çì");return;}swapActive(detail.uid);setDetail(null);}} style={{width:"100%",border:"none",borderRadius:14,padding:"10px",fontFamily:F,fontWeight:700,fontSize:13,cursor:attacked?"default":"pointer",background:attacked?"#e8e0d4":"linear-gradient(135deg,#8b9e6b,#6b8e7b)",color:attacked?"#b8a99a":"#fff",marginTop:6,opacity:attacked?0.5:1}}>üîÑ „Éê„Éà„É´Â†¥„Å´‰∫§‰ª£{!attacked?" (ÊîªÊíÉÊ®©Ê∂àË≤ª)":""}</button>}
              {detail._boundToAct&&<div style={{fontSize:11,color:"#c47e5e",fontWeight:700,marginTop:6,textAlign:"center"}}>üîó ÁµêÂêà‰∏≠„ÅÆ„Åü„ÇÅ‰∫§‰ª£‰∏çÂèØ</div>}
              {detail._canUnbind&&detail.bw2?.length>0&&<button onClick={()=>{unbindCard(detail.uid);setDetail(null);}} style={{width:"100%",border:"none",borderRadius:14,padding:"10px",fontFamily:F,fontWeight:700,fontSize:13,cursor:"pointer",background:"linear-gradient(135deg,#c49e5e,#c47e5e)",color:"#fff",marginTop:6}}>üîì ÁµêÂêàËß£Èô§ ‚Üí ÊâãÊú≠{!attacked?" (ÊîªÊíÉÊ®©Ê∂àË≤ª)":""}</button>}
              <button onClick={()=>setDetail(null)} style={{width:"100%",border:"none",borderRadius:14,padding:"10px",fontFamily:F,fontWeight:700,fontSize:13,cursor:"pointer",background:isE?"#444":"#e8e0d4",color:isE?"#e0d8cc":"#3d3229",marginTop:6}}>„Å®„Åò„Çã</button>
            </React.Fragment>);
          })()}
        </div>
      </div>}
    </div></React.Fragment>
  );
}
